

<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>

<!-- 2017-02-23 Thu 10:15 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Harry Birch (MSci proj 2016)" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://www.star.bris.ac.uk/bjm/css/bjm.css" />
<link rel="stylesheet" type="text/css" href="bjm.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">GX339-4Analysis</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Project summary</a>
<ul>
<li><a href="#sec-1-1">1.1. Day-to-day analysis log</a></li>
<li><a href="#sec-1-2">1.2. Progress</a>
<ul>
<li><a href="#sec-1-2-1">1.2.1. Current tasks to complete:</a></li>
<li><a href="#sec-1-2-2">1.2.2. 60cp Extension:</a></li>
<li><a href="#sec-1-2-3">1.2.3. References:</a></li>
</ul>
</li>
<li><a href="#sec-1-3">1.3. Latest Analysis Results</a></li>
<li><a href="#sec-1-4">1.4. About</a></li>
</ul>
</li>
<li><a href="#sec-2">2. GX339-4</a>
<ul>
<li><a href="#sec-2-1">2.1. 0605610201</a>
<ul>
<li><a href="#sec-2-1-1">2.1.1. Initial Processing</a></li>
<li><a href="#sec-2-1-2">2.1.2. Flare removal</a></li>
<li><a href="#sec-2-1-3">2.1.3. Extract Source and Background Region</a></li>
<li><a href="#sec-2-1-4">2.1.4. Make Light Curves</a></li>
<li><a href="#sec-2-1-5">2.1.5. Produce Lag-Frequency Plots</a></li>
<li><a href="#sec-2-1-6">2.1.6. Produce Lag-Energy Plots</a></li>
<li><a href="#sec-2-1-7">2.1.7. Epitropakis Methods</a></li>
<li><a href="#sec-2-1-8">2.1.8. Produce a spectrum - UNDER CONSTRUCTION</a></li>
<li><a href="#sec-2-1-9">2.1.9. Lag-Frequency Script</a></li>
<li><a href="#sec-2-1-10">2.1.10. Lag-Energy Scripts</a></li>
<li><a href="#sec-2-1-11">2.1.11. Segment Analysis Script</a></li>
<li><a href="#sec-2-1-12">2.1.12. Coherence Analysis Script</a></li>
</ul>
</li>
<li><a href="#sec-2-2">2.2. 0654130401</a>
<ul>
<li><a href="#sec-2-2-1">2.2.1. Initial Processing</a></li>
<li><a href="#sec-2-2-2">2.2.2. Flare removal</a></li>
<li><a href="#sec-2-2-3">2.2.3. Extract Source and Background Region</a></li>
<li><a href="#sec-2-2-4">2.2.4. Make Light Curves</a></li>
<li><a href="#sec-2-2-5">2.2.5. Produce Lag-Frequency Plots</a></li>
<li><a href="#sec-2-2-6">2.2.6. Produce Lag-Energy Plots</a></li>
<li><a href="#sec-2-2-7">2.2.7. Epitropakis Methods</a></li>
<li><a href="#sec-2-2-8">2.2.8. Produce a spectrum - UNDER CONSTRUCTION</a></li>
<li><a href="#sec-2-2-9">2.2.9. Lag-Frequency Script</a></li>
<li><a href="#sec-2-2-10">2.2.10. Lag-Energy Scripts</a></li>
<li><a href="#sec-2-2-11">2.2.11. Segment Analysis Script</a></li>
<li><a href="#sec-2-2-12">2.2.12. Coherence Analysis Script</a></li>
</ul>
</li>
<li><a href="#sec-2-3">2.3. 0204730201</a>
<ul>
<li><a href="#sec-2-3-1">2.3.1. Initial Processing</a></li>
<li><a href="#sec-2-3-2">2.3.2. Flare removal</a></li>
<li><a href="#sec-2-3-3">2.3.3. Extract Source and Background Region</a></li>
<li><a href="#sec-2-3-4">2.3.4. Make Light Curves</a></li>
<li><a href="#sec-2-3-5">2.3.5. Produce Lag-Frequency Plots</a></li>
<li><a href="#sec-2-3-6">2.3.6. Epitropakis Methods</a></li>
<li><a href="#sec-2-3-7">2.3.7. Lag-Frequency Script</a></li>
<li><a href="#sec-2-3-8">2.3.8. Segment Analysis Script</a></li>
<li><a href="#sec-2-3-9">2.3.9. Coherence Analysis Script</a></li>
</ul>
</li>
<li><a href="#sec-2-4">2.4. 0204730301 (U002)</a>
<ul>
<li><a href="#sec-2-4-1">2.4.1. Initial Processing</a></li>
<li><a href="#sec-2-4-2">2.4.2. Flare removal</a></li>
<li><a href="#sec-2-4-3">2.4.3. Extract Source and Background Region</a></li>
<li><a href="#sec-2-4-4">2.4.4. Make Light Curves</a></li>
<li><a href="#sec-2-4-5">2.4.5. Produce Lag-Frequency Plots</a></li>
<li><a href="#sec-2-4-6">2.4.6. Epitropakis Methods</a></li>
<li><a href="#sec-2-4-7">2.4.7. Lag-Frequency Script</a></li>
<li><a href="#sec-2-4-8">2.4.8. Segment Analysis Script</a></li>
<li><a href="#sec-2-4-9">2.4.9. Coherence Analysis Script</a></li>
</ul>
</li>
<li><a href="#sec-2-5">2.5. 0204730301 (U003)</a>
<ul>
<li><a href="#sec-2-5-1">2.5.1. Initial Processing</a></li>
<li><a href="#sec-2-5-2">2.5.2. Flare removal</a></li>
<li><a href="#sec-2-5-3">2.5.3. Extract Source and Background Region</a></li>
<li><a href="#sec-2-5-4">2.5.4. Make Light Curves</a></li>
<li><a href="#sec-2-5-5">2.5.5. Produce Lag-Frequency Plots</a></li>
<li><a href="#sec-2-5-6">2.5.6. Epitropakis Methods*</a></li>
<li><a href="#sec-2-5-7">2.5.7. Lag-Frequency Script</a></li>
<li><a href="#sec-2-5-8">2.5.8. Segment Analysis Script*</a></li>
<li><a href="#sec-2-5-9">2.5.9. Coherence Analysis Script*</a></li>
</ul>
</li>
<li><a href="#sec-2-6">2.6. 0204730201-024730301 Merger Analysis</a>
<ul>
<li><a href="#sec-2-6-1">2.6.1. Produce Lag-Frequency Plots</a></li>
<li><a href="#sec-2-6-2">2.6.2. 2-Blobs Model Fitting</a></li>
<li><a href="#sec-2-6-3">2.6.3. Lag-Comb Scripts</a></li>
<li><a href="#sec-2-6-4">2.6.4. Script to make spectra</a></li>
<li><a href="#sec-2-6-5">2.6.5. Script to setup the table</a></li>
<li><a href="#sec-2-6-6">2.6.6. Script with initial model parameters in (<code>scale_tlag.par</code>)</a></li>
<li><a href="#sec-2-6-7">2.6.7. Scale values explained (<code>scale_tlag.par</code>)</a></li>
<li><a href="#sec-2-6-8">2.6.8. Script to analyse coherence</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Project summary</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Day-to-day analysis log</h3>
<div class="outline-text-3" id="text-1-1">
<p>
This project is focusing upon applying current models for AGN to
BHXRBs. The progress being made is noted below, with the most recent
comments at the top.
</p>
<ul class="org-ul">
<li>22.02.17: HB and RW worked on completing coherence analysis with
various segment numbers and working on understanding coherence. We
also worked on setting up Github.
</li>
<li>21.02.17: Some of the files made are large so we've improved the
run script to delete them once they don't need to be used anymore.
The website now has images too! VZ improved the Excel file used to
make the .fits files, although this could be turned into a Python
script if necessary. Need to ask AY: Where to target the 60 cp
project, now we have done the Epitropakis and coherence so quickly.
What should the focus be of our writeups? Coherence fitting to an
equation? Paper or OpenCL? Should we run the table model? Lag energy?
</li>
<li>20.02.17: HB and RW worked on improving the segment analysis.
</li>
<li>18.02.17: HB completed the preliminary analysis for 060, 065 and
020&#x2026;201 observations. This included lag and coherence plots for
all with relevant `max frequency' and `max coherence' lines on
them. The coherence for all of those combinations has also been
found and shown in latest analysis results. This needs to be done
for both the 020&#x2026;301 observations (long and short) then we should
discuss the physical meaning. Model fitting has been improved and
will fit to data, provided the black hole mass is 10<sup>2.5</sup>, which
is about an order of magnitude too high
</li>
<li>17.02.17: HB discussed with AY how valid it was to combine all the
observations of GX339-4 when using the segmentation analysis. This
should be fine and could possibly be used later to determine
exactly what the source was doing in the different flux states
(this depends on the coherence of the source i.e. how consistent
the difference in phase angle was, so far it looks promising!) The
model unfortunately did not fit well. We should discuss this and
how to use the coherence analysis in further meetings. HB produced
coherence and lag freq according to AE16 for all bar the 020&#x2026;301
observation. The others all require minor refining after we have
discussed with AY. The combined observation has been included in
latest analysis.
</li>
<li>16.02.17: HB, RW and VZ met to discuss how we could improve the
coherence and time lags. The Epitropakis time lag method now shows
good comparisons to the 'normal' method (although it has a few
negative lags above 1 Hz). The coherence is currently on 1
constantly but we are running analysis for for the 065&#x2026; and
020..201. Combinations of this may give a better coherence plot.
</li>
<li>15.02.17: HB and RW met up to look at coherence. We developed the
python script and updated Steff's postproc script. This is quite a
complex/ lengthy process with many input and output files. See the
060 coherence analysis example for a description and the scripts
for further comments. We ran the 060 fine but we were unable to
plot coherence effectively, possibly need more segment numbers?
</li>
<li>14.02.17: AY, HB, RW, VZ Skype meeting with Poemwai. We discussed
generally the project and just need to fit the model really. We
will work on how to do coherence now. We found that coherence was
going to take much longer than expected. We can also use slightly
different parameters than initially expected (smaller than 20ks
bins) so we will have many more segments. HB has begun writing a
small python script that would do this.
</li>
<li>7.02.17: HB ran the analysis of the 060&#x2026; obs with a 0.01 bin size
instead of 0.06 to ensure all obs were consistent. We also need to
check why the combined obs has two timing<sub>evts</sub> files (U002 and U003)
</li>
<li>4.02.17: RW worked on going through the website and picking up
inconsistencies which will need to be ironed out.
</li>
<li>3.02.17: AY, PC, OD, HB meeting. AY will look at the code, but in
principle the binary should work. PC thinks it should work, if the
shifting in frequency and scaling is correct. Might need a
truncated radius. Possibly the freq grid needs changing. We may
also have problems interpreting, as the thermal lag might be
different (also don't have a truncated radius, assumes maximally
spinning). Possibly look at coding up a truncation radius, PC. We
should double check by comparing to an AGN. SO and HB worked on
improving the fitting script, line drawing and speeding up making
the .fits files. AY will get the 2 blobs model working so we can do
fitting GX339-4 lag fitting. HB, RW, and VZ need to look at
coherence in the meantime. HB is trying to get the website online
so it is less laggy and can be used to display results more easily.
VZ has begun her writeup as the main result will likely be the
lag-freq plots. If they fit well this may be published.
Lag-energies are less likely to fit well but could still be done as
it would be interesting to see why. AY suggested a RAS conference
we could go to on 10.02.16 on general X-Ray astronomy.
</li>
<li>2.02.17: AY agrees it could be a problem with the model that can't
fit properly. We will meet 3.02.17 to discuss with Poemwai at 9am
and 1pm with AY further. Spherical corona looks like it might take
a while to do so we should focus on the two blobs model, and try to
interpret the results.
</li>
<li>1.02.17: VZ has also come across the same chi-squared fitting
problem as HB. SO is going to look at it. HB has emailed AY to see
if this is expected. Currently waiting to hear about new model.
</li>
<li>31.01.17:  HB has apparently fixed the problem by running a
later version of python (thanks to R. Morris). There is now a problem in the
setup<sub>table</sub>.sl script (missing scale<sub>tlag</sub>.sl) which HB has emailed
Steff about. With Steff's assistance, HB has run the table model
however the plots are far away from what is expected. Possibly the
model just won't work with the binary data.
</li>
<li>30.01.17: VZ ran the merger analysis and produced similar
lag-freqency plots to HB. VZ has also been held up however by the
astropy problem.
</li>
<li>27.01.17: HB, RW, VZ meeting. VZ repeated analysis to try and
create the lag-eng plots. RW spotted a bug in his lag-eng code,
some errors on the website and has also set his isis lag-eng code
to run again. HB has laid foundations for the table model analysis,
and (with RW) generated the relevant analysis scripts for the 2004
data observations, however HB is having problems installing
'astropy' - a python package.
</li>
<li>26.01.17: Continued analysis into how to merge the observations.
Steff has suggested we try a script he wrote to combine the
datasets. This appears to have worked well and is recorded in the
notes. An overlay of all lag-freq plots has been produced (very
roughly) and appears to match with the theory well!. The normal lag-freq analysis for &#x2026;201 ran successfully but I've not
looked at the data output in detail, but it may be interesting to
compare the benefits of combining consecutive orbits.
</li>
<li>25.01.17: Continued analysis into how to merge the observations. A new
merge attempt was tried but resulted in an error message. (Happy
Birthday, Ralph!)
</li>
<li>24.01.17: Harry looked into how to merge files, see <a href="http://www.mpe.mpg.de/xray/wave/xmm/cookbook/preparation/merged_events.php">here</a> for
instructions. isis was found to hang.
</li>
<li>23.01.16: Meeting with Andy, Ralph and Harry. Discussed 60cp
extension. Agreed in general we need to be working on lag-frequency
of GX339-4. Then we'll fit Poemwai's spherical model. Once we've
done this we can begin writing up and focus on 'extensions'.
</li>
<li>15.12.16: Christmas plan. We need to consider where to go
(Epitropakis, Spherical, 2 blobs, RXTE). Andy will talk to Poemwai
about which is best.
</li>
<li>8.12.16: Updated the website to now include all analysis in one
place. Lag-energy image uploaded. Emailed for website access as the
current means to view the html is laggy.
</li>
<li>06.12.16: Weekly group meeting. During an especially delicious
meeting we discussed issues with timebinsize and altered the
lag-energy scripts to reflect the difference with binaries. We aim
to complete the low luminosity observation analysis from DM15b by
the end of this term. Our long term goal will be to fit the spherical
corona model to this (Ref needed).
In the afternoon we managed to recreate the lag-frequency plot for
the high luminosity observation in DM15a. The lag-energy scripts
are currently running (taking approx. 6 hrs)
</li>
<li>02.12.16: Met up to look at the code again. Using a
timebinsize=0.001 as described in DM15b caused an error (**
epiclccorr: error (BinSizeTooSmall), Light curve bin size smaller
than frame time). We will now be using a timebinsize=0.01 as the
 later paper refers to this instead.
</li>
<li>29.11.16: Code brought into Emacs and .html made. Issues with
producing the lag-frequency plots for GX339-4 obsid:0605610201 have
slowed progress. We are currently unsure how to produce the plots
above 1 Hz. The analysis follows currently that from 2 papers, both
published De Marco in 2015 (DM15a and DM15b).
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Progress</h3>
<div class="outline-text-3" id="text-1-2">
</div><div id="outline-container-sec-1-2-1" class="outline-4">
<h4 id="sec-1-2-1"><span class="section-number-4">1.2.1</span> Current tasks to complete:</h4>
<div class="outline-text-4" id="text-1-2-1">
<ul class="org-ul">
<li>(complete) Repeat all isis lag-freq scripts with identical plotting parameters
and see if an 'overlay' is possible
</li>
<li>(in progress) Test spherical corona fit to an AGN to check we're doing the fitting
mechanics properly (awaiting model from Poemwai)
</li>
<li>(complete) Check if RA has been accepted.
</li>
<li>(in progress) Attempt to fit the model the draft 2 blobs model
</li>
<li>Produce Lag-energy for the last 2 2009 observations.
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-1-2-2" class="outline-4">
<h4 id="sec-1-2-2"><span class="section-number-4">1.2.2</span> 60cp Extension:</h4>
<div class="outline-text-4" id="text-1-2-2">
<ul class="org-ul">
<li>Coherence and Epitropakis methods.
</li>
<li>Coherence overlay plots.
</li>
<li>Coherence for the 020&#x2026;301 observation.
</li>
<li>List below describes what we need to be working on.
Looking at OpenCL additon to Poemwai's code.
decompising into a basis also to define polarisation.
</li>
<li>Update 2 blobs model to add Xlliver model and truncation radius.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-2-3" class="outline-4">
<h4 id="sec-1-2-3"><span class="section-number-4">1.2.3</span> References:</h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
DM15a - B. De Marco, G. Ponti, T. Muñoz-Darias, and K. Nandra, “The evolution of the disc variability along the hard state of the black hole transient GX 339-4,” Mon. Not. R. Astron. Soc., vol. 454, no. 3, pp. 2360–2371, 2015.
</p>

<p>
DM15b - B. De Marco, G. Ponti, T. Muñoz-Darias, and K. Nandra,
“Tracing the Reverberation Lag in the Hard State of Black Hole X-Ray
Binaries,” Astrophys. J., vol. 814, no. 1, p. 50, 2015.
</p>

<p>
AE16 - A. Epitropakis and I. E. Papadakis, “Statistical properties of Fourier-based time-lag estimates,” Astron. Astrophys., vol. 591, p. A113, 2016.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Latest Analysis Results</h3>
<div class="outline-text-3" id="text-1-3">
<p>
We have currently been working on the Epitropakis methods. See the
'Epitropakis Methods' sections in the individual observation sections
for the lag and coherence plots. The observation segments have been
combined in various ways, and these are shown below. The scripts to do
this can be found in <code>/data/cluster/XRayReverb2016/HarryData/GX339-4</code>,
however, look very similar to the ones shown in the separate
observation files.
</p>


<div class="figure">
<p><img src="./CombinedAllLagFrequency.gif" alt="CombinedAllLagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 1:</span> Latest Analysis: All observations combined Lag-Frequency plot using E16 analysis.</p>
</div>


<div class="figure">
<p><img src="./CombinedAllCoherenceFrequency.gif" alt="CombinedAllCoherenceFrequency.gif" />
</p>
<p><span class="figure-number">Figure 2:</span> Latest Analysis: All observations combined  Coherence-Frequency plot.</p>
</div>


<div class="figure">
<p><img src="./Combined060065022LagFrequency.gif" alt="Combined060065022LagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 3:</span> Latest Analysis: Combined 060, 065 and 020&#x2026;201 Lag-Frequency plot.</p>
</div>


<div class="figure">
<p><img src="./Combined060065022CoherenceFrequency.gif" alt="Combined060065022CoherenceFrequency.gif" />
</p>
<p><span class="figure-number">Figure 4:</span> Latest Analysis: Combined 060, 065 and 020&#x2026;201 Coherence-Frequency plot.</p>
</div>


<div class="figure">
<p><img src="./Combined060022LagFrequency.gif" alt="Combined060022LagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 5:</span> Latest Analysis: Combined 060, 020&#x2026;201  Lag-Frequency plot.</p>
</div>


<div class="figure">
<p><img src="./Combined060022CoherenceFrequency.gif" alt="Combined060022CoherenceFrequency.gif" />
</p>
<p><span class="figure-number">Figure 6:</span> Latest Analysis: Combined 060 and 020&#x2026;201 Coherence-Frequency plot.</p>
</div>


<div class="figure">
<p><img src="./Combined065022LagFrequency.gif" alt="Combined065022LagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 7:</span> Latest Analysis: Combined 065, 020&#x2026;201  Lag-Frequency plot.</p>
</div>


<div class="figure">
<p><img src="./Combined065022CoherenceFrequency.gif" alt="Combined065022CoherenceFrequency.gif" />
</p>
<p><span class="figure-number">Figure 8:</span> Latest Analysis: Combined 065 and 020&#x2026;201 Coherence-Frequency plot.</p>
</div>


<div class="figure">
<p><img src="./Combined06LagFrequency.gif" alt="Combined06LagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 9:</span> Latest Analysis: Combined 060, 065  Lag-Frequency plot.</p>
</div>


<div class="figure">
<p><img src="./Combined06CoherenceFrequency.gif" alt="Combined06CoherenceFrequency.gif" />
</p>
<p><span class="figure-number">Figure 10:</span> Latest Analysis: Combined 060 and 065 Coherence-Frequency plot.</p>
</div>


<p>
Archive:
</p>


<div class="figure">
<p><img src="./LagFreq_Overlay.png" alt="LagFreq_Overlay.png" />
</p>
<p><span class="figure-number">Figure 11:</span> Latest Analysis: An overlay plot with our lag-frequency analysis of GX339-4 and that from DM15b.</p>
</div>



<div class="figure">
<p><img src="./0654130401/PROC/lagfreq.gif" alt="lagfreq.gif" />
</p>
<p><span class="figure-number">Figure 12:</span> Latest Analysis: The lag-frequency plot using timebinsize=0.01 s for the highest luminosity observation in DM15a. We believe this is a clear copy of the De Marco Analysis.</p>
</div>


<div class="figure">
<p><img src="./0204730201-0204730301-Merger/PROC/lagfreq_comb.gif" alt="lagfreq_comb.gif" />
</p>
<p><span class="figure-number">Figure 13:</span> Latest Analysis: The lag-frequency plot using timebinsize=0.01 s for the intermediate luminosity observation in DM15a. We believe this is a clear copy of the De Marco Analysis.</p>
</div>


<div class="figure">
<p><img src="./0605610201/PROC/lagfreq.gif" alt="lagfreq.gif" />
</p>
<p><span class="figure-number">Figure 14:</span> Latest Analysis: The lag-frequency plot using timebinsize=0.01 s for the lowest luminosity observation in DM15a. We believe this is a clear copy of the De Marco Analysis.</p>
</div>


<div class="figure">
<p><img src="./0605610201/PROC/lagen_0.8-2Hz.gif" alt="lagen_0.8-2Hz.gif" />
</p>
<p><span class="figure-number">Figure 15:</span> Latest Analysis: 0605610201 lag-energy plot.</p>
</div>


<div class="figure">
<p><img src="./0654130401/PROC/lagen_0.8-2Hz.gif" alt="lagen_0.8-2Hz.gif" />
</p>
<p><span class="figure-number">Figure 16:</span> Latest Analysis: 0654130401 lag-energy plot.</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> About</h3>
<div class="outline-text-3" id="text-1-4">
<p>
This website records the analysis if GX339-4 as part of a 2016/17
masters project. Should you find any errors, please contact the website administrator
at <code>hb13486@bris.ac.uk</code>. Sections marked with a * are extension
projects worked on as part of a 60cp project.
</p>

<p>
The Collaboration:
</p>

<ul class="org-ul">
<li>2016 MSci Students: Harry Birch, Ralph Wellington and Viktoria Zekoll
</li>
<li>Supervisor: Dr. Andy Young
</li>
<li>Collaborators: Steff O'Donnell and Dr. Poemwai Chainakun
</li>
</ul>

<p>
Find us on GitHub at: <a href="https://github.com/hpbirch">https://github.com/hpbirch</a> and <a href="https://github.com/RCWellington">https://github.com/RCWellington</a>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> GX339-4</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> 0605610201</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-sec-2-1-1" class="outline-4">
<h4 id="sec-2-1-1"><span class="section-number-4">2.1.1</span> Initial Processing</h4>
<div class="outline-text-4" id="text-2-1-1">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n Initial SAS setup, general for all files. Run in a suitable folder after replacing the OBSID'</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nDOWNLOAD TAR FILE...'</span>
curl -o OBSID.tar <span style="color: #8b2252;">"http://nxsa.esac.esa.int/nxsa-sl/servlet/data-action-aio?obsno=OBSID&amp;level=ODF"</span>
tar -zxvf *.tar
tar -xvf *.TAR

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n file unpacked. Setup SAS'</span>

heainit
setsas
<span style="color: #483d8b;">setenv</span> SAS_CCFPATH /usr/local/XMM/ccf/
<span style="color: #483d8b;">setenv</span> SAS_ODF $<span style="color: #a0522d;">PWD</span>
cifbuild
<span style="color: #483d8b;">setenv</span> SAS_CCF ccf.cif
odfingest
<span style="color: #483d8b;">setenv</span> SAS_ODF $<span style="color: #a0522d;">PWD</span>/*SUM.SAS
cp ccf.cif ../PROC
cp *SUM.SAS ../PROC
<span style="color: #483d8b;">cd</span> ../PROC

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n MOVED TO PROC FOLDER. INITIALISING WORK'</span>

epproc <span style="color: #a0522d;">randomizetime</span>=no <span style="color: #a0522d;">randomizeposition</span>=no <span style="color: #a0522d;">randomizeenergy</span>=no

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nScript to process ODF data\n\n\n'</span>
cp *TimingEvts.ds PN.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Create a light curve.'</span>
evselect <span style="color: #a0522d;">table</span>=PN.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_flares_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timebinsize</span>=10 <span style="color: #a0522d;">makeratecolumn</span>=yes <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'#XMMEA_EP &amp;&amp; (PI&gt;10000&amp;&amp;PI&lt;12000) &amp;&amp; (PATTERN==0)'</span>
dsplot <span style="color: #a0522d;">table</span>=PN_flares_lc.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;
</pre>
</div>

<p>
At this point flares must be removed if they exist.
In this instance there were no flares so they were not removed.
</p>
</div>
</div>
<div id="outline-container-sec-2-1-2" class="outline-4">
<h4 id="sec-2-1-2"><span class="section-number-4">2.1.2</span> Flare removal</h4>
<div class="outline-text-4" id="text-2-1-2">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n no flares removed'</span>
cp PN.fits EPICclean.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n MAKE IMAGE...'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withimageset</span>=yes <span style="color: #a0522d;">imageset</span>=EPICclean_image.fits <span style="color: #a0522d;">xcolumn</span>=RAWX <span style="color: #a0522d;">ycolumn</span>=RAWY <span style="color: #a0522d;">imagebinning</span>=binSize <span style="color: #a0522d;">ximagebinsize</span>=1 <span style="color: #a0522d;">yimagebinsize</span>=1
ds9 EPICclean_image.fits &amp;
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\nImage created. Please note down a source and background range of pixels.'</span>
</pre>
</div>


<div id="image" class="figure">
<p><img src="./0605610201/PROC/2DImage.gif" alt="2DImage.gif" />
</p>
<p><span class="figure-number">Figure 17:</span> 2D Image of the source in timing mode. The central region was extracted using the 'projection' tool in ds9 (hence the green line).</p>
</div>

<p>
At this point the source and background 'RAWX' values were found using
Fig. <a href="#image">17</a>
replaced in the following text.
</p>
</div>
</div>

<div id="outline-container-sec-2-1-3" class="outline-4">
<h4 id="sec-2-1-3"><span class="section-number-4">2.1.3</span> Extract Source and Background Region</h4>
<div class="outline-text-4" id="text-2-1-3">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nSoft Filter\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0)&aamp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in [500:1500])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nHard Filter\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in [2000:9000])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n Extract src and bg\n\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Source from Soft Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft_src.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [31:45]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Source from Hard Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard_src.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [31:45]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Background from Soft Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft_bkg.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [3:5]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Background from Hard Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard_bkg.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [3:5]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-1-4" class="outline-4">
<h4 id="sec-2-1-4"><span class="section-number-4">2.1.4</span> Make Light Curves</h4>
<div class="outline-text-4" id="text-2-1-4">
<p>
Note the time bin size here.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate Lightcurve from source\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from soft photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft_src.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_soft_src_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from hard photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard_src.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_hard_src_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from Background\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from soft photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft_bkg.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_soft_bkg_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from hard photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard_bkg.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_hard_bkg_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate Background Subtracted Light Curve\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nFrom soft photons (10 mins)\n'</span>
epiclccorr <span style="color: #a0522d;">srctslist</span>=PN_time_soft_src_lc.fits <span style="color: #a0522d;">eventlist</span>=EPICclean.fits <span style="color: #a0522d;">outset</span>=PN_time_soft_lccorr.fits <span style="color: #a0522d;">bkgtslist</span>=PN_time_soft_bkg_lc.fits <span style="color: #a0522d;">withbkgset</span>=yes <span style="color: #a0522d;">applyabsolutecorrections</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nFrom hard photons (10 mins)\n'</span>
epiclccorr <span style="color: #a0522d;">srctslist</span>=PN_time_hard_src_lc.fits <span style="color: #a0522d;">eventlist</span>=EPICclean.fits <span style="color: #a0522d;">outset</span>=PN_time_hard_lccorr.fits <span style="color: #a0522d;">bkgtslist</span>=PN_time_hard_bkg_lc.fits <span style="color: #a0522d;">withbkgset</span>=yes <span style="color: #a0522d;">applyabsolutecorrections</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Display the lightcurve'</span>

dsplot <span style="color: #a0522d;">table</span>=PN_time_soft_lccorr.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;
dsplot <span style="color: #a0522d;">table</span>=PN_time_hard_lccorr.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Note that the above lightcurves can be chopped with the evselect timemin and timemax command'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-1-5" class="outline-4">
<h4 id="sec-2-1-5"><span class="section-number-4">2.1.5</span> Produce Lag-Frequency Plots</h4>
<div class="outline-text-4" id="text-2-1-5">
<p>
Begin by downloading a template
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"\n\n\nProduce lagfreq script\n\n\n"</span>
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/isis_lagfreq_script.sl .
emacs isis_lagfreq_script.sl &amp;
</pre>
</div>

<p>
Edit this file accordingly (update OBSID and frequency ranges if
necessary). Then run the file analysis in isis. The one used in this
case is shown in the following in a separate section <a href="#sec-2-1-9">here</a>.
</p>

<div class="org-src-container">

<pre class="src src-sh">isis isis_lagfreq_script.sl
</pre>
</div>

<p>
The output from this is shown in Figure <a href="#LagFreq">18</a>.
</p>


<div id="LagFreq" class="figure">
<p><img src="./0605610201/PROC/lagfreq.gif" alt="lagfreq.gif" />
</p>
<p><span class="figure-number">Figure 18:</span> The lag-frequency graph for 2009 GX339-4 observation</p>
</div>
</div>
</div>

<div id="outline-container-sec-2-1-6" class="outline-4">
<h4 id="sec-2-1-6"><span class="section-number-4">2.1.6</span> Produce Lag-Energy Plots</h4>
<div class="outline-text-4" id="text-2-1-6">
<p>
Once the lag-freq plots have been generated, the lag-energy plots can
also be made. This is done by initially copying an template and
editing suitably.
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nRun LagEng Processing Scripts\n\n\n'</span>
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/sas_lagen_script1.py .
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/isis_lagen_lf_script.sl .
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/isis_lagen_hf_script.sl .
<span style="color: #a020f0;">exit</span>
</pre>
</div>

<p>
Once done, the python script will run. This can take many hours so to
avoid it being interrupted the 'screen' tool has been used. Once a new
'screen' has been entered, the python script can be run (Note: the
environments variables may need to be reset.  Once the script is
running, pressing <code>Ctrl + A   d</code> will
detach the screen. To bring it back up, enter <code>screen
-r</code> to the command line. The output will be in the usual place.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n Run the Lag_energy scripts.\nThis step will take a long time.\nYou can close the ssh.\n\n\n'</span>
screen
python sas_lagen_script1.py
</pre>
</div>
<p>
Once complete the below can be run to generate the lag-energy plots
for high and low frequencies.
</p>
<div class="org-src-container">

<pre class="src src-sh">isis
() = evalfile(<span style="color: #8b2252;">"isis_lagen_lf_script.sl"</span>);
() = evalfile(<span style="color: #8b2252;">"isis_lagen_hf_script.sl"</span>);

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Script is complete'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-1-7" class="outline-4">
<h4 id="sec-2-1-7"><span class="section-number-4">2.1.7</span> Epitropakis Methods</h4>
<div class="outline-text-4" id="text-2-1-7">
<p>
Following the analysis outlined by Epitropakis in Epitropakis 2016
(Theoretical modelling of the AGN iron-line/continuum time-lags in the
lamp-post geometry), we have calculated the lag frequencies in a new
way and also calculated the coherence. This is outlined below.
</p>

<p>
Coherence/ lagfreq analysis was first tested on this observation. Initially it required splitting up the original observation into segments.
This would be time consuming to do manually so a python script which should do
this was developed in the section <a href="#sec-2-1-11">2.1.11</a>.
</p>

<p>
The python file should be run in the folder which contains the
observation ID folder. The scipt should be run with the observationID,
start time, end time and number of segments as arguments i.e.
</p>

<div class="org-src-container">

<pre class="src src-python">python run_segment_analysis.py 0605610201 354441000 354473000 2
</pre>
</div>

<p>
This generates segment directories (i.e. seg0,seg1) in the same folder
as the ODF and PROC folders are. In the segment directories a bash
script is created. The bash script performs all the filtering and
generates the light curves so will take a long time to run so should
be 'screened'.
</p>

<p>
The python script also outputs a modified lagfreq and coherence script shown here:
<a href="#sec-2-1-12">2.1.12</a>. This is placed with the PROC, segX and ODF
folders. This should be run to produce the lag frequency and coherence
files (as seen below) using the command:
</p>

<div class="org-src-container">

<pre class="src src-example">isis lagfreq_cohfreq_script.sl
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-2-1-7-1" name="sec-2-1-7-1"></a>Epitropakis Results<br  /><div class="outline-text-5" id="text-2-1-7-1">

<div class="figure">
<p><img src="./0605610201/EpitropakisLagFrequency.gif" alt="EpitropakisLagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 19:</span> 0605610201 binned lag-frequency plot.</p>
</div>


<div class="figure">
<p><img src="./0605610201/CoherenceFrequency.gif" alt="CoherenceFrequency.gif" />
</p>
<p><span class="figure-number">Figure 20:</span> 0605610201 coherence against frequency plot.</p>
</div>


<div class="figure">
<p><img src="./0605610201/EpitropakisUnbinnedLagFrequency.gif" alt="EpitropakisUnbinnedLagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 21:</span> 0605610201 unbinned lag-frequency plot.</p>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-2-1-8" class="outline-4">
<h4 id="sec-2-1-8"><span class="section-number-4">2.1.8</span> Produce a spectrum - UNDER CONSTRUCTION</h4>
<div class="outline-text-4" id="text-2-1-8">
</div><ol class="org-ol"><li><a id="sec-2-1-8-0-0-1" name="sec-2-1-8-0-0-1"></a>Initial Processing<br  /><div class="outline-text-7" id="text-2-1-8-0-0-1">
<p>
Begin by refiltering the curve.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n FILTER CURVE...\n\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0) &amp;&amp; (PATTERN &lt;= 4)&amp;&amp;(PI in [200:15000])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">filteredset</span>=pn_filt.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes
</pre>
</div>

<p>
At this point the image and light curves can be looked at using. If
the previous sections have not been analysed already, this will need
to be done to determine the source and background regions.
</p>

<div class="org-src-container">

<pre class="src src-sh">evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">withimageset</span>=yes <span style="color: #a0522d;">imageset</span>=image.fits <span style="color: #a0522d;">xcolumn</span>=RAWX <span style="color: #a0522d;">ycolumn</span>=RAWY <span style="color: #a0522d;">imagebinning</span>=binSize <span style="color: #a0522d;">ximagebinsize</span>=1 <span style="color: #a0522d;">yimagebinsize</span>=0.001
ds9 image.fits &amp;

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n CREATE AND DISPLAY LIGHT CURVE...\n\n'</span>
evselect <span style="color: #a0522d;">table</span>=pn.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=pn_ltcrv.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.001 <span style="color: #a0522d;">makeratecolumn</span>=yes
fv pn_ltcrv.fits &amp;
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nEXTRACT SOURCE AND BACKGROUND'</span>
evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">withimageset</span>=yes <span style="color: #a0522d;">imageset</span>=image.fits <span style="color: #a0522d;">xcolumn</span>=RAWX <span style="color: #a0522d;">ycolumn</span>=RAWY <span style="color: #a0522d;">imagebinning</span>=binSize <span style="color: #a0522d;">ximagebinsize</span>=1 <span style="color: #a0522d;">yimagebinsize</span>=1 <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0) &amp;&amp; (PI in [500:15000])'</span>

evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_WithBore.fits <span style="color: #a0522d;">energycolumn</span>=PI <span style="color: #a0522d;">spectralbinsize</span>=5 <span style="color: #a0522d;">specchannelmin</span>=0 <span style="color: #a0522d;">specchannelmax</span>=20479 <span style="color: #a0522d;">filteredset</span>=pn_filt_source_WithBore.fits <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0) &amp;&amp; (PI in [500:15000]) &amp;&amp; (RAWX in [27:47])'</span>

evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">withspectrumset</span>=yes <span style="color: #a0522d;">spectrumset</span>=bkg_pi.fits <span style="color: #a0522d;">energycolumn</span>=PI <span style="color: #a0522d;">spectralbinsize</span>=5 <span style="color: #a0522d;">withspecranges</span>=yes <span style="color: #a0522d;">specchannelmin</span>=0 <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0) &amp;&amp; (PI in [500:15000]) &amp;&amp; (RAWX in [3:5])'</span> <span style="color: #a0522d;">specchannelmax</span>=20479 <span style="color: #a0522d;">withfilteredset</span>=y <span style="color: #a0522d;">filteredset</span>=pn_filt_bkg.fits

epatplot <span style="color: #a0522d;">set</span>=pn_filt_source_WithBore.fits <span style="color: #a0522d;">plotfile</span>=pn_epat.ps <span style="color: #a0522d;">useplotfile</span>=yes <span style="color: #a0522d;">withbackgroundset</span>=yes <span style="color: #a0522d;">backgroundset</span>=pn_filt_bkg.fits
gv pn_epat.ps &amp;
</pre>
</div>

<p>
At this point, pile up must be checked. The last command in the
previous section is used to do this. In the case the doubles are &gt;1
and singles &lt;1 then the detector has pileup. This can be corrected for
using the following method where a region of the source is removed.
</p>
</div>
</li>


<li><a id="sec-2-1-8-0-0-2" name="sec-2-1-8-0-0-2"></a>Case 1 - spectrum is piled up<br  /><div class="outline-text-7" id="text-2-1-8-0-0-2">
<p>
The code below extracts a region of the source. It then checks for
pileup this process must be repeated until pileup is removed.
</p>

<div class="org-src-container">

<pre class="src src-sh">evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">withspectrumset</span>=yes <span style="color: #a0522d;">spectrumset</span>=source_pi_NoBore.fits <span style="color: #a0522d;">energycolumn</span>=PI <span style="color: #a0522d;">spectralbinsize</span>=5 <span style="color: #a0522d;">withspecranges</span>=yes <span style="color: #a0522d;">specchannelmin</span>=0 <span style="color: #a0522d;">specchannelmax</span>=20479 <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG ==0)&amp;&amp;(PI in [500:15000])&amp;&amp;(RAWX in [27:47])&amp;&amp;!(RAWX in [30:44])'</span> <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=pn_filt_source_NoBore.fits
epatplot <span style="color: #a0522d;">set</span>=pn_filt_source_NoBore.fits <span style="color: #a0522d;">plotfile</span>=pn_epat.ps <span style="color: #a0522d;">useplotfile</span>=yes <span style="color: #a0522d;">withbackgroundset</span>=yes <span style="color: #a0522d;">backgroundset</span>=pn_filt_bkg.fits
gv pn_epat.ps &amp;
<span style="color: #483d8b;">echo</span>(<span style="color: #8b2252;">'\nCheck for pileup\n\n'</span>)
</pre>
</div>

<p>
Once this correction has been made, then the arf and rmf files may be
made, as shown below.
</p>

<div class="org-src-container">

<pre class="src src-sh">evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">withspectrumset</span>=yes <span style="color: #a0522d;">spectrumset</span>=source_pi_Excised.fits <span style="color: #a0522d;">energycolumn</span>=PI <span style="color: #a0522d;">spectralbinsize</span>=5 <span style="color: #a0522d;">withspecranges</span>=yes <span style="color: #a0522d;">specchannelmin</span>=0 <span style="color: #a0522d;">specchannelmax</span>=20479 <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG ==0)&amp;&amp;(PI in [500:15000])&amp;&amp;(RAWX in [27:47])&amp;&amp;!(RAWX in [29:45])'</span> <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=pn_filt_source_Excised.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nDETERMINE SPECTRAL EXTRACTION AREA'</span>
backscale <span style="color: #a0522d;">spectrumset</span>=source_pi_NoBore.fits <span style="color: #a0522d;">badpixlocation</span>=pn_filt.fits
backscale <span style="color: #a0522d;">spectrumset</span>=bkg_pi.fits <span style="color: #a0522d;">badpixlocation</span>=pn_filt.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nMAKE RMF AND ARF FILES. (Takes a long time!)'</span>
rmfgen <span style="color: #a0522d;">rmfset</span>=source_rmf_NoBore.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_NoBore.fits

arfgen <span style="color: #a0522d;">arfset</span>=source_arf_WithBore.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_WithBore.fits <span style="color: #a0522d;">detmaptype</span>=psf
arfgen <span style="color: #a0522d;">arfset</span>=source_arf_Excised.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_Excised.fits <span style="color: #a0522d;">detmaptype</span>=psf

addarf <span style="color: #8b2252;">"source_arf_WithBore.fits source_arf_Excised.fits"</span> <span style="color: #8b2252;">"1.0 -1.0"</span> source_arf_NoBore.fits
<span style="color: #483d8b;">echo</span>(<span style="color: #8b2252;">"\n\ndone\n\n"</span>)
</pre>
</div>
</div>
</li>



<li><a id="sec-2-1-8-0-0-3" name="sec-2-1-8-0-0-3"></a>Case 2 - spectrum is not piled up<br  /><div class="outline-text-7" id="text-2-1-8-0-0-3">
<p>
In this instance, simply run the following to generate the rmf and arf files
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nDETERMINE SPECTRAL EXTRACTION AREA'</span>
backscale <span style="color: #a0522d;">spectrumset</span>=source_pi_NoBore.fits <span style="color: #a0522d;">badpixlocation</span>=pn_filt.fits
backscale <span style="color: #a0522d;">spectrumset</span>=bkg_pi.fits <span style="color: #a0522d;">badpixlocation</span>=pn_filt.fits
<span style="color: #483d8b;">echo</span>(<span style="color: #8b2252;">"\n\nproduce RMF and ARF files\n\n"</span>)
rmfgen <span style="color: #a0522d;">rmfset</span>=source_pi_WithBore_rmf.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_WithBore.fits
arfgen <span style="color: #a0522d;">arfset</span>=source_pi_WithBore_arf.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_WithBore.fits <span style="color: #a0522d;">withrmfset</span>=yes <span style="color: #a0522d;">rmfset</span>=source_pi_WithBore_rmf.fits <span style="color: #a0522d;">withbadpixcorr</span>=yes <span style="color: #a0522d;">badpixlocation</span>=pn_filt.fits
</pre>
</div>
</div>
</li>

<li><a id="sec-2-1-8-0-0-4" name="sec-2-1-8-0-0-4"></a>Make Group Spectral Files<br  /><div class="outline-text-7" id="text-2-1-8-0-0-4">
<p>
If there was pileup the following is run. Note this should be entered
line by line not in one go to avoid clashes.
</p>

<div class="org-src-container">

<pre class="src src-sh">grppha
source_pi_NoBore.fits      ! input spectrum file name
spectrum_pi_grp.fits  ! output grouped spectrum
bkg_pi.fits           ! include the background spectrum
source_rmf_NoBore.fits         ! include the RMF
source_arf_NoBore6.fits          ! include the ARF
group min 25                         ! group the data by 25 counts/bin
<span style="color: #a020f0;">exit</span>
</pre>
</div>

<p>
If there was no pileup the following is used.
</p>
<div class="org-src-container">

<pre class="src src-sh">grppha
source_pi_WithBore.fits      ! input spectrum file name
spectrum_pi_grp.fits  ! output grouped spectrum
bkg_pi.fits           ! include the background spectrum
source_rmf_WithBore.fits         ! include the RMF
source_arf_WithBore.fits          ! include the ARF
group min 25                         ! group the data by 25 counts/bin
<span style="color: #a020f0;">exit</span>
</pre>
</div>
</div>
</li>

<li><a id="sec-2-1-8-0-0-5" name="sec-2-1-8-0-0-5"></a>Plot the spectrum<br  /><div class="outline-text-7" id="text-2-1-8-0-0-5">
<p>
Plot as below. The spectrum is compared to a simple powerlaw model.
</p>

<p>
With pileup:
</p>
<div class="org-src-container">

<pre class="src src-sh">isis
<span style="color: #a0522d;">d</span>=load_data(<span style="color: #8b2252;">"spectrum_pi_grp.fits"</span>);
<span style="color: #a0522d;">r</span>=load_rmf(<span style="color: #8b2252;">"source_rmf_NoBore.fits"</span>);
<span style="color: #a0522d;">a</span>=load_arf(<span style="color: #8b2252;">"source_arf_NoBore.fits"</span>);
assign_rsp(a,r,d);
define_back(d, <span style="color: #8b2252;">"bkg_pi.fits"</span>);
fit_fun(<span style="color: #8b2252;">"powerlaw"</span>);
rebin_data(1, 10);
xnotice_en(d, 1, 10.0);
set_par(2, 2.0);
fancy_plot_unit(&#8220;keV&#8221;);
()=fit_counts;
popt.xrange = [1, 10.0];
popt.yrange = [1.0e-6, 1.0, -10.0, 10.0];
popt.dsym = 1;
popt.res = 1;
xlog;
ylog;
title (<span style="color: #8b2252;">"GX339-4 OBSID Spectrum"</span>);
plot_data(d, popt; <span style="color: #a0522d;">dsym</span>=1);
</pre>
</div>

<p>
or in the case of no pileup
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n PLOT SPECTRUM \n\n\n'</span>
isis
<span style="color: #a0522d;">d</span>=load_data(<span style="color: #8b2252;">"spectrum_pi_grp.fits"</span>);
<span style="color: #a0522d;">r</span>=load_rmf(<span style="color: #8b2252;">"source_rmf_WithBore.fits"</span>);
<span style="color: #a0522d;">a</span>=load_arf(<span style="color: #8b2252;">"source_arf_WithBore.fits"</span>);
assign_rsp(a,r,d);
define_back(d, <span style="color: #8b2252;">"bkg_pi.fits"</span>);
fit_fun(<span style="color: #8b2252;">"powerlaw"</span>);
rebin_data(1, 10);
xnotice_en(d, 1, 10.0);
set_par(2, 2.0);
fancy_plot_unit(&#8220;keV&#8221;);
()=fit_counts;
popt.xrange = [1, 10.0];
popt.yrange = [1.0e-6, 1.0, -10.0, 10.0];
popt.dsym = 1;
popt.res = 1;
xlog;
ylog;
title (<span style="color: #8b2252;">"GX339-4 OBSID Spectrum"</span>);
plot_data(d, popt; <span style="color: #a0522d;">dsym</span>=1);
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-2-1-9" class="outline-4">
<h4 id="sec-2-1-9"><span class="section-number-4">2.1.9</span> Lag-Frequency Script</h4>
<div class="outline-text-4" id="text-2-1-9">
<div class="org-src-container">

<pre class="src src-sh">%declare observation ID<span style="color: #8b2252;">'s</span>
<span style="color: #8b2252;">variable obs_id = ["0605610201"];</span>


<span style="color: #8b2252;">variable i;</span>
<span style="color: #8b2252;">variable j;</span>
<span style="color: #8b2252;">variable k;</span>

<span style="color: #8b2252;">%declare frequency bins</span>
<span style="color: #8b2252;">variable n_bins =21;</span>
<span style="color: #8b2252;">variable df_f = 0.5/1.1; %Possibly change bin size to be bigger to exactly emulate DeMarco2015 results.</span>
<span style="color: #8b2252;">variable lo = Double_Type[n_bins];</span>
<span style="color: #8b2252;">variable hi = Double_Type[n_bins];</span>
<span style="color: #8b2252;">lo[0]=0.005;</span>
<span style="color: #8b2252;">hi[0]=(lo[0] + lo[0]*df_f);</span>

<span style="color: #8b2252;">for(i=1;i&lt;n_bins;i++){</span>
<span style="color: #8b2252;">    lo[i]=hi[i-1];</span>
<span style="color: #8b2252;">    hi[i]=lo[i]+lo[i]*df_f;</span>
<span style="color: #8b2252;"> }</span>

<span style="color: #8b2252;">%logarithmic frequency bin centre</span>
<span style="color: #8b2252;">variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));</span>

<span style="color: #8b2252;">%declare arrays</span>
<span style="color: #8b2252;">variable rb_n = Integer_Type[n_bins];</span>
<span style="color: #8b2252;">variable lag = Double_Type[n_bins];</span>
<span style="color: #8b2252;">variable g_a_real = Double_Type[n_bins];</span>
<span style="color: #8b2252;">variable g_a_imag = Double_Type[n_bins];</span>
<span style="color: #8b2252;">variable g_a = Double_Type[n_bins];</span>
<span style="color: #8b2252;">variable g_b = Double_Type[n_bins];</span>
<span style="color: #8b2252;">variable g_c = Double_Type[n_bins];</span>
<span style="color: #8b2252;">variable g = Double_Type[n_bins];</span>
<span style="color: #8b2252;">variable delta_phi = Double_Type[n_bins];</span>
<span style="color: #8b2252;">variable delta_lag = Double_Type[n_bins];</span>

<span style="color: #8b2252;">%loop through observarions</span>
<span style="color: #8b2252;">for(k=0; k&lt;length(obs_id); k++){</span>


<span style="color: #8b2252;">%Read data:</span>
<span style="color: #8b2252;">variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");</span>
<span style="color: #8b2252;">variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");</span>

<span style="color: #8b2252;">%exclude non-numbers:</span>
<span style="color: #8b2252;">variable ix_soft = where(not isnan(lc_soft.rate));</span>
<span style="color: #8b2252;">variable ix_hard = where(not isnan(lc_hard.rate));</span>

<span style="color: #8b2252;">%Pass to new variables:</span>
<span style="color: #8b2252;">variable time_soft = lc_soft.time[ix_soft];</span>
<span style="color: #8b2252;">variable time_hard = lc_hard.time[ix_hard];</span>
<span style="color: #8b2252;">variable rate_soft = lc_soft.rate[ix_soft];</span>
<span style="color: #8b2252;">variable rate_hard = lc_hard.rate[ix_hard];</span>
<span style="color: #8b2252;">variable error_soft = lc_soft.error[ix_soft];</span>
<span style="color: #8b2252;">variable error_hard = lc_hard.error[ix_hard];</span>

<span style="color: #8b2252;">% Compute soft dft:</span>
<span style="color: #8b2252;">variable dft_soft = fft(rate_soft,-1);</span>
<span style="color: #8b2252;">variable freq = [[0:length(dft_soft)-1]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));</span>
<span style="color: #8b2252;">variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);</span>
<span style="color: #8b2252;">variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);</span>

<span style="color: #8b2252;">% Compute hard dft:</span>
<span style="color: #8b2252;">variable dft_hard = fft(rate_hard,-1);</span>
<span style="color: #8b2252;">variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);</span>
<span style="color: #8b2252;">variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);</span>

<span style="color: #8b2252;">%Calculate and sum CPS for each frequency bin in each observation.</span>
<span style="color: #8b2252;">for(i=0; i&lt; n_bins; i++)</span>
<span style="color: #8b2252;">{</span>
<span style="color: #8b2252;">        for (j=0; j&lt;length(freq); j++)</span>
<span style="color: #8b2252;">        {</span>
<span style="color: #8b2252;">                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])</span>
<span style="color: #8b2252;">                {</span>
<span style="color: #8b2252;">                        g_a_real[i] += abs(dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);</span>
<span style="color: #8b2252;">                        g_a_imag[i] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];</span>
<span style="color: #8b2252;">                        g_b[i] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];</span>
<span style="color: #8b2252;">                        g_c[i] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];</span>
<span style="color: #8b2252;">                        rb_n[i] ++;</span>
<span style="color: #8b2252;">                }</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">%Plot variables including frequency error bars</span>
<span style="color: #8b2252;">variable x = (hi+lo)/2;</span>
<span style="color: #8b2252;">variable dxp = hi-x;</span>
<span style="color: #8b2252;">variable dxm = x-lo;</span>

<span style="color: #8b2252;">%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.</span>
<span style="color: #8b2252;">for(i=0;i&lt;n_bins;i++)</span>
<span style="color: #8b2252;">{</span>
<span style="color: #8b2252;">        %Lag error</span>
<span style="color: #8b2252;">        g_a[i] = (g_a_real[i]*g_a_real[i] + g_a_imag[i]*g_a_imag[i])/(double(rb_n[i])*double(rb_n[i]));</span>
<span style="color: #8b2252;">        g_b[i] /= double(rb_n[i]);</span>
<span style="color: #8b2252;">        g_c[i] /= double(rb_n[i]);</span>
<span style="color: #8b2252;">        g[i] = g_a[i]/(g_b[i]*g_c[i]);</span>
<span style="color: #8b2252;">        delta_phi[i] = sqrt((1.0-g[i])/(2.0*g[i]))/sqrt(double(rb_n[i]));</span>
<span style="color: #8b2252;">        delta_lag[i] = delta_phi[i]/(2.0*PI*rb_freq[i]);</span>

<span style="color: #8b2252;">        %Lag</span>
<span style="color: #8b2252;">        g_a_real[i] /= rb_n[i];</span>
<span style="color: #8b2252;">        g_a_imag[i] /= rb_n[i];</span>
<span style="color: #8b2252;">        lag[i] = atan2(g_a_imag[i] , g_a_real[i])/(2.0*PI*rb_freq[i]);</span>
<span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">% Plot results:</span>

<span style="color: #8b2252;">open_plot("lagfreq.gif/gif");</span>

<span style="color: #8b2252;">xlog;</span>
<span style="color: #8b2252;">ylog;</span>
<span style="color: #8b2252;">xlabel("Frequency (Hz)");</span>
<span style="color: #8b2252;">ylabel("Time Lag (s)");</span>
<span style="color: #8b2252;">title("GX339-4 0605610201 lag-frequency &gt;3e-3 Hz");</span>
<span style="color: #8b2252;">connect_points(0);</span>

<span style="color: #8b2252;">plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4,dsym=6, xrange=[3e-3,10], yrange=[0.0001,1]);</span>
<span style="color: #8b2252;">_pgmove(-10000,0);</span>
<span style="color: #8b2252;">_pgsls(2);</span>
<span style="color: #8b2252;">_pgslw(1);</span>
<span style="color: #8b2252;">_pgdraw(1,0);</span>

<span style="color: #8b2252;">for (i=0; i&lt;length(x); i++) {</span>
<span style="color: #8b2252;">  () = printf("%e,%e,%e\n", x[i], lag[i], delta_lag[i]);</span>
<span style="color: #8b2252;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-1-10" class="outline-4">
<h4 id="sec-2-1-10"><span class="section-number-4">2.1.10</span> Lag-Energy Scripts</h4>
<div class="outline-text-4" id="text-2-1-10">
</div><ol class="org-ol"><li><a id="sec-2-1-10-0-0-1" name="sec-2-1-10-0-0-1"></a>Setup Script<br  /><div class="outline-text-7" id="text-2-1-10-0-0-1">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python</span>
<span style="color: #a020f0;">import</span> os
<span style="color: #a0522d;">i</span>=0
<span style="color: #b22222;">#</span><span style="color: #b22222;">Enter energy bands here</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">band = [300,350,400,500,600,700,800,1000,1300,1600,2000,2400,3000,4000,5000,6000,7000,10000]</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">band = [300,400,500,600,800,1000,1300,2000,3000,4000,5000,7000,10000]</span>

<span style="color: #a0522d;">band</span> = [400,550,700,900,1100,1400,1700,2000,2400,3200,3600,4000,4400,4700,5200,5600,6000,6700,7300,8100,9000,9600]
<span style="color: #a0522d;">number_bands</span> = (<span style="color: #483d8b;">len</span>(band)-1)

<span style="color: #a0522d;">min1</span> = <span style="color: #8b2252;">'31'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">Set source coordinates.</span>
<span style="color: #a0522d;">max1</span> = <span style="color: #8b2252;">'45'</span>
<span style="color: #a0522d;">minmax1</span> = <span style="color: #8b2252;">'['</span>+min1+<span style="color: #8b2252;">':'</span>+max1+<span style="color: #8b2252;">']'</span>

<span style="color: #a0522d;">min2</span> = <span style="color: #8b2252;">'3'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">Set background coordinates.</span>
<span style="color: #a0522d;">max2</span> = <span style="color: #8b2252;">'5'</span>
<span style="color: #a0522d;">minmax2</span> = <span style="color: #8b2252;">'['</span>+min2+<span style="color: #8b2252;">':'</span>+max2+<span style="color: #8b2252;">']'</span>

<span style="color: #a020f0;">while</span>(i &lt; number_bands):
    os.system(<span style="color: #8b2252;">"echo 'Running band "</span> + <span style="color: #483d8b;">repr</span>(band[i]) + <span style="color: #8b2252;">"-"</span> + <span style="color: #483d8b;">repr</span>(band[i+1]) + <span style="color: #8b2252;">"eV.'"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">Energy filters</span>
    os.system(<span style="color: #8b2252;">"evselect table=EPICclean.fits withfilteredset=yes filteredset=PN_time_reference.fits filtertype=expression expression='(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in ["</span> + <span style="color: #483d8b;">repr</span>(band[0])  + <span style="color: #8b2252;">":"</span> + <span style="color: #483d8b;">repr</span>(band[i]) + <span style="color: #8b2252;">"],["</span> + <span style="color: #483d8b;">repr</span>(band[i+1]) + <span style="color: #8b2252;">":"</span> + <span style="color: #483d8b;">repr</span>(band[number_bands]) + <span style="color: #8b2252;">"])&amp;&amp;#XMMEA_EP' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=EPICclean.fits withfilteredset=yes filteredset=PN_time_narrow.fits filtertype=expression expression='(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in ["</span> +  <span style="color: #483d8b;">repr</span>(band[i]) + <span style="color: #8b2252;">":"</span> + <span style="color: #483d8b;">repr</span>(band[i+1]) +<span style="color: #8b2252;">"])&amp;&amp;#XMMEA_EP' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">Source extraction - NOTE BLANK CIRCLES</span>
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_reference.fits  withfilteredset=yes filteredset=PN_time_reference_src.fits filtertype=expression expression='RAWX in "</span>+minmax1+<span style="color: #8b2252;">"' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_narrow.fits  withfilteredset=yes filteredset=PN_time_narrow_src.fits filtertype=expression expression='RAWX in "</span>+minmax1+<span style="color: #8b2252;">"' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">Background extraction - NOTE BLANK CIRCLES</span>
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_reference.fits withfilteredset=yes filteredset=PN_time_reference_bkg.fits filtertype=expression expression='RAWX in "</span>+minmax2+<span style="color: #8b2252;">"' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_narrow.fits  withfilteredset=yes filteredset=PN_time_narrow_bkg.fits filtertype=expression expression='RAWX in "</span>+minmax2+<span style="color: #8b2252;">"' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">Create light curves</span>
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_reference_src.fits withrateset=yes rateset=PN_time_reference_src_lc.fits maketimecolumn=yes timecolumn=TIME timebinsize=0.006 makeratecolumn=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_narrow_src.fits withrateset=yes rateset=PN_time_narrow_src_lc.fits maketimecolumn=yes timecolumn=TIME timebinsize=0.006 makeratecolumn=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_reference_bkg.fits withrateset=yes rateset=PN_time_reference_bkg_lc.fits maketimecolumn=yes timecolumn=TIME timebinsize=0.006 makeratecolumn=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_narrow_bkg.fits withrateset=yes rateset=PN_time_narrow_bkg_lc.fits maketimecolumn=yes timecolumn=TIME timebinsize=0.006 makeratecolumn=yes &amp;&gt; /dev/null"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">Epic light curve correction</span>
    os.system(<span style="color: #8b2252;">"epiclccorr srctslist=PN_time_reference_src_lc.fits eventlist=EPICclean.fits outset=reference_"</span> + <span style="color: #483d8b;">repr</span>(band[i]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">repr</span>(band[i+1]) +<span style="color: #8b2252;">"_lccorr.fits bkgtslist=PN_time_reference_bkg_lc.fits withbkgset=yes applyabsolutecorrections=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"epiclccorr srctslist=PN_time_narrow_src_lc.fits eventlist=EPICclean.fits outset=narrow_"</span> + <span style="color: #483d8b;">repr</span>(band[i]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">repr</span>(band[i+1]) + <span style="color: #8b2252;">"_lccorr.fits bkgtslist=PN_time_narrow_bkg_lc.fits withbkgset=yes applyabsolutecorrections=yes &amp;&gt; /dev/null"</span>)
    <span style="color: #a0522d;">i</span>=i+1
</pre>
</div>
</div>
</li>

<li><a id="sec-2-1-10-0-0-2" name="sec-2-1-10-0-0-2"></a>Plotting script<br  /><div class="outline-text-7" id="text-2-1-10-0-0-2">
<pre class="example">
%declare observation ID's
variable obs_id = ["0605610201"];

%declare energy band edges
%variable band = [300,350,400,500,600,700,800,1000,1300,1600,2000,2400,3000,4000,5000,6000,7000,10000];

variable band = [300,400,500,600,800,1000,1300,2000,3000,4000,5000,7000,10000];

variable number_bands = length(band)-1;
variable i;
variable k;
variable j;

%Declare arrays
variable g_a_real = Double_Type[number_bands];
variable g_a_imag = Double_Type[number_bands];
variable g_a = Double_Type[number_bands];
variable g_b = Double_Type[number_bands];
variable g_c = Double_Type[number_bands];
variable g = Double_Type[number_bands];
variable delta_phi = Double_Type[number_bands];
variable delta_lag = Double_Type[number_bands];
variable lag = Double_Type[number_bands];

%Set frequency range interested in
variable lo = 0.0005;
variable hi = 0.02;


%Logarithmic centre of frequency bin
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));

%counts CPS for each binlag_en_script.sl
variable rb_n = Integer_Type[number_bands];

%Define energy bins
variable elo = Double_Type[number_bands];
variable ehi = Double_Type[number_bands];

for(i=0; i&lt;number_bands;i++){
        elo[i] =  band[i];
        ehi[i] = band[i+1];
}


%loop through observations
for(k=0; k&lt;length(obs_id); k++){

%change to appropriate directory for observation

variable fn_r;
variable fn_n;

%loop through energy bands
for(i=0; i&lt;number_bands; i++){

%read in fits file - MAKE SURE FILE NAMES MATCH
fn_r = sprintf("reference_%i_%i_lccorr.fits",band[i],band[i+1]);
fn_n = sprintf("narrow_%i_%i_lccorr.fits",band[i],band[i+1]);

variable lc_reference = fits_read_table(fn_r);
variable lc_narrow = fits_read_table(fn_n);

%exclude non-numbers:
variable ix_reference = where(not isnan(lc_reference.rate));
variable ix_narrow = where(not isnan(lc_narrow.rate));

% Pass to new variables:
variable time_reference = lc_reference.time[ix_reference];
variable time_narrow = lc_narrow.time[ix_narrow];
variable rate_reference = lc_reference.rate[ix_reference];
variable rate_narrow = lc_narrow.rate[ix_narrow];
variable error_reference = lc_reference.error[ix_reference];
variable error_narrow = lc_narrow.error[ix_narrow];

% Compute reference dft:
variable dft_reference = fft(rate_reference,-1);
variable freq = [[0:length(dft_reference)-1]]/(double(length(dft_reference))*(time_reference[1]-time_reference[0]));
variable dft_real_reference = Real(dft_reference[[0:length(freq)-1]]);
variable dft_imag_reference = Imag(dft_reference[[0:length(freq)-1]]);

% Compute narrow dft:
variable dft_narrow = fft(rate_narrow,-1);
variable dft_real_narrow = Real(dft_narrow[[0:length(freq)-1]]);
variable dft_imag_narrow = Imag(dft_narrow[[0:length(freq)-1]]);

% Calculate CPS in the frequency range [lo,hi] for each energy bin [i], summing across observations.
for (j=0; j&lt;length(freq); j++){
if(freq[j] &gt; lo &amp;&amp; freq[j] &lt;= hi)
                {
                        g_a_real[i] += dft_real_reference[j]*dft_real_narrow[j] + dft_imag_reference[j]*dft_imag_narrow[j];
                        g_a_imag[i] += dft_real_narrow[j]*dft_imag_reference[j]-dft_real_reference[j]*dft_imag_narrow[j];
                        g_b[i] += dft_real_reference[j]*dft_real_reference[j] + dft_imag_reference[j]*dft_imag_reference[j];
                        g_c[i] += dft_real_narrow[j]*dft_real_narrow[j] + dft_imag_narrow[j]*dft_imag_narrow[j];
                        rb_n[i] ++;
                }

}
}
}

variable x = (ehi+elo)/2;
variable dxp = ehi-x;
variable dxm = x-elo;

%Average the CPS for each energy bin for all observations. Calculate coherence, g[i], for each energy bin.
for(i=0; i&lt;number_bands; i++){
        %Lag error
        g_a[i] = (g_a_real[i]*g_a_real[i] + g_a_imag[i]*g_a_imag[i])/(double(rb_n[i])*double(rb_n[i]));
        g_b[i] /= double(rb_n[i]);
        g_c[i] /= double(rb_n[i]);
        g[i] = g_a[i]/(g_b[i]*g_c[i]);
        delta_phi[i] = sqrt((1.0-g[i])/(2.0*g[i]))/sqrt(double(rb_n[i]));
        delta_lag[i] = delta_phi[i]/(2.0*PI*rb_freq);

        %Lag
        g_a_real[i] /= rb_n[i];
        g_a_imag[i] /= rb_n[i];
        lag[i] = atan2(g_a_imag[i] , g_a_real[i])/(2.0*PI*rb_freq);

}

%open_plot("lagen_1.9-6.7.gif/gif");
xlog;
ylin;
xlabel("Energy (eV)");
ylabel("Time Lag (s)");
title("GX339-4 0605610201 lag-energy 0.05-2 Hz");
connect_points(0);
_pgsfs(3);
fit_fun("powerlaw + gauss");
plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=2, dsym=6, xrange=[300,10000], yrange=[-0.3,0.1]);
_pgmove(300,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

for (i=0; i&lt;length(x); i++) {
  () = printf("%e,%e,%e\n", x[i], lag[i], delta_lag[i]);
}
%close_plot;
</pre>
</div>
</li></ol>
</div>
<div id="outline-container-sec-2-1-11" class="outline-4">
<h4 id="sec-2-1-11"><span class="section-number-4">2.1.11</span> Segment Analysis Script</h4>
<div class="outline-text-4" id="text-2-1-11">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">This python program runs the Epitropakis method for analysis of scripts. After this the time lag</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">To run, arguments should be supplied in the order, OBSID, Obs start time, Obs end time and Number of Segments Required. e.g. python segment_analysis.py 0605610201 000000000 999999999 10.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">This MUST be located in the same folder as the other observation IDs are when executed.</span>

<span style="color: #a020f0;">import</span> os,sys

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">main</span>(argv):
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(sys.argv)&lt;4:
               <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">'Add more arguments. Should be in the form:  ObservationID, Observation Start Time, Observation End Time and Number of Segments'</span>
               sys.<span style="color: #008b8b;">exit</span>(2)

        <span style="color: #a0522d;">ObservationID</span> = <span style="color: #483d8b;">int</span>(sys.argv[1]) <span style="color: #b22222;"># </span><span style="color: #b22222;">Import the arguments</span>
        <span style="color: #a0522d;">StartTime</span> = <span style="color: #483d8b;">int</span>(sys.argv[2])
        <span style="color: #a0522d;">EndTime</span> = <span style="color: #483d8b;">int</span>(sys.argv[3])
        <span style="color: #a0522d;">NumberOfSegments</span> = <span style="color: #483d8b;">int</span>(sys.argv[4])

        <span style="color: #a0522d;">TotalTime</span> = EndTime-StartTime <span style="color: #b22222;"># </span><span style="color: #b22222;">Use the times to work out how long each segment will last for</span>
        <span style="color: #a0522d;">AverageSegmentTime</span> = <span style="color: #483d8b;">int</span>(TotalTime/NumberOfSegments)
        <span style="color: #a0522d;">ExtraTime</span> = TotalTime - AverageSegmentTime*NumberOfSegments <span style="color: #b22222;"># </span><span style="color: #b22222;">Calculates if rounding would cause some time to omitted in the analysis.</span>
        <span style="color: #a0522d;">StringNumberOfSegments</span> = <span style="color: #483d8b;">str</span>(NumberOfSegments) <span style="color: #b22222;"># </span><span style="color: #b22222;">Useful to have this as a string later on.</span>

        <span style="color: #a020f0;">for</span> SegmentNumber <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(0,NumberOfSegments): <span style="color: #b22222;"># </span><span style="color: #b22222;">This now begins the analysis for each segment.</span>

            <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Working on Segment"</span>,SegmentNumber

            <span style="color: #a020f0;">if</span> SegmentNumber != NumberOfSegments: <span style="color: #b22222;"># </span><span style="color: #b22222;">Calculate the segment start and end time.</span>
                <span style="color: #a0522d;">SegmentStartTime</span> = StartTime + (SegmentNumber*AverageSegmentTime)
                <span style="color: #a0522d;">SegmentEndTime</span> = SegmentStartTime + AverageSegmentTime
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a0522d;">SegmentStartTime</span> = StartTime + (SegmentNumber*AverageSegmentTime) + ExtraTime
                <span style="color: #a0522d;">SegmentEndTime</span> = SegmentStartTime + AverageSegmentTime
            <span style="color: #a0522d;">StringObservationID</span> = <span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">str</span>(0)+<span style="color: #483d8b;">str</span>(ObservationID)) <span style="color: #b22222;"># </span><span style="color: #b22222;">When stored as an int the Observation ID loses its initial 0 so this is added.</span>
            <span style="color: #a0522d;">StringSegmentNumber</span> = <span style="color: #483d8b;">str</span>(SegmentNumber)

            os.system(<span style="color: #8b2252;">"mkdir 0%d/seg%d"</span> % (ObservationID,SegmentNumber)) <span style="color: #b22222;"># </span><span style="color: #b22222;">Create the segment root folder</span>

            <span style="color: #a0522d;">f1</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"/data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/SegmentAnalysisTemplateGeneral.tsh"</span>,<span style="color: #8b2252;">"r"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Opens a segment analysis template file.</span>
            <span style="color: #a0522d;">f2</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"0"</span>+<span style="color: #483d8b;">str</span>(ObservationID)+<span style="color: #8b2252;">"/seg"</span>+<span style="color: #483d8b;">str</span>(SegmentNumber)+<span style="color: #8b2252;">"/SegmentAnalysis.tsh"</span>,<span style="color: #8b2252;">"w"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Opens a local version which will be run.</span>
            <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f1: <span style="color: #b22222;"># </span><span style="color: #b22222;">For each line in the template file...</span>
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTSTARTTIME"</span>,<span style="color: #483d8b;">str</span>(SegmentStartTime)) <span style="color: #b22222;">#</span><span style="color: #b22222;">... any instance of the Caps words is replaced with the actual variable.</span>
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTENDTIME"</span>,<span style="color: #483d8b;">str</span>(SegmentEndTime))
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"OBSERVATIONID"</span>,StringObservationID)
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"ROOTPATH"</span>,<span style="color: #483d8b;">str</span>(os.getcwd()))
                f2.write(line)
            f1.close()
            f2.close()

            os.chdir(<span style="color: #8b2252;">"0%d/seg%d/"</span> % (ObservationID,SegmentNumber)) <span style="color: #b22222;"># </span><span style="color: #b22222;">The script moves into the folder with the .tsh script in, and runs it, then moves out again.</span>
            os.system(<span style="color: #8b2252;">"tcsh "</span>+<span style="color: #483d8b;">str</span>(os.getcwd())+<span style="color: #8b2252;">"/0%d/seg%d/SegmentAnalysis.tsh"</span> % (ObservationID,SegmentNumber))
            os.chdir(<span style="color: #8b2252;">"../../"</span>)

        <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"The light curves have been produced for each segment.\n"</span>

        <span style="color: #a0522d;">f1</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"/data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/lagfreq_cohfreq_script_template.sl"</span>,<span style="color: #8b2252;">"r"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Open the Epitropakis lag-frequency method template file.</span>
        <span style="color: #a0522d;">f2</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"0"</span>+<span style="color: #483d8b;">str</span>(ObservationID)+<span style="color: #8b2252;">"/lagfreq_cohfreq_script.sl"</span>,<span style="color: #8b2252;">"w"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Create a local copy</span>
        <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f1:
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"OBSERVATIONID"</span>,StringObservationID)
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTNUMBER"</span>,StringNumberOfSegments)
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"ROOTPATH"</span>,<span style="color: #483d8b;">str</span>(os.getcwd()))
             f2.write(line)
        f1.close()
        f2.close()


        <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"The file to calculate coherence (nntest_lagfreq.sl) for observation "</span>+StringObservationID+<span style="color: #8b2252;">" and "</span>+StringNumberOfSegments+<span style="color: #8b2252;">" segments has been generated in the observation ID root folder.\n\nThis should be called manually once the segment folders have been checked using: isis nntest_lagfreq.sl\n"</span>


<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">"__main__"</span>:
        main(sys.argv[4:])
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-1-12" class="outline-4">
<h4 id="sec-2-1-12"><span class="section-number-4">2.1.12</span> Coherence Analysis Script</h4>
<div class="outline-text-4" id="text-2-1-12">
<pre class="example">
%declare observation ID's
variable obs_id = ["0605610201"];

variable obs_segs = [20];

variable i;
variable j;
variable k;
variable n;

% declare frequency bins
variable re_bin_f = 35; % with binninng
variable df_f = 0.25;
variable lo_bin_f = 5e-3;

%declare the number of frequency bins
variable n_bins = 15000; % without binning

%declare arrays
variable lag = Double_Type[n_bins];
variable rb_n = Integer_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_real_2 = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_a_2 = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable coh = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];
variable delta_coh = Double_Type[n_bins];

variable seg_length = 20000;
variable seg_min = 20000;

for(k=0; k&lt;length(obs_id); k++){
        for (n=0; n&lt;obs_segs[k]; n++)
        {
                () = chdir("/data/cluster/XRayReverb2016/HarryData/GX339-4/"+obs_id[k] + sprintf("/seg%i", n));
                variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
                variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");
                variable ix_soft = where(not isnan(lc_soft.rate));
                variable ix_hard = where(not isnan(lc_hard.rate));

                if(length(ix_soft) &lt; seg_min)
                {
                        seg_length = length(ix_soft);
                }
                seg_min = seg_length;
                vmessage("check data: " + obs_id[k] + sprintf("/seg%i", n) + sprintf("  length= %i",  length(ix_soft)));
        }
}
vmessage("****set seg_length =%i", seg_length);

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){
for (n=0; n&lt;=obs_segs[k]; n++){

() = chdir( "/data/cluster/XRayReverb2016/HarryData/GX339-4/" +obs_id[k] + sprintf("/seg%i", n));
%vmessage( obs_id[k] + sprintf("/seg%i", n));

%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));
variable rate_soft = Double_Type[seg_length];
variable rate_hard = Double_Type[seg_length];
variable time_soft = Double_Type[seg_length];
variable time_hard = Double_Type[seg_length];
variable error_soft = Double_Type[seg_length];
variable error_hard = Double_Type[seg_length];

%Pass to new variables:
variable o_time_soft = lc_soft.time[ix_soft];
variable o_time_hard = lc_hard.time[ix_hard];
variable o_rate_soft = lc_soft.rate[ix_soft];
variable o_rate_hard = lc_hard.rate[ix_hard];
variable o_error_soft = lc_soft.error[ix_soft];
variable o_error_hard = lc_hard.error[ix_hard];

for(j=0; j&lt;seg_length; j++)
{
        rate_soft[j] = o_rate_soft[j];
        rate_hard[j] = o_rate_hard[j];
        time_soft[j] = o_time_soft[j];
        time_hard[j] = o_time_hard[j];
        error_soft[j] = o_error_soft[j];
        error_hard[j] = o_error_hard[j];


}

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[1:length(dft_soft)]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);

variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

% Adjust frequency bins
variable x = Double_Type[n_bins];
variable dxp = Double_Type[n_bins];
variable dxm = Double_Type[n_bins];
for(i=1;i&lt;n_bins;i++)
{
        x[i] = freq[i];
        dxp[i] = (freq[i+1] - x[i])/2;
        dxm[i] = (x[i] - freq[i-1])/2;
}

variable lo = Double_Type[re_bin_f];
variable hi = Double_Type[re_bin_f];
lo[0]=lo_bin_f;
hi[0]=(lo[0] + lo[0]*df_f);
for(i=1;i&lt;re_bin_f;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
}
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));
variable x_bin = (hi+lo)/2;
variable dxp_bin = hi-x_bin;
variable dxm_bin = x_bin-lo;

%Calculate and sum CPS for each frequency bin in each observation.
for(j=0; j&lt; n_bins; j++)
{
                        %() = printf("j= %i freq= %e\n", j, freq[j]);
                        g_a_real[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_real_2[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[j] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[j] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];	% Periodrogram s
                        g_c[j] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];	% Periodrogram h
                        rb_n[j] ++;
                
}
}
}

%Plot variables including frequency error bars
for(j=0; j&lt; n_bins; j++)
{
        g_a_real[j] = g_a_real[j]/rb_n[j];
        g_a_real_2[j] = g_a_real_2[j] /rb_n[j];
        g_a_imag[j] = g_a_imag[j]/rb_n[j];
        g_a[j] = (g_a_real[j]*g_a_real[j] + g_a_imag[j]*g_a_imag[j]);
        g_a_2[j] = (g_a_real_2[j]*g_a_real_2[j] + g_a_imag[j]*g_a_imag[j]);
        g_b[j] = g_b[j]/rb_n[j];
        g_c[j] = g_c[j]/rb_n[j];
        g[j] = g_a[j]/(g_b[j]*g_c[j]);
        coh[j] = g_a_2[j]/(g_b[j]*g_c[j]);
        delta_phi[j] = sqrt((1.0-g[j])/(2.0*g[j]))/sqrt(double(rb_n[j]));	
        delta_lag[j] = delta_phi[j]/(2.0*PI*freq[j]);
        delta_coh[j] = 0.0; 

        lag[j] = atan2(g_a_imag[j] , g_a_real[j])/(2.0*PI*freq[j]);
}


variable fb_n = Integer_Type[re_bin_f];
variable n_est = Integer_Type[re_bin_f];

variable lag_bin = Double_Type[re_bin_f];
variable g_a_real_bin = Double_Type[re_bin_f];
variable g_a_real_2_bin = Double_Type[re_bin_f];
variable g_a_imag_bin = Double_Type[re_bin_f];
variable g_a_bin = Double_Type[re_bin_f];
variable g_a_2_bin = Double_Type[re_bin_f];
variable g_b_bin = Double_Type[re_bin_f];
variable g_c_bin = Double_Type[re_bin_f];
variable g_bin = Double_Type[re_bin_f];
variable delta_phi_bin = Double_Type[re_bin_f];
variable delta_lag_bin = Double_Type[re_bin_f];
variable delta_coh_bin = Double_Type[re_bin_f];

for(i=0; i&lt; re_bin_f; i++)
{
        for (j=0; j&lt;n_bins; j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {
                        g_a_real_bin[i] += g_a_real[j];
                        g_a_real_2_bin[i] += g_a_real_2[j];
                        g_a_imag_bin[i] += g_a_imag[j];
                        g_b_bin[i] += g_b[j];
                        g_c_bin[i] += g_c[j];
                        fb_n[i]++;
                        n_est[i] += rb_n[j];
                }
        }
}

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0; i&lt;re_bin_f; i++)
{
        %Lag error
        g_a_real_bin[i] /= fb_n[i];
        g_a_imag_bin[i] /= fb_n[i];
        g_a_bin[i] = (g_a_real_bin[i]*g_a_real_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_a_2_bin[i] = (g_a_real_2_bin[i]*g_a_real_2_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_b_bin[i] /= double(fb_n[i]);
        g_c_bin[i] /= double(fb_n[i]);
        g_bin[i] = g_a_bin[i]/(g_b_bin[i]*g_c_bin[i]);
        delta_phi_bin[i] = sqrt((1.0-g_bin[i])/(2.0*g_bin[i]))/sqrt(double(n_est[i]));	
        delta_lag_bin[i] = delta_phi_bin[i]/(2.0*PI*rb_freq[i]);
        lag_bin[i] = atan2(g_a_imag_bin[i] , g_a_real_bin[i])/(2.0*PI*rb_freq[i]);
}


() = chdir( "/data/cluster/XRayReverb2016/HarryData/GX339-4/"+obs_id[0] );

% Plot coherence results:

open_plot("CoherenceFrequency.gif/gif");

%window(1);
xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Coherence");
title("GX339-4 0605610201 Coherence");
connect_points(0);
_pgsfs(3);

plotxy(x,dxm,dxp,coh,delta_coh,delta_coh; dcol=1, decol=4, dsym=6, xrange=[3e-1,10],yrange=[0.1,2]);	% coherence

_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

%Coherence value (horzontal) line
_pgmove(-1, log10(1.2/(1+(0.2*obs_segs[0]))));
_pgsls(3); % line style?
_pgsci(3); % colour 1- black, 2-red, 3 - green
_pgslw(4); % line width?
_pgdraw(1.3, log10(1.2/(1+(0.2*obs_segs[0]))));

% Vertical max freq line
_pgmove(log10(1.5), log10(1e-4) );
_pgsls(2);
_pgsci(2);
_pgslw(4);
_pgdraw(log10(1.5), log10(1e2));

close_plot;

%Display the lag-freq values
for (i=0; i&lt;re_bin_f; i++) {
  () = printf("%e,  %e,  %e\n", x_bin[i], lag_bin[i], delta_lag[i]);
}



% Plot binned Lag-freq results:
%window(1);

open_plot("EpitropakisLagFrequency.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0605610201 Lag-Frequency");
connect_points(0);
_pgsfs(3);

plotxy(x_bin,dxm_bin,dxp_bin,lag_bin,delta_lag_bin,delta_lag_bin; dcol=1, decol=4, dsym=6,  xrange=[3e-3,10],yrange=[1e-4,1]);	% binned f lags
_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

% Vertical max freq line
_pgmove(log10(1.5), log10(1e-4) );
_pgsls(2);
_pgsci(2);
_pgslw(4);
_pgdraw(log10(1.5), log10(1e2));

close_plot;

% Plot unbinned Lag-freq results:
%window(1);

open_plot("EpitropakisUnbinnedLagFrequency.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0605610201 Unbinned Lag-Frequency");
connect_points(0);
_pgsfs(3);

%plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4, dsym=6, xrange=[3e-3,10],yrange=[1e-4,1]);	% unbinned f lags
_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

% Vertical max freq line
%_pgmove(-2.721,-1400); % 0.3-4k
%_pgmove(-3.284,-600); % 2-7k
%_pgsls(2);
%_pgsci(2);
%_pgslw(4);
%_pgdraw(-2.721,1400); % 0.3-4k
%_pgdraw(-3.284,600); % 2-7k

close_plot;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> 0654130401</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-sec-2-2-1" class="outline-4">
<h4 id="sec-2-2-1"><span class="section-number-4">2.2.1</span> Initial Processing</h4>
<div class="outline-text-4" id="text-2-2-1">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n Initial SAS setup, general for all files. Run in a suitable folder after replacing the OBSID'</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nDOWNLOAD TAR FILE...'</span>
curl -o O654130401.tar <span style="color: #8b2252;">"http://nxsa.esac.esa.int/nxsa-sl/servlet/data-action-aio?obsno=O654130401&amp;level=ODF"</span>
tar -zxvf *.tar
tar -xvf *.TAR

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n file unpacked. Setup SAS'</span>

heainit
setsas
<span style="color: #483d8b;">setenv</span> SAS_CCFPATH /usr/local/XMM/ccf/
<span style="color: #483d8b;">setenv</span> SAS_ODF $<span style="color: #a0522d;">PWD</span>
cifbuild
<span style="color: #483d8b;">setenv</span> SAS_CCF ccf.cif
odfingest
<span style="color: #483d8b;">setenv</span> SAS_ODF $<span style="color: #a0522d;">PWD</span>/*SUM.SAS
cp ccf.cif ../PROC
cp *SUM.SAS ../PROC
<span style="color: #483d8b;">cd</span> ../PROC

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n MOVED TO PROC FOLDER. INITIALISING WORK'</span>

epproc <span style="color: #a0522d;">randomizetime</span>=no <span style="color: #a0522d;">randomizeposition</span>=no <span style="color: #a0522d;">randomizeenergy</span>=no

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nScript to process ODF data\n\n\n'</span>
cp *TimingEvts.ds PN.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Create a light curve.'</span>
evselect <span style="color: #a0522d;">table</span>=PN.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_flares_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timebinsize</span>=10 <span style="color: #a0522d;">makeratecolumn</span>=yes <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'#XMMEA_EP &amp;&amp; (PI&gt;10000&amp;&amp;PI&lt;12000) &amp;&amp; (PATTERN==0)'</span>
dsplot <span style="color: #a0522d;">table</span>=PN_flares_lc.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;
</pre>
</div>

<p>
At this point flares must be removed if they exist.
In this instance there were no flares so they were not removed.
</p>
</div>
</div>
<div id="outline-container-sec-2-2-2" class="outline-4">
<h4 id="sec-2-2-2"><span class="section-number-4">2.2.2</span> Flare removal</h4>
<div class="outline-text-4" id="text-2-2-2">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n no flares removed'</span>
cp PN.fits EPICclean.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n MAKE IMAGE...'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withimageset</span>=yes <span style="color: #a0522d;">imageset</span>=EPICclean_image.fits <span style="color: #a0522d;">xcolumn</span>=RAWX <span style="color: #a0522d;">ycolumn</span>=RAWY <span style="color: #a0522d;">imagebinning</span>=binSize <span style="color: #a0522d;">ximagebinsize</span>=1 <span style="color: #a0522d;">yimagebinsize</span>=1
ds9 EPICclean_image.fits &amp;
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\nImage created. Please note down a source and background range of pixels.'</span>
</pre>
</div>


<div class="figure">
<p><img src="file:///data/cluster/XRayReverb2016/HarryData/GX339-4/0654130401/PROC/2DImage.gif" alt="2DImage.gif" />
</p>
<p><span class="figure-number">Figure 22:</span> 2D image plot of source.</p>
</div>
</div>
</div>

<div id="outline-container-sec-2-2-3" class="outline-4">
<h4 id="sec-2-2-3"><span class="section-number-4">2.2.3</span> Extract Source and Background Region</h4>
<div class="outline-text-4" id="text-2-2-3">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nSoft Filter\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in [500:1500])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nHard Filter\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in [2000:9000])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n Extract src and bg\n\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Source from Soft Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft_src.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [31:45]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Source from Hard Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard_src.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [31:45]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Background from Soft Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft_bkg.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [3:5]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Background from Hard Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard_bkg.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [3:5]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-2-4" class="outline-4">
<h4 id="sec-2-2-4"><span class="section-number-4">2.2.4</span> Make Light Curves</h4>
<div class="outline-text-4" id="text-2-2-4">
<p>
Note the time bin size here.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate Lightcurve from source\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from soft photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft_src.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_soft_src_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from hard photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard_src.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_hard_src_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from Background\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from soft photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft_bkg.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_soft_bkg_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from hard photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard_bkg.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_hard_bkg_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate Background Subtracted Light Curve\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nFrom soft photons (10 mins)\n'</span>
epiclccorr <span style="color: #a0522d;">srctslist</span>=PN_time_soft_src_lc.fits <span style="color: #a0522d;">eventlist</span>=EPICclean.fits <span style="color: #a0522d;">outset</span>=PN_time_soft_lccorr.fits <span style="color: #a0522d;">bkgtslist</span>=PN_time_soft_bkg_lc.fits <span style="color: #a0522d;">withbkgset</span>=yes <span style="color: #a0522d;">applyabsolutecorrections</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nFrom hard photons (10 mins)\n'</span>
epiclccorr <span style="color: #a0522d;">srctslist</span>=PN_time_hard_src_lc.fits <span style="color: #a0522d;">eventlist</span>=EPICclean.fits <span style="color: #a0522d;">outset</span>=PN_time_hard_lccorr.fits <span style="color: #a0522d;">bkgtslist</span>=PN_time_hard_bkg_lc.fits <span style="color: #a0522d;">withbkgset</span>=yes <span style="color: #a0522d;">applyabsolutecorrections</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Display the lightcurve'</span>

dsplot <span style="color: #a0522d;">table</span>=PN_time_soft_lccorr.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;
dsplot <span style="color: #a0522d;">table</span>=PN_time_hard_lccorr.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Note that the above lightcurves can be chopped with the evselect timemin and timemax command'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-2-5" class="outline-4">
<h4 id="sec-2-2-5"><span class="section-number-4">2.2.5</span> Produce Lag-Frequency Plots</h4>
<div class="outline-text-4" id="text-2-2-5">
<p>
Begin by downloading a template
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"\n\n\nProduce lagfreq script\n\n\n"</span>
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/isis_lagfreq_script.sl .
emacs isis_lagfreq_script.sl &amp;
<span style="color: #a020f0;">exit</span>
</pre>
</div>

<p>
Edit this file accordingly (update OBSID and frequency ranges if
necessary). Then run the file analysis in isis. The one used in this
case is shown in the following in a separate section <a href="#sec-2-2-9">here</a>.
</p>

<div class="org-src-container">

<pre class="src src-sh">isis isis_lagfreq_script.sl
<span style="color: #a020f0;">exit</span>;
<span style="color: #a020f0;">exit</span>
</pre>
</div>

<p>
The output from this is shown in Figure <a href="#LagFreq">18</a>.
</p>


<div id="LagFreq" class="figure">
<p><img src="./0654130401/PROC/lagfreq.gif" alt="lagfreq.gif" />
</p>
<p><span class="figure-number">Figure 23:</span> The lag-frequency graph for high luminosity GX339-4 observation</p>
</div>
</div>
</div>

<div id="outline-container-sec-2-2-6" class="outline-4">
<h4 id="sec-2-2-6"><span class="section-number-4">2.2.6</span> Produce Lag-Energy Plots</h4>
<div class="outline-text-4" id="text-2-2-6">
<p>
Once the lag-freq plots have been generated, the lag-energy plots can
also be made. This is done by initially copying an template and
editing suitably.
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nRun LagEng Processing Scripts\n\n\n'</span>
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/sas_lagen_script1.py .
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/isis_lagen_lf_script.sl .
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/isis_lagen_hf_script.sl .
<span style="color: #a020f0;">exit</span>
</pre>
</div>

<p>
Once done, the python script will run. This can take many hours so to
avoid it being interrupted the 'screen' tool has been used. Once a new
'screen' has been entered, the python script can be run (Note: the
environments variables may need to be reset.  Once the script is
running, pressing <code>Ctrl + A   d</code> will
detach the screen. To bring it back up, enter <code>screen
-r</code> to the command line. The output will be in the usual place.
</p>

<p>
The energy ranges were chosen using similar binning to DM15a.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n Run the Lag_energy scripts.\nThis step will take a long time.\nYou can close the ssh.\n\n\n'</span>
screen
python sas_lagen_script1.py
</pre>
</div>
<p>
Once complete the below can be run to generate the lag-energy plots
for high and low frequencies.
</p>
<div class="org-src-container">

<pre class="src src-sh">isis
() = evalfile(<span style="color: #8b2252;">"isis_lagen_lf_script.sl"</span>);
() = evalfile(<span style="color: #8b2252;">"isis_lagen_hf_script.sl"</span>);

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Script is complete'</span>
</pre>
</div>


<div id="LagEn" class="figure">
<p><img src="./0654130401/PROC/lagen_0.8-2Hz.gif" alt="lagen_0.8-2Hz.gif" />
</p>
<p><span class="figure-number">Figure 24:</span> The lag-energy graph for high luminosity GX339-4 observation</p>
</div>
</div>
</div>


<div id="outline-container-sec-2-2-7" class="outline-4">
<h4 id="sec-2-2-7"><span class="section-number-4">2.2.7</span> Epitropakis Methods</h4>
<div class="outline-text-4" id="text-2-2-7">
<p>
Following the analysis outlined by Epitropakis in Epitropakis 2016
(Theoretical modelling of the AGN iron-line/continuum time-lags in the
lamp-post geometry), we have calculated the lag frequencies in a new
way and also calculated the coherence. This is outlined below.
</p>

<p>
Initially it required splitting up the original observation into segments.
This would be time consuming to do manually so a python script which should do
this was developed in the section <a href="#sec-2-2-11">2.2.11</a>.
</p>

<p>
The python file should be run in the folder which contains the
observation ID folder. The scipt should be run with the observationID,
start time, end time and number of segments as arguments i.e.
</p>

<div class="org-src-container">

<pre class="src src-python">python run_segment_analysis.py 0605610201 354441000 354473000 2
</pre>
</div>

<p>
This generates segment directories (i.e. seg0,seg1) in the same folder
as the ODF and PROC folders are. In the segment directories a bash
script is created. The bash script performs all the filtering and
generates the light curves so will take a long time to run so should
be 'screened'.
</p>

<p>
The python script also outputs a modified lagfreq and coherence script
shown here: <a href="#sec-2-2-12">2.2.12</a>. This is placed with the PROC,
segX and ODF folders. This should be run to produce the lag frequency
and coherence files (as seen below) using the command:
</p>

<div class="org-src-container">

<pre class="src src-example">isis lagfreq_cohfreq_script.sl
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-2-2-7-1" name="sec-2-2-7-1"></a>Epitropakis Results<br  /><div class="outline-text-5" id="text-2-2-7-1">

<div id="EpitBLF" class="figure">
<p><img src="./0654130401/EpitropakisLagFrequency.gif" alt="EpitropakisLagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 25:</span> 0654130401 binned lag-frequency plot.</p>
</div>


<div id="EpitBLF" class="figure">
<p><img src="./0654130401/CoherenceFrequency.gif" alt="CoherenceFrequency.gif" />
</p>
<p><span class="figure-number">Figure 26:</span> 0654130401 coherence against frequency plot.</p>
</div>


<div id="EpitBLF" class="figure">
<p><img src="./0654130401/EpitropakisUnbinnedLagFrequency.gif" alt="EpitropakisUnbinnedLagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 27:</span> 0654130401 unbinned lag-frequency plot.</p>
</div>
</div>
</li></ol>
</div>
<div id="outline-container-sec-2-2-8" class="outline-4">
<h4 id="sec-2-2-8"><span class="section-number-4">2.2.8</span> Produce a spectrum - UNDER CONSTRUCTION</h4>
<div class="outline-text-4" id="text-2-2-8">
</div><ol class="org-ol"><li><a id="sec-2-2-8-0-0-1" name="sec-2-2-8-0-0-1"></a>Initial Processing<br  /><div class="outline-text-7" id="text-2-2-8-0-0-1">
<p>
Begin by refiltering the curve.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n FILTER CURVE...\n\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0) &amp;&amp; (PATTERN &lt;= 4)&amp;&amp;(PI in [200:15000])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">filteredset</span>=pn_filt.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes
</pre>
</div>

<p>
At this point the image and light curves can be looked at using. If
the previous sections have not been analysed already, this will need
to be done to determine the source and background regions.
</p>

<div class="org-src-container">

<pre class="src src-sh">evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">withimageset</span>=yes <span style="color: #a0522d;">imageset</span>=image.fits <span style="color: #a0522d;">xcolumn</span>=RAWX <span style="color: #a0522d;">ycolumn</span>=RAWY <span style="color: #a0522d;">imagebinning</span>=binSize <span style="color: #a0522d;">ximagebinsize</span>=1 <span style="color: #a0522d;">yimagebinsize</span>=0.001
ds9 image.fits &amp;

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n CREATE AND DISPLAY LIGHT CURVE...\n\n'</span>
evselect <span style="color: #a0522d;">table</span>=pn.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=pn_ltcrv.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.001 <span style="color: #a0522d;">makeratecolumn</span>=yes
fv pn_ltcrv.fits &amp;
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nEXTRACT SOURCE AND BACKGROUND'</span>
evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">withimageset</span>=yes <span style="color: #a0522d;">imageset</span>=image.fits <span style="color: #a0522d;">xcolumn</span>=RAWX <span style="color: #a0522d;">ycolumn</span>=RAWY <span style="color: #a0522d;">imagebinning</span>=binSize <span style="color: #a0522d;">ximagebinsize</span>=1 <span style="color: #a0522d;">yimagebinsize</span>=1 <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0) &amp;&amp; (PI in [500:15000])'</span>

evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_WithBore.fits <span style="color: #a0522d;">energycolumn</span>=PI <span style="color: #a0522d;">spectralbinsize</span>=5 <span style="color: #a0522d;">specchannelmin</span>=0 <span style="color: #a0522d;">specchannelmax</span>=20479 <span style="color: #a0522d;">filteredset</span>=pn_filt_source_WithBore.fits <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0) &amp;&amp; (PI in [500:15000]) &amp;&amp; (RAWX in [27:47])'</span>

evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">withspectrumset</span>=yes <span style="color: #a0522d;">spectrumset</span>=bkg_pi.fits <span style="color: #a0522d;">energycolumn</span>=PI <span style="color: #a0522d;">spectralbinsize</span>=5 <span style="color: #a0522d;">withspecranges</span>=yes <span style="color: #a0522d;">specchannelmin</span>=0 <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0) &amp;&amp; (PI in [500:15000]) &amp;&amp; (RAWX in [3:5])'</span> <span style="color: #a0522d;">specchannelmax</span>=20479 <span style="color: #a0522d;">withfilteredset</span>=y <span style="color: #a0522d;">filteredset</span>=pn_filt_bkg.fits

epatplot <span style="color: #a0522d;">set</span>=pn_filt_source_WithBore.fits <span style="color: #a0522d;">plotfile</span>=pn_epat.ps <span style="color: #a0522d;">useplotfile</span>=yes <span style="color: #a0522d;">withbackgroundset</span>=yes <span style="color: #a0522d;">backgroundset</span>=pn_filt_bkg.fits
gv pn_epat.ps &amp;
</pre>
</div>

<p>
At this point, pile up must be checked. The last command in the
previous section is used to do this. In the case the doubles are &gt;1
and singles &lt;1 then the detector has pileup. This can be corrected for
using the following method where a region of the source is removed.
</p>
</div>
</li>


<li><a id="sec-2-2-8-0-0-2" name="sec-2-2-8-0-0-2"></a>Case 1 - spectrum is piled up<br  /><div class="outline-text-7" id="text-2-2-8-0-0-2">
<p>
The code below extracts a region of the source. It then checks for
pileup this process must be repeated until pileup is removed.
</p>

<div class="org-src-container">

<pre class="src src-sh">evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">withspectrumset</span>=yes <span style="color: #a0522d;">spectrumset</span>=source_pi_NoBore.fits <span style="color: #a0522d;">energycolumn</span>=PI <span style="color: #a0522d;">spectralbinsize</span>=5 <span style="color: #a0522d;">withspecranges</span>=yes <span style="color: #a0522d;">specchannelmin</span>=0 <span style="color: #a0522d;">specchannelmax</span>=20479 <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG ==0)&amp;&amp;(PI in [500:15000])&amp;&amp;(RAWX in [27:47])&amp;&amp;!(RAWX in [30:44])'</span> <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=pn_filt_source_NoBore.fits
epatplot <span style="color: #a0522d;">set</span>=pn_filt_source_NoBore.fits <span style="color: #a0522d;">plotfile</span>=pn_epat.ps <span style="color: #a0522d;">useplotfile</span>=yes <span style="color: #a0522d;">withbackgroundset</span>=yes <span style="color: #a0522d;">backgroundset</span>=pn_filt_bkg.fits
gv pn_epat.ps &amp;
<span style="color: #483d8b;">echo</span>(<span style="color: #8b2252;">'\nCheck for pileup\n\n'</span>)
</pre>
</div>

<p>
Once this correction has been made, then the arf and rmf files may be
made, as shown below.
</p>

<div class="org-src-container">

<pre class="src src-sh">evselect <span style="color: #a0522d;">table</span>=pn_filt.fits <span style="color: #a0522d;">withspectrumset</span>=yes <span style="color: #a0522d;">spectrumset</span>=source_pi_Excised.fits <span style="color: #a0522d;">energycolumn</span>=PI <span style="color: #a0522d;">spectralbinsize</span>=5 <span style="color: #a0522d;">withspecranges</span>=yes <span style="color: #a0522d;">specchannelmin</span>=0 <span style="color: #a0522d;">specchannelmax</span>=20479 <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG ==0)&amp;&amp;(PI in [500:15000])&amp;&amp;(RAWX in [27:47])&amp;&amp;!(RAWX in [29:45])'</span> <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=pn_filt_source_Excised.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nDETERMINE SPECTRAL EXTRACTION AREA'</span>
backscale <span style="color: #a0522d;">spectrumset</span>=source_pi_NoBore.fits <span style="color: #a0522d;">badpixlocation</span>=pn_filt.fits
backscale <span style="color: #a0522d;">spectrumset</span>=bkg_pi.fits <span style="color: #a0522d;">badpixlocation</span>=pn_filt.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nMAKE RMF AND ARF FILES. (Takes a long time!)'</span>
rmfgen <span style="color: #a0522d;">rmfset</span>=source_rmf_NoBore.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_NoBore.fits

arfgen <span style="color: #a0522d;">arfset</span>=source_arf_WithBore.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_WithBore.fits <span style="color: #a0522d;">detmaptype</span>=psf
arfgen <span style="color: #a0522d;">arfset</span>=source_arf_Excised.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_Excised.fits <span style="color: #a0522d;">detmaptype</span>=psf

addarf <span style="color: #8b2252;">"source_arf_WithBore.fits source_arf_Excised.fits"</span> <span style="color: #8b2252;">"1.0 -1.0"</span> source_arf_NoBore.fits
<span style="color: #483d8b;">echo</span>(<span style="color: #8b2252;">"\n\ndone\n\n"</span>)
</pre>
</div>
</div>
</li>



<li><a id="sec-2-2-8-0-0-3" name="sec-2-2-8-0-0-3"></a>Case 2 - spectrum is not piled up<br  /><div class="outline-text-7" id="text-2-2-8-0-0-3">
<p>
In this instance, simply run the following to generate the rmf and arf files
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nDETERMINE SPECTRAL EXTRACTION AREA'</span>
backscale <span style="color: #a0522d;">spectrumset</span>=source_pi_NoBore.fits <span style="color: #a0522d;">badpixlocation</span>=pn_filt.fits
backscale <span style="color: #a0522d;">spectrumset</span>=bkg_pi.fits <span style="color: #a0522d;">badpixlocation</span>=pn_filt.fits
<span style="color: #483d8b;">echo</span>(<span style="color: #8b2252;">"\n\nproduce RMF and ARF files\n\n"</span>)
rmfgen <span style="color: #a0522d;">rmfset</span>=source_pi_WithBore_rmf.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_WithBore.fits
arfgen <span style="color: #a0522d;">arfset</span>=source_pi_WithBore_arf.fits <span style="color: #a0522d;">spectrumset</span>=source_pi_WithBore.fits <span style="color: #a0522d;">withrmfset</span>=yes <span style="color: #a0522d;">rmfset</span>=source_pi_WithBore_rmf.fits <span style="color: #a0522d;">withbadpixcorr</span>=yes <span style="color: #a0522d;">badpixlocation</span>=pn_filt.fits
</pre>
</div>
</div>
</li>

<li><a id="sec-2-2-8-0-0-4" name="sec-2-2-8-0-0-4"></a>Make Group Spectral Files<br  /><div class="outline-text-7" id="text-2-2-8-0-0-4">
<p>
If there was pileup the following is run. Note this should be entered
line by line not in one go to avoid clashes.
</p>

<div class="org-src-container">

<pre class="src src-sh">grppha
source_pi_NoBore.fits      ! input spectrum file name
spectrum_pi_grp.fits  ! output grouped spectrum
bkg_pi.fits           ! include the background spectrum
source_rmf_NoBore.fits         ! include the RMF
source_arf_NoBore6.fits          ! include the ARF
group min 25                         ! group the data by 25 counts/bin
<span style="color: #a020f0;">exit</span>
</pre>
</div>

<p>
If there was no pileup the following is used.
</p>
<div class="org-src-container">

<pre class="src src-sh">grppha
source_pi_WithBore.fits      ! input spectrum file name
spectrum_pi_grp.fits  ! output grouped spectrum
bkg_pi.fits           ! include the background spectrum
source_rmf_WithBore.fits         ! include the RMF
source_arf_WithBore.fits          ! include the ARF
group min 25                         ! group the data by 25 counts/bin
<span style="color: #a020f0;">exit</span>
</pre>
</div>
</div>
</li>

<li><a id="sec-2-2-8-0-0-5" name="sec-2-2-8-0-0-5"></a>Plot the spectrum<br  /><div class="outline-text-7" id="text-2-2-8-0-0-5">
<p>
Plot as below. The spectrum is compared to a simple powerlaw model.
</p>

<p>
With pileup:
</p>
<div class="org-src-container">

<pre class="src src-sh">isis
<span style="color: #a0522d;">d</span>=load_data(<span style="color: #8b2252;">"spectrum_pi_grp.fits"</span>);
<span style="color: #a0522d;">r</span>=load_rmf(<span style="color: #8b2252;">"source_rmf_NoBore.fits"</span>);
<span style="color: #a0522d;">a</span>=load_arf(<span style="color: #8b2252;">"source_arf_NoBore.fits"</span>);
assign_rsp(a,r,d);
define_back(d, <span style="color: #8b2252;">"bkg_pi.fits"</span>);
fit_fun(<span style="color: #8b2252;">"powerlaw"</span>);
rebin_data(1, 10);
xnotice_en(d, 1, 10.0);
set_par(2, 2.0);
fancy_plot_unit(&#8220;keV&#8221;);
()=fit_counts;
popt.xrange = [1, 10.0];
popt.yrange = [1.0e-6, 1.0, -10.0, 10.0];
popt.dsym = 1;
popt.res = 1;
xlog;
ylog;
title (<span style="color: #8b2252;">"GX339-4 OBSID Spectrum"</span>);
plot_data(d, popt; <span style="color: #a0522d;">dsym</span>=1);
</pre>
</div>

<p>
or in the case of no pileup
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n PLOT SPECTRUM \n\n\n'</span>
isis
<span style="color: #a0522d;">d</span>=load_data(<span style="color: #8b2252;">"spectrum_pi_grp.fits"</span>);
<span style="color: #a0522d;">r</span>=load_rmf(<span style="color: #8b2252;">"source_rmf_WithBore.fits"</span>);
<span style="color: #a0522d;">a</span>=load_arf(<span style="color: #8b2252;">"source_arf_WithBore.fits"</span>);
assign_rsp(a,r,d);
define_back(d, <span style="color: #8b2252;">"bkg_pi.fits"</span>);
fit_fun(<span style="color: #8b2252;">"powerlaw"</span>);
rebin_data(1, 10);
xnotice_en(d, 1, 10.0);
set_par(2, 2.0);
fancy_plot_unit(&#8220;keV&#8221;);
()=fit_counts;
popt.xrange = [1, 10.0];
popt.yrange = [1.0e-6, 1.0, -10.0, 10.0];
popt.dsym = 1;
popt.res = 1;
xlog;
ylog;
title (<span style="color: #8b2252;">"GX339-4 OBSID Spectrum"</span>);
plot_data(d, popt; <span style="color: #a0522d;">dsym</span>=1);
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-2-2-9" class="outline-4">
<h4 id="sec-2-2-9"><span class="section-number-4">2.2.9</span> Lag-Frequency Script</h4>
<div class="outline-text-4" id="text-2-2-9">
<pre class="example">
%declare observation ID's
variable obs_id = ["0654130401"];


variable i;
variable j;
variable k;

%declare frequency bins
variable n_bins =29;
variable df_f = 0.45/1.1; %Possibly change bin size to be bigger to exactly emulate DeMarco2015 results.
variable lo = Double_Type[n_bins];
variable hi = Double_Type[n_bins];
lo[0]=0.007;
hi[0]=(lo[0] + lo[0]*df_f);

for(i=1;i&lt;n_bins;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
 }

%logarithmic frequency bin centre
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));

%declare arrays
variable rb_n = Integer_Type[n_bins];
variable lag = Double_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){


%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));

%Pass to new variables:
variable time_soft = lc_soft.time[ix_soft];
variable time_hard = lc_hard.time[ix_hard];
variable rate_soft = lc_soft.rate[ix_soft];
variable rate_hard = lc_hard.rate[ix_hard];
variable error_soft = lc_soft.error[ix_soft];
variable error_hard = lc_hard.error[ix_hard];

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[0:length(dft_soft)-1]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);
variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

%Calculate and sum CPS for each frequency bin in each observation.
for(i=0; i&lt; n_bins; i++)
{
        for (j=0; j&lt;length(freq); j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {
                        g_a_real[i] += abs(dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[i] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[i] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];
                        g_c[i] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];
                        rb_n[i] ++;
                }
        }
}
}

%Plot variables including frequency error bars
variable x = (hi+lo)/2;
variable dxp = hi-x;
variable dxm = x-lo;

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0;i&lt;n_bins;i++)
{
        %Lag error
        g_a[i] = (g_a_real[i]*g_a_real[i] + g_a_imag[i]*g_a_imag[i])/(double(rb_n[i])*double(rb_n[i]));
        g_b[i] /= double(rb_n[i]);
        g_c[i] /= double(rb_n[i]);
        g[i] = g_a[i]/(g_b[i]*g_c[i]);
        delta_phi[i] = sqrt((1.0-g[i])/(2.0*g[i]))/sqrt(double(rb_n[i]));
        delta_lag[i] = delta_phi[i]/(2.0*PI*rb_freq[i]);

        %Lag
        g_a_real[i] /= rb_n[i];
        g_a_imag[i] /= rb_n[i];
        lag[i] = atan2(g_a_imag[i] , g_a_real[i])/(2.0*PI*rb_freq[i]);
}

% Plot results:

open_plot("lagfreq.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0654130401 lag-frequency &gt;7e-3 Hz");
connect_points(0);

plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4,dsym=6, xrange=[3e-3,10], yrange=[0.0001,1]);
_pgmove(-10000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

for (i=0; i&lt;length(x); i++) {
  () = printf("%e,%e,%e\n", x[i], lag[i], delta_lag[i]);
}

close_plot;
</pre>
</div>
</div>
<div id="outline-container-sec-2-2-10" class="outline-4">
<h4 id="sec-2-2-10"><span class="section-number-4">2.2.10</span> Lag-Energy Scripts</h4>
<div class="outline-text-4" id="text-2-2-10">
</div><ol class="org-ol"><li><a id="sec-2-2-10-0-0-1" name="sec-2-2-10-0-0-1"></a>Setup Script<br  /><div class="outline-text-7" id="text-2-2-10-0-0-1">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python</span>
<span style="color: #a020f0;">import</span> os
<span style="color: #a0522d;">i</span>=0
<span style="color: #b22222;">#</span><span style="color: #b22222;">Enter energy bands here</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">band = [300,350,400,500,600,700,800,1000,1300,1600,2000,2400,3000,4000,5000,6000,7000,10000]</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">band = [300,400,500,600,800,1000,1300,2000,3000,4000,5000,7000,10000]</span>
<span style="color: #a0522d;">band</span> = [500,750,900,980,1000,1100,1200,1300,1400,1600,1700,1800,1900,2000,2100,2200,2400,2600,2750,2850,3000,3050,3300,3600,3900,4000,4300,4550,4800,5300,5850,6600,6700,7500,8000,8600,9200]
<span style="color: #a0522d;">number_bands</span> = (<span style="color: #483d8b;">len</span>(band)-1)

<span style="color: #a0522d;">min1</span> = <span style="color: #8b2252;">'31'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">Set source coordinates.</span>
<span style="color: #a0522d;">max1</span> = <span style="color: #8b2252;">'45'</span>
<span style="color: #a0522d;">minmax1</span> = <span style="color: #8b2252;">'['</span>+min1+<span style="color: #8b2252;">':'</span>+max1+<span style="color: #8b2252;">']'</span>

<span style="color: #a0522d;">min2</span> = <span style="color: #8b2252;">'3'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">Set background coordinates.</span>
<span style="color: #a0522d;">max2</span> = <span style="color: #8b2252;">'5'</span>
<span style="color: #a0522d;">minmax2</span> = <span style="color: #8b2252;">'['</span>+min2+<span style="color: #8b2252;">':'</span>+max2+<span style="color: #8b2252;">']'</span>

<span style="color: #a020f0;">while</span>(i &lt; number_bands):
    os.system(<span style="color: #8b2252;">"echo 'Running band "</span> + <span style="color: #483d8b;">repr</span>(band[i]) + <span style="color: #8b2252;">"-"</span> + <span style="color: #483d8b;">repr</span>(band[i+1]) + <span style="color: #8b2252;">"eV.'"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">Energy filters</span>
    os.system(<span style="color: #8b2252;">"evselect table=EPICclean.fits withfilteredset=yes filteredset=PN_time_reference.fits filtertype=expression expression='(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in ["</span> + <span style="color: #483d8b;">repr</span>(band[0])  + <span style="color: #8b2252;">":"</span> + <span style="color: #483d8b;">repr</span>(band[i]) + <span style="color: #8b2252;">"],["</span> + <span style="color: #483d8b;">repr</span>(band[i+1]) + <span style="color: #8b2252;">":"</span> + <span style="color: #483d8b;">repr</span>(band[number_bands]) + <span style="color: #8b2252;">"])&amp;&amp;#XMMEA_EP' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=EPICclean.fits withfilteredset=yes filteredset=PN_time_narrow.fits filtertype=expression expression='(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in ["</span> +  <span style="color: #483d8b;">repr</span>(band[i]) + <span style="color: #8b2252;">":"</span> + <span style="color: #483d8b;">repr</span>(band[i+1]) +<span style="color: #8b2252;">"])&amp;&amp;#XMMEA_EP' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">Source extraction - NOTE BLANK CIRCLES</span>
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_reference.fits  withfilteredset=yes filteredset=PN_time_reference_src.fits filtertype=expression expression='RAWX in "</span>+minmax1+<span style="color: #8b2252;">"' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_narrow.fits  withfilteredset=yes filteredset=PN_time_narrow_src.fits filtertype=expression expression='RAWX in "</span>+minmax1+<span style="color: #8b2252;">"' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">Background extraction - NOTE BLANK CIRCLES</span>
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_reference.fits withfilteredset=yes filteredset=PN_time_reference_bkg.fits filtertype=expression expression='RAWX in "</span>+minmax2+<span style="color: #8b2252;">"' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_narrow.fits  withfilteredset=yes filteredset=PN_time_narrow_bkg.fits filtertype=expression expression='RAWX in "</span>+minmax2+<span style="color: #8b2252;">"' keepfilteroutput=yes updateexposure=yes filterexposure=yes &amp;&gt; /dev/null"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">Create light curves</span>
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_reference_src.fits withrateset=yes rateset=PN_time_reference_src_lc.fits maketimecolumn=yes timecolumn=TIME timebinsize=0.01 makeratecolumn=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_narrow_src.fits withrateset=yes rateset=PN_time_narrow_src_lc.fits maketimecolumn=yes timecolumn=TIME timebinsize=0.01 makeratecolumn=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_reference_bkg.fits withrateset=yes rateset=PN_time_reference_bkg_lc.fits maketimecolumn=yes timecolumn=TIME timebinsize=0.01 makeratecolumn=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"evselect table=PN_time_narrow_bkg.fits withrateset=yes rateset=PN_time_narrow_bkg_lc.fits maketimecolumn=yes timecolumn=TIME timebinsize=0.01 makeratecolumn=yes &amp;&gt; /dev/null"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">Epic light curve correction</span>
    os.system(<span style="color: #8b2252;">"epiclccorr srctslist=PN_time_reference_src_lc.fits eventlist=EPICclean.fits outset=reference_"</span> + <span style="color: #483d8b;">repr</span>(band[i]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">repr</span>(band[i+1]) +<span style="color: #8b2252;">"_lccorr.fits bkgtslist=PN_time_reference_bkg_lc.fits withbkgset=yes applyabsolutecorrections=yes &amp;&gt; /dev/null"</span>)
    os.system(<span style="color: #8b2252;">"epiclccorr srctslist=PN_time_narrow_src_lc.fits eventlist=EPICclean.fits outset=narrow_"</span> + <span style="color: #483d8b;">repr</span>(band[i]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">repr</span>(band[i+1]) + <span style="color: #8b2252;">"_lccorr.fits bkgtslist=PN_time_narrow_bkg_lc.fits withbkgset=yes applyabsolutecorrections=yes &amp;&gt; /dev/null"</span>)
    <span style="color: #a0522d;">i</span>=i+1
</pre>
</div>
</div>
</li>
<li><a id="sec-2-2-10-0-0-2" name="sec-2-2-10-0-0-2"></a>Plotting Script for selecting specific frequencies<br  /><div class="outline-text-7" id="text-2-2-10-0-0-2">
<pre class="example">
%declare observation ID's
variable obs_id = ["0605610201"];

%declare energy band edges
%variable band = [300,350,400,500,600,700,800,1000,1300,1600,2000,2400,3000,4000,5000,6000,7000,10000];

%variable band = [300,400,500,600,800,1000,1300,2000,3000,4000,5000,7000,10000];

variable band = [500,750,900,980,1000,1100,1200,1300,1400,1600,1700,1800,1900,2000,2100,2200,2400,2600,2750,2850,3000,3050,3300,3600,3900,4000,4300,4550,4800,5300,5850,6600,6700,7500,8000,8600,9200];

variable number_bands = length(band)-1;
variable i;
variable k;
variable j;

%Declare arrays
variable g_a_real = Double_Type[number_bands];
variable g_a_imag = Double_Type[number_bands];
variable g_a = Double_Type[number_bands];
variable g_b = Double_Type[number_bands];
variable g_c = Double_Type[number_bands];
variable g = Double_Type[number_bands];
variable delta_phi = Double_Type[number_bands];
variable delta_lag = Double_Type[number_bands];
variable lag = Double_Type[number_bands];

%Set frequency range interested in
variable lo = 0.8;
variable hi = 2;


%Logarithmic centre of frequency bin
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));

%counts CPS for each binlag_en_script.sl
variable rb_n = Integer_Type[number_bands];

%Define energy bins
variable elo = Double_Type[number_bands];
variable ehi = Double_Type[number_bands];

for(i=0; i&lt;number_bands;i++){
        elo[i] =  band[i];
        ehi[i] = band[i+1];
}


%loop through observations
for(k=0; k&lt;length(obs_id); k++){

%change to appropriate directory for observation

variable fn_r;
variable fn_n;

%loop through energy bands
for(i=0; i&lt;number_bands; i++){

%read in fits file - MAKE SURE FILE NAMES MATCH
fn_r = sprintf("reference_%i_%i_lccorr.fits",band[i],band[i+1]);
fn_n = sprintf("narrow_%i_%i_lccorr.fits",band[i],band[i+1]);

variable lc_reference = fits_read_table(fn_r);
variable lc_narrow = fits_read_table(fn_n);

%exclude non-numbers:
variable ix_reference = where(not isnan(lc_reference.rate));
variable ix_narrow = where(not isnan(lc_narrow.rate));

% Pass to new variables:
variable time_reference = lc_reference.time[ix_reference];
variable time_narrow = lc_narrow.time[ix_narrow];
variable rate_reference = lc_reference.rate[ix_reference];
variable rate_narrow = lc_narrow.rate[ix_narrow];
variable error_reference = lc_reference.error[ix_reference];
variable error_narrow = lc_narrow.error[ix_narrow];

% Compute reference dft:
variable dft_reference = fft(rate_reference,-1);
variable freq = [[0:length(dft_reference)-1]]/(double(length(dft_reference))*(time_reference[1]-time_reference[0]));
variable dft_real_reference = Real(dft_reference[[0:length(freq)-1]]);
variable dft_imag_reference = Imag(dft_reference[[0:length(freq)-1]]);

% Compute narrow dft:
variable dft_narrow = fft(rate_narrow,-1);
variable dft_real_narrow = Real(dft_narrow[[0:length(freq)-1]]);
variable dft_imag_narrow = Imag(dft_narrow[[0:length(freq)-1]]);

% Calculate CPS in the frequency range [lo,hi] for each energy bin [i], summing across observations.
for (j=0; j&lt;length(freq); j++){
if(freq[j] &gt; lo &amp;&amp; freq[j] &lt;= hi)
                {
                        g_a_real[i] += dft_real_reference[j]*dft_real_narrow[j] + dft_imag_reference[j]*dft_imag_narrow[j];
                        g_a_imag[i] += dft_real_narrow[j]*dft_imag_reference[j]-dft_real_reference[j]*dft_imag_narrow[j];
                        g_b[i] += dft_real_reference[j]*dft_real_reference[j] + dft_imag_reference[j]*dft_imag_reference[j];
                        g_c[i] += dft_real_narrow[j]*dft_real_narrow[j] + dft_imag_narrow[j]*dft_imag_narrow[j];
                        rb_n[i] ++;
                }

}
}
}

variable x = (ehi+elo)/2;
variable dxp = ehi-x;
variable dxm = x-elo;

%Average the CPS for each energy bin for all observations. Calculate coherence, g[i], for each energy bin.
for(i=0; i&lt;number_bands; i++){
        %Lag error
        g_a[i] = (g_a_real[i]*g_a_real[i] + g_a_imag[i]*g_a_imag[i])/(double(rb_n[i])*double(rb_n[i]));
        g_b[i] /= double(rb_n[i]);
        g_c[i] /= double(rb_n[i]);
        g[i] = g_a[i]/(g_b[i]*g_c[i]);
        delta_phi[i] = sqrt((1.0-g[i])/(2.0*g[i]))/sqrt(double(rb_n[i]));
        delta_lag[i] = delta_phi[i]/(2.0*PI*rb_freq);

        %Lag
        g_a_real[i] /= rb_n[i];
        g_a_imag[i] /= rb_n[i];
        lag[i] = atan2(g_a_imag[i] , g_a_real[i])/(2.0*PI*rb_freq);

}

open_plot("lagen_0.8-2Hz.gif/gif");
xlog;
ylin;
xlabel("Energy (eV)");
ylabel("Time Lag (s)");
title("GX339-4 0654130401 lag-energy 0.8-2 Hz");
connect_points(0);
_pgsfs(3);
plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=2, dsym=6, xrange=[300,11000], yrange=[-0.02,0.02]);
_pgmove(300,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

for (i=0; i&lt;length(x); i++) {
  () = printf("%e,%e,%e\n", x[i], lag[i], delta_lag[i]);
}
close_plot;
</pre>
</div>
</li></ol>
</div>
<div id="outline-container-sec-2-2-11" class="outline-4">
<h4 id="sec-2-2-11"><span class="section-number-4">2.2.11</span> Segment Analysis Script</h4>
<div class="outline-text-4" id="text-2-2-11">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">This python program runs the Epitropakis method for analysis of scripts. After this the time lag</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">To run, arguments should be supplied in the order, OBSID, Obs start time, Obs end time and Number of Segments Required. e.g. python segment_analysis.py 0605610201 000000000 999999999 10.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">This MUST be located in the same folder as the other observation IDs are when executed.</span>

<span style="color: #a020f0;">import</span> os,sys

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">main</span>(argv):
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(sys.argv)&lt;4:
               <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">'Add more arguments. Should be in the form:  ObservationID, Observation Start Time, Observation End Time and Number of Segments'</span>
               sys.<span style="color: #008b8b;">exit</span>(2)

        <span style="color: #a0522d;">ObservationID</span> = <span style="color: #483d8b;">int</span>(sys.argv[1]) <span style="color: #b22222;"># </span><span style="color: #b22222;">Import the arguments</span>
        <span style="color: #a0522d;">StartTime</span> = <span style="color: #483d8b;">int</span>(sys.argv[2])
        <span style="color: #a0522d;">EndTime</span> = <span style="color: #483d8b;">int</span>(sys.argv[3])
        <span style="color: #a0522d;">NumberOfSegments</span> = <span style="color: #483d8b;">int</span>(sys.argv[4])

        <span style="color: #a0522d;">TotalTime</span> = EndTime-StartTime <span style="color: #b22222;"># </span><span style="color: #b22222;">Use the times to work out how long each segment will last for</span>
        <span style="color: #a0522d;">AverageSegmentTime</span> = <span style="color: #483d8b;">int</span>(TotalTime/NumberOfSegments)
        <span style="color: #a0522d;">ExtraTime</span> = TotalTime - AverageSegmentTime*NumberOfSegments <span style="color: #b22222;"># </span><span style="color: #b22222;">Calculates if rounding would cause some time to omitted in the analysis.</span>
        <span style="color: #a0522d;">StringNumberOfSegments</span> = <span style="color: #483d8b;">str</span>(NumberOfSegments) <span style="color: #b22222;"># </span><span style="color: #b22222;">Useful to have this as a string later on.</span>

        <span style="color: #a020f0;">for</span> SegmentNumber <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(0,NumberOfSegments): <span style="color: #b22222;"># </span><span style="color: #b22222;">This now begins the analysis for each segment.</span>

            <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Working on Segment"</span>,SegmentNumber

            <span style="color: #a020f0;">if</span> SegmentNumber != NumberOfSegments: <span style="color: #b22222;"># </span><span style="color: #b22222;">Calculate the segment start and end time.</span>
                <span style="color: #a0522d;">SegmentStartTime</span> = StartTime + (SegmentNumber*AverageSegmentTime)
                <span style="color: #a0522d;">SegmentEndTime</span> = SegmentStartTime + AverageSegmentTime
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a0522d;">SegmentStartTime</span> = StartTime + (SegmentNumber*AverageSegmentTime) + ExtraTime
                <span style="color: #a0522d;">SegmentEndTime</span> = SegmentStartTime + AverageSegmentTime
            <span style="color: #a0522d;">StringObservationID</span> = <span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">str</span>(0)+<span style="color: #483d8b;">str</span>(ObservationID)) <span style="color: #b22222;"># </span><span style="color: #b22222;">When stored as an int the Observation ID loses its initial 0 so this is added.</span>
            <span style="color: #a0522d;">StringSegmentNumber</span> = <span style="color: #483d8b;">str</span>(SegmentNumber)

            os.system(<span style="color: #8b2252;">"mkdir 0%d/seg%d"</span> % (ObservationID,SegmentNumber)) <span style="color: #b22222;"># </span><span style="color: #b22222;">Create the segment root folder</span>

            <span style="color: #a0522d;">f1</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"/data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/SegmentAnalysisTemplateGeneral.tsh"</span>,<span style="color: #8b2252;">"r"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Opens a segment analysis template file.</span>
            <span style="color: #a0522d;">f2</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"0"</span>+<span style="color: #483d8b;">str</span>(ObservationID)+<span style="color: #8b2252;">"/seg"</span>+<span style="color: #483d8b;">str</span>(SegmentNumber)+<span style="color: #8b2252;">"/SegmentAnalysis.tsh"</span>,<span style="color: #8b2252;">"w"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Opens a local version which will be run.</span>
            <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f1: <span style="color: #b22222;"># </span><span style="color: #b22222;">For each line in the template file...</span>
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTSTARTTIME"</span>,<span style="color: #483d8b;">str</span>(SegmentStartTime)) <span style="color: #b22222;">#</span><span style="color: #b22222;">... any instance of the Caps words is replaced with the actual variable.</span>
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTENDTIME"</span>,<span style="color: #483d8b;">str</span>(SegmentEndTime))
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"OBSERVATIONID"</span>,StringObservationID)
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"ROOTPATH"</span>,<span style="color: #483d8b;">str</span>(os.getcwd()))
                f2.write(line)
            f1.close()
            f2.close()

            os.chdir(<span style="color: #8b2252;">"0%d/seg%d/"</span> % (ObservationID,SegmentNumber)) <span style="color: #b22222;"># </span><span style="color: #b22222;">The script moves into the folder with the .tsh script in, and runs it, then moves out again.</span>
            os.system(<span style="color: #8b2252;">"tcsh "</span>+<span style="color: #483d8b;">str</span>(os.getcwd())+<span style="color: #8b2252;">"/0%d/seg%d/SegmentAnalysis.tsh"</span> % (ObservationID,SegmentNumber))
            os.chdir(<span style="color: #8b2252;">"../../"</span>)

        <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"The light curves have been produced for each segment.\n"</span>

        <span style="color: #a0522d;">f1</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"/data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/lagfreq_cohfreq_script_template.sl"</span>,<span style="color: #8b2252;">"r"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Open the Epitropakis lag-frequency method template file.</span>
        <span style="color: #a0522d;">f2</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"0"</span>+<span style="color: #483d8b;">str</span>(ObservationID)+<span style="color: #8b2252;">"/lagfreq_cohfreq_script.sl"</span>,<span style="color: #8b2252;">"w"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Create a local copy</span>
        <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f1:
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"OBSERVATIONID"</span>,StringObservationID)
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTNUMBER"</span>,StringNumberOfSegments)
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"ROOTPATH"</span>,<span style="color: #483d8b;">str</span>(os.getcwd()))
             f2.write(line)
        f1.close()
        f2.close()


        <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"The file to calculate coherence (nntest_lagfreq.sl) for observation "</span>+StringObservationID+<span style="color: #8b2252;">" and "</span>+StringNumberOfSegments+<span style="color: #8b2252;">" segments has been generated in the observation ID root folder.\n\nThis should be called manually once the segment folders have been checked using: isis nntest_lagfreq.sl\n"</span>


<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">"__main__"</span>:
        main(sys.argv[4:])
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-2-12" class="outline-4">
<h4 id="sec-2-2-12"><span class="section-number-4">2.2.12</span> Coherence Analysis Script</h4>
<div class="outline-text-4" id="text-2-2-12">
<pre class="example">
%declare observation ID's
variable obs_id = ["0654130401"];

variable obs_segs = [20];

variable i;
variable j;
variable k;
variable n;

% declare frequency bins
variable re_bin_f = 38; % with binninng
variable df_f = 0.2;
variable lo_bin_f = 7e-2;

%declare the number of frequency bins
variable n_bins = 15000; % without binning

%declare arrays
variable lag = Double_Type[n_bins];
variable rb_n = Integer_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_real_2 = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_a_2 = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable coh = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];
variable delta_coh = Double_Type[n_bins];

variable seg_length = 20000;
variable seg_min = 20000;

for(k=0; k&lt;length(obs_id); k++){
        for (n=0; n&lt;obs_segs[k]; n++)
        {
                () = chdir("/data/cluster/XRayReverb2016/HarryData/GX339-4/"+obs_id[k] + sprintf("/seg%i", n));
                variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
                variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");
                variable ix_soft = where(not isnan(lc_soft.rate));
                variable ix_hard = where(not isnan(lc_hard.rate));

                if(length(ix_soft) &lt; seg_min)
                {
                        seg_length = length(ix_soft);
                }
                seg_min = seg_length;
                vmessage("check data: " + obs_id[k] + sprintf("/seg%i", n) + sprintf("  length= %i",  length(ix_soft)));
        }
}
vmessage("****set seg_length =%i", seg_length);

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){
for (n=0; n&lt;obs_segs[k]; n++){

() = chdir( "/data/cluster/XRayReverb2016/HarryData/GX339-4/" +obs_id[k] + sprintf("/seg%i", n));
%vmessage( obs_id[k] + sprintf("/seg%i", n));

%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));
variable rate_soft = Double_Type[seg_length];
variable rate_hard = Double_Type[seg_length];
variable time_soft = Double_Type[seg_length];
variable time_hard = Double_Type[seg_length];
variable error_soft = Double_Type[seg_length];
variable error_hard = Double_Type[seg_length];

%Pass to new variables:
variable o_time_soft = lc_soft.time[ix_soft];
variable o_time_hard = lc_hard.time[ix_hard];
variable o_rate_soft = lc_soft.rate[ix_soft];
variable o_rate_hard = lc_hard.rate[ix_hard];
variable o_error_soft = lc_soft.error[ix_soft];
variable o_error_hard = lc_hard.error[ix_hard];

for(j=0; j&lt;seg_length; j++)
{
        rate_soft[j] = o_rate_soft[j];
        rate_hard[j] = o_rate_hard[j];
        time_soft[j] = o_time_soft[j];
        time_hard[j] = o_time_hard[j];
        error_soft[j] = o_error_soft[j];
        error_hard[j] = o_error_hard[j];


}

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[1:length(dft_soft)]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);

variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

% Adjust frequency bins
variable x = Double_Type[n_bins];
variable dxp = Double_Type[n_bins];
variable dxm = Double_Type[n_bins];
for(i=1;i&lt;n_bins;i++)
{
        x[i] = freq[i];
        dxp[i] = (freq[i+1] - x[i])/2;
        dxm[i] = (x[i] - freq[i-1])/2;
}

variable lo = Double_Type[re_bin_f];
variable hi = Double_Type[re_bin_f];
lo[0]=lo_bin_f;
hi[0]=(lo[0] + lo[0]*df_f);
for(i=1;i&lt;re_bin_f;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
}
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));
variable x_bin = (hi+lo)/2;
variable dxp_bin = hi-x_bin;
variable dxm_bin = x_bin-lo;

%Calculate and sum CPS for each frequency bin in each observation.
for(j=0; j&lt; n_bins; j++)
{
                        %() = printf("j= %i freq= %e\n", j, freq[j]);
                        g_a_real[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_real_2[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[j] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[j] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];	% Periodrogram s
                        g_c[j] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];	% Periodrogram h
                        rb_n[j] ++;
                
}
}
}

%Plot variables including frequency error bars
for(j=0; j&lt; n_bins; j++)
{
        g_a_real[j] = g_a_real[j]/rb_n[j];
        g_a_real_2[j] = g_a_real_2[j] /rb_n[j];
        g_a_imag[j] = g_a_imag[j]/rb_n[j];
        g_a[j] = (g_a_real[j]*g_a_real[j] + g_a_imag[j]*g_a_imag[j]);
        g_a_2[j] = (g_a_real_2[j]*g_a_real_2[j] + g_a_imag[j]*g_a_imag[j]);
        g_b[j] = g_b[j]/rb_n[j];
        g_c[j] = g_c[j]/rb_n[j];
        g[j] = g_a[j]/(g_b[j]*g_c[j]);
        coh[j] = g_a_2[j]/(g_b[j]*g_c[j]);
        delta_phi[j] = sqrt((1.0-g[j])/(2.0*g[j]))/sqrt(double(rb_n[j]));	
        delta_lag[j] = delta_phi[j]/(2.0*PI*freq[j]);
        delta_coh[j] = 0.0; 

        lag[j] = atan2(g_a_imag[j] , g_a_real[j])/(2.0*PI*freq[j]);
}


variable fb_n = Integer_Type[re_bin_f];
variable n_est = Integer_Type[re_bin_f];

variable lag_bin = Double_Type[re_bin_f];
variable g_a_real_bin = Double_Type[re_bin_f];
variable g_a_real_2_bin = Double_Type[re_bin_f];
variable g_a_imag_bin = Double_Type[re_bin_f];
variable g_a_bin = Double_Type[re_bin_f];
variable g_a_2_bin = Double_Type[re_bin_f];
variable g_b_bin = Double_Type[re_bin_f];
variable g_c_bin = Double_Type[re_bin_f];
variable g_bin = Double_Type[re_bin_f];
variable delta_phi_bin = Double_Type[re_bin_f];
variable delta_lag_bin = Double_Type[re_bin_f];
variable delta_coh_bin = Double_Type[re_bin_f];

for(i=0; i&lt; re_bin_f; i++)
{
        for (j=0; j&lt;n_bins; j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {
                        g_a_real_bin[i] += g_a_real[j];
                        g_a_real_2_bin[i] += g_a_real_2[j];
                        g_a_imag_bin[i] += g_a_imag[j];
                        g_b_bin[i] += g_b[j];
                        g_c_bin[i] += g_c[j];
                        fb_n[i]++;
                        n_est[i] += rb_n[j];
                }
        }
}

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0; i&lt;re_bin_f; i++)
{
        %Lag error
        g_a_real_bin[i] /= fb_n[i];
        g_a_imag_bin[i] /= fb_n[i];
        g_a_bin[i] = (g_a_real_bin[i]*g_a_real_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_a_2_bin[i] = (g_a_real_2_bin[i]*g_a_real_2_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_b_bin[i] /= double(fb_n[i]);
        g_c_bin[i] /= double(fb_n[i]);
        g_bin[i] = g_a_bin[i]/(g_b_bin[i]*g_c_bin[i]);
        delta_phi_bin[i] = sqrt((1.0-g_bin[i])/(2.0*g_bin[i]))/sqrt(double(n_est[i]));	
        delta_lag_bin[i] = delta_phi_bin[i]/(2.0*PI*rb_freq[i]);
        lag_bin[i] = atan2(g_a_imag_bin[i] , g_a_real_bin[i])/(2.0*PI*rb_freq[i]);
}


() = chdir( "/data/cluster/XRayReverb2016/HarryData/GX339-4/"+obs_id[0] );

% Plot coherence results:

open_plot("CoherenceFrequency.gif/gif");

%window(1);
xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Coherence");
title("GX339-4 0654130401 Coherence");
connect_points(0);
_pgsfs(3);

plotxy(x,dxm,dxp,coh,delta_coh,delta_coh; dcol=1, decol=4, dsym=6, xrange=[3e-1,10],yrange=[0.1,2]);	% coherence

_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

%Coherence value (horzontal) line
_pgmove(-1, log10(1.2/(1+(0.2*obs_segs[0]))));
_pgsls(3); % line style?
_pgsci(3); % colour 1- black, 2-red, 3 - green
_pgslw(4); % line width?
_pgdraw(1.3, log10(1.2/(1+(0.2*obs_segs[0]))));

% Vertical max freq line
_pgmove(log10(4), log10(1e-4) );
_pgsls(2);
_pgsci(2);
_pgslw(4);
_pgdraw(log10(4), log10(1e2));

close_plot;

%Display the lag-freq values
for (i=0; i&lt;re_bin_f; i++) {
  () = printf("%e,  %e,  %e\n", x_bin[i], lag_bin[i], delta_lag[i]);
}



% Plot binned Lag-freq results:
%window(1);

open_plot("EpitropakisLagFrequency.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0654130401 Lag-Frequency");
connect_points(0);
_pgsfs(3);

plotxy(x_bin,dxm_bin,dxp_bin,lag_bin,delta_lag_bin,delta_lag_bin; dcol=1, decol=4, dsym=6,  xrange=[3e-3,10],yrange=[1e-4,1]);	% binned f lags
_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

% Vertical max freq line
_pgmove(log10(4), log10(1e-4) );
_pgsls(2);
_pgsci(2);
_pgslw(4);
_pgdraw(log10(4), log10(1e2));


close_plot;

% Plot unbinned Lag-freq results:
%window(1);

open_plot("EpitropakisUnbinnedLagFrequency.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0654130401 Unbinned Lag-Frequency");
connect_points(0);
_pgsfs(3);

%plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4, dsym=6, xrange=[3e-3,10],yrange=[1e-4,1]);	% unbinned f lags
_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

% Vertical max freq line
%_pgmove(-2.721,-1400); % 0.3-4k
%_pgmove(-3.284,-600); % 2-7k
%_pgsls(2);
%_pgsci(2);
%_pgslw(4);
%_pgdraw(-2.721,1400); % 0.3-4k
%_pgdraw(-3.284,600); % 2-7k

close_plot;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> 0204730201</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-sec-2-3-1" class="outline-4">
<h4 id="sec-2-3-1"><span class="section-number-4">2.3.1</span> Initial Processing</h4>
<div class="outline-text-4" id="text-2-3-1">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n Initial SAS setup, general for all files. Run in a suitable folder after replacing the OBSID'</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nDOWNLOAD TAR FILE...'</span>
curl -o 0204730201.tar <span style="color: #8b2252;">"http://nxsa.esac.esa.int/nxsa-sl/servlet/data-action-aio?obsno=0204730201&amp;level=ODF"</span>
tar -zxvf *.tar
tar -xvf *.TAR

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n file unpacked. Setup SAS'</span>

heainit
setsas
<span style="color: #483d8b;">setenv</span> SAS_CCFPATH /usr/local/XMM/ccf/
<span style="color: #483d8b;">setenv</span> SAS_ODF $<span style="color: #a0522d;">PWD</span>
cifbuild
<span style="color: #483d8b;">setenv</span> SAS_CCF ccf.cif
odfingest
<span style="color: #483d8b;">setenv</span> SAS_ODF $<span style="color: #a0522d;">PWD</span>/*SUM.SAS
cp ccf.cif ../PROC
cp *SUM.SAS ../PROC
<span style="color: #483d8b;">cd</span> ../PROC

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n MOVED TO PROC FOLDER. INITIALISING WORK'</span>

epproc <span style="color: #a0522d;">randomizetime</span>=no <span style="color: #a0522d;">randomizeposition</span>=no <span style="color: #a0522d;">randomizeenergy</span>=no

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nScript to process ODF data\n\n\n'</span>
cp *TimingEvts.ds PN.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Create a light curve.'</span>
evselect <span style="color: #a0522d;">table</span>=PN.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_flares_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timebinsize</span>=10 <span style="color: #a0522d;">makeratecolumn</span>=yes <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'#XMMEA_EP &amp;&amp; (PI&gt;10000&amp;&amp;PI&lt;12000) &amp;&amp; (PATTERN==0)'</span>
dsplot <span style="color: #a0522d;">table</span>=PN_flares_lc.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;
</pre>
</div>

<p>
At this point flares must be removed if they exist.
In this instance there were no flares so they were not removed.
</p>
</div>
</div>
<div id="outline-container-sec-2-3-2" class="outline-4">
<h4 id="sec-2-3-2"><span class="section-number-4">2.3.2</span> Flare removal</h4>
<div class="outline-text-4" id="text-2-3-2">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n no flares removed'</span>
cp PN.fits EPICclean.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n MAKE IMAGE...'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withimageset</span>=yes <span style="color: #a0522d;">imageset</span>=EPICclean_image.fits <span style="color: #a0522d;">xcolumn</span>=RAWX <span style="color: #a0522d;">ycolumn</span>=RAWY <span style="color: #a0522d;">imagebinning</span>=binSize <span style="color: #a0522d;">ximagebinsize</span>=1 <span style="color: #a0522d;">yimagebinsize</span>=1
ds9 EPICclean_image.fits &amp;
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\nImage created. Please note down a source and background range of pixels.'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-3-3" class="outline-4">
<h4 id="sec-2-3-3"><span class="section-number-4">2.3.3</span> Extract Source and Background Region</h4>
<div class="outline-text-4" id="text-2-3-3">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nSoft Filter\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in [500:1500])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nHard Filter\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in [2000:9000])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n Extract src and bg\n\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Source from Soft Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft_src.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [31:45]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Source from Hard Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard_src.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [31:45]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Background from Soft Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft_bkg.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [3:5]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Background from Hard Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard_bkg.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [3:5]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-3-4" class="outline-4">
<h4 id="sec-2-3-4"><span class="section-number-4">2.3.4</span> Make Light Curves</h4>
<div class="outline-text-4" id="text-2-3-4">
<p>
Note the time bin size here.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate Lightcurve from source\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from soft photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft_src.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_soft_src_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from hard photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard_src.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_hard_src_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from Background\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from soft photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft_bkg.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_soft_bkg_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from hard photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard_bkg.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_hard_bkg_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate Background Subtracted Light Curve\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nFrom soft photons (10 mins)\n'</span>
epiclccorr <span style="color: #a0522d;">srctslist</span>=PN_time_soft_src_lc.fits <span style="color: #a0522d;">eventlist</span>=EPICclean.fits <span style="color: #a0522d;">outset</span>=PN_time_soft_lccorr.fits <span style="color: #a0522d;">bkgtslist</span>=PN_time_soft_bkg_lc.fits <span style="color: #a0522d;">withbkgset</span>=yes <span style="color: #a0522d;">applyabsolutecorrections</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nFrom hard photons (10 mins)\n'</span>
epiclccorr <span style="color: #a0522d;">srctslist</span>=PN_time_hard_src_lc.fits <span style="color: #a0522d;">eventlist</span>=EPICclean.fits <span style="color: #a0522d;">outset</span>=PN_time_hard_lccorr.fits <span style="color: #a0522d;">bkgtslist</span>=PN_time_hard_bkg_lc.fits <span style="color: #a0522d;">withbkgset</span>=yes <span style="color: #a0522d;">applyabsolutecorrections</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Display the lightcurve'</span>

dsplot <span style="color: #a0522d;">table</span>=PN_time_soft_lccorr.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;
dsplot <span style="color: #a0522d;">table</span>=PN_time_hard_lccorr.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Note that the above lightcurves can be chopped with the evselect timemin and timemax command'</span>
</pre>
</div>

<p>
This observation is combined with another 2004 observation
(0204730301) so the plots are not shown here.
</p>
</div>
</div>
<div id="outline-container-sec-2-3-5" class="outline-4">
<h4 id="sec-2-3-5"><span class="section-number-4">2.3.5</span> Produce Lag-Frequency Plots</h4>
<div class="outline-text-4" id="text-2-3-5">
<p>
Begin by downloading a template
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"\n\n\nProduce lagfreq script\n\n\n"</span>
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/isis_lagfreq_script.sl .
emacs isis_lagfreq_script.sl &amp;
</pre>
</div>

<p>
Edit this file accordingly (update OBSID and frequency ranges if
necessary). Then run the file analysis in isis. The one used in this
case is shown in the following in a separate section <a href="#sec-2-3-7">here</a>.
</p>

<div class="org-src-container">

<pre class="src src-sh">isis isis_lagfreq_script.sl
<span style="color: #a020f0;">exit</span>;
</pre>
</div>

<p>
The output from this is shown in Figure <a href="#LagFreq">18</a>.
</p>


<div id="LagFreq" class="figure">
<p><img src="./0204730201/PROC/lagfreq.gif" alt="lagfreq.gif" />
</p>
<p><span class="figure-number">Figure 28:</span> The lag-frequency graph for 0204730201 GX339-4 observation</p>
</div>
</div>
</div>

<div id="outline-container-sec-2-3-6" class="outline-4">
<h4 id="sec-2-3-6"><span class="section-number-4">2.3.6</span> Epitropakis Methods</h4>
<div class="outline-text-4" id="text-2-3-6">
<p>
Following the analysis outlined by Epitropakis in Epitropakis 2016
(Theoretical modelling of the AGN iron-line/continuum time-lags in the
lamp-post geometry), we have calculated the lag frequencies in a new
way and also calculated the coherence. This is outlined below.
</p>

<p>
Initially it required splitting up the original observation into segments.
This would be time consuming to do manually so a python script which should do
this was developed in the section <a href="#sec-2-3-8">2.3.8</a>.
</p>

<p>
The python file should be run in the folder which contains the
observation ID folder. The scipt should be run with the observationID,
start time, end time and number of segments as arguments i.e.
</p>

<div class="org-src-container">

<pre class="src src-python">python run_segment_analysis.py 0605610201 354441000 354473000 2
</pre>
</div>

<p>
This generates segment directories (i.e. seg0,seg1) in the same folder
as the ODF and PROC folders are. In the segment directories a bash
script is created. The bash script performs all the filtering and
generates the light curves so will take a long time to run so should
be 'screened'.
</p>


<p>
The python script also outputs a modified lagfreq and coherence script
shown here: <a href="#sec-2-3-9">2.3.9</a>. This is placed with the PROC,
segX and ODF folders. This should be run to produce the lag frequency
and coherence files (as seen below) using the command:
</p>

<div class="org-src-container">

<pre class="src src-example">isis lagfreq_cohfreq_script.sl
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-2-3-6-1" name="sec-2-3-6-1"></a>Epitropakis Results<br  /><div class="outline-text-5" id="text-2-3-6-1">

<div id="EpitBLF" class="figure">
<p><img src="./0204730201/EpitropakisLagFrequency.gif" alt="EpitropakisLagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 29:</span> 0204730201 binned lag-frequency plot.</p>
</div>


<div id="EpitBLF" class="figure">
<p><img src="./0204730201/CoherenceFrequency.gif" alt="CoherenceFrequency.gif" />
</p>
<p><span class="figure-number">Figure 30:</span> 0204730201 coherence against frequency plot.</p>
</div>


<div id="EpitBLF" class="figure">
<p><img src="./0204730201/EpitropakisUnbinnedLagFrequency.gif" alt="EpitropakisUnbinnedLagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 31:</span> 0204730201 unbinned lag-frequency plot.</p>
</div>
</div>
</li></ol>
</div>
<div id="outline-container-sec-2-3-7" class="outline-4">
<h4 id="sec-2-3-7"><span class="section-number-4">2.3.7</span> Lag-Frequency Script</h4>
<div class="outline-text-4" id="text-2-3-7">
<pre class="example">
%declare observation ID's
variable obs_id = ["0204730201"];


variable i;
variable j;
variable k;

%declare frequency bins
variable n_bins =39;
variable df_f = 0.45/1.1; %Possibly change bin size to be bigger to exactly emulate DeMarco2015 results.
variable lo = Double_Type[n_bins];
variable hi = Double_Type[n_bins];
lo[0]=0.009;
hi[0]=(lo[0] + lo[0]*df_f);

for(i=1;i&lt;n_bins;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
 }

%logarithmic frequency bin centre
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));

%declare arrays
variable rb_n = Integer_Type[n_bins];
variable lag = Double_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){


%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));

%Pass to new variables:
variable time_soft = lc_soft.time[ix_soft];
variable time_hard = lc_hard.time[ix_hard];
variable rate_soft = lc_soft.rate[ix_soft];
variable rate_hard = lc_hard.rate[ix_hard];
variable error_soft = lc_soft.error[ix_soft];
variable error_hard = lc_hard.error[ix_hard];

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[0:length(dft_soft)-1]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);
variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

%Calculate and sum CPS for each frequency bin in each observation.
for(i=0; i&lt; n_bins; i++)
{
        for (j=0; j&lt;length(freq); j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {
                        g_a_real[i] += abs(dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[i] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[i] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];
                        g_c[i] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];
                        rb_n[i] ++;
                }
        }
}
}

%Plot variables including frequency error bars
variable x = (hi+lo)/2;
variable dxp = hi-x;
variable dxm = x-lo;

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0;i&lt;n_bins;i++)
{
        %Lag error
        g_a[i] = (g_a_real[i]*g_a_real[i] + g_a_imag[i]*g_a_imag[i])/(double(rb_n[i])*double(rb_n[i]));
        g_b[i] /= double(rb_n[i]);
        g_c[i] /= double(rb_n[i]);
        g[i] = g_a[i]/(g_b[i]*g_c[i]);
        delta_phi[i] = sqrt((1.0-g[i])/(2.0*g[i]))/sqrt(double(rb_n[i]));
        delta_lag[i] = delta_phi[i]/(2.0*PI*rb_freq[i]);

        %Lag
        g_a_real[i] /= rb_n[i];
        g_a_imag[i] /= rb_n[i];
        lag[i] = atan2(g_a_imag[i] , g_a_real[i])/(2.0*PI*rb_freq[i]);
}

% Plot results:

open_plot("lagfreq.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0204730201 lag-frequency &gt;7e-3 Hz");
connect_points(0);

plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4,dsym=6, xrange=[3e-3,10], yrange=[0.0001,1]);
_pgmove(-10000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

for (i=0; i&lt;length(x); i++) {
  () = printf("%e,%e,%e\n", x[i], lag[i], delta_lag[i]);
}

close_plot;
</pre>
</div>
</div>
<div id="outline-container-sec-2-3-8" class="outline-4">
<h4 id="sec-2-3-8"><span class="section-number-4">2.3.8</span> Segment Analysis Script</h4>
<div class="outline-text-4" id="text-2-3-8">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">This python program runs the Epitropakis method for analysis of scripts. After this the time lag</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">To run, arguments should be supplied in the order, OBSID, Obs start time, Obs end time and Number of Segments Required. e.g. python segment_analysis.py 0605610201 000000000 999999999 10.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">This MUST be located in the same folder as the other observation IDs are when executed.</span>

<span style="color: #a020f0;">import</span> os,sys

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">main</span>(argv):
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(sys.argv)&lt;4:
               <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">'Add more arguments. Should be in the form:  ObservationID, Observation Start Time, Observation End Time and Number of Segments'</span>
               sys.<span style="color: #008b8b;">exit</span>(2)

        <span style="color: #a0522d;">ObservationID</span> = <span style="color: #483d8b;">int</span>(sys.argv[1]) <span style="color: #b22222;"># </span><span style="color: #b22222;">Import the arguments</span>
        <span style="color: #a0522d;">StartTime</span> = <span style="color: #483d8b;">int</span>(sys.argv[2])
        <span style="color: #a0522d;">EndTime</span> = <span style="color: #483d8b;">int</span>(sys.argv[3])
        <span style="color: #a0522d;">NumberOfSegments</span> = <span style="color: #483d8b;">int</span>(sys.argv[4])

        <span style="color: #a0522d;">TotalTime</span> = EndTime-StartTime <span style="color: #b22222;"># </span><span style="color: #b22222;">Use the times to work out how long each segment will last for</span>
        <span style="color: #a0522d;">AverageSegmentTime</span> = <span style="color: #483d8b;">int</span>(TotalTime/NumberOfSegments)
        <span style="color: #a0522d;">ExtraTime</span> = TotalTime - AverageSegmentTime*NumberOfSegments <span style="color: #b22222;"># </span><span style="color: #b22222;">Calculates if rounding would cause some time to omitted in the analysis.</span>
        <span style="color: #a0522d;">StringNumberOfSegments</span> = <span style="color: #483d8b;">str</span>(NumberOfSegments) <span style="color: #b22222;"># </span><span style="color: #b22222;">Useful to have this as a string later on.</span>

        <span style="color: #a020f0;">for</span> SegmentNumber <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(0,NumberOfSegments): <span style="color: #b22222;"># </span><span style="color: #b22222;">This now begins the analysis for each segment.</span>

            <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Working on Segment"</span>,SegmentNumber

            <span style="color: #a020f0;">if</span> SegmentNumber != NumberOfSegments: <span style="color: #b22222;"># </span><span style="color: #b22222;">Calculate the segment start and end time.</span>
                <span style="color: #a0522d;">SegmentStartTime</span> = StartTime + (SegmentNumber*AverageSegmentTime)
                <span style="color: #a0522d;">SegmentEndTime</span> = SegmentStartTime + AverageSegmentTime
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a0522d;">SegmentStartTime</span> = StartTime + (SegmentNumber*AverageSegmentTime) + ExtraTime
                <span style="color: #a0522d;">SegmentEndTime</span> = SegmentStartTime + AverageSegmentTime
            <span style="color: #a0522d;">StringObservationID</span> = <span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">str</span>(0)+<span style="color: #483d8b;">str</span>(ObservationID)) <span style="color: #b22222;"># </span><span style="color: #b22222;">When stored as an int the Observation ID loses its initial 0 so this is added.</span>
            <span style="color: #a0522d;">StringSegmentNumber</span> = <span style="color: #483d8b;">str</span>(SegmentNumber)

            os.system(<span style="color: #8b2252;">"mkdir 0%d/seg%d"</span> % (ObservationID,SegmentNumber)) <span style="color: #b22222;"># </span><span style="color: #b22222;">Create the segment root folder</span>

            <span style="color: #a0522d;">f1</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"/data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/SegmentAnalysisTemplateGeneral.tsh"</span>,<span style="color: #8b2252;">"r"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Opens a segment analysis template file.</span>
            <span style="color: #a0522d;">f2</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"0"</span>+<span style="color: #483d8b;">str</span>(ObservationID)+<span style="color: #8b2252;">"/seg"</span>+<span style="color: #483d8b;">str</span>(SegmentNumber)+<span style="color: #8b2252;">"/SegmentAnalysis.tsh"</span>,<span style="color: #8b2252;">"w"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Opens a local version which will be run.</span>
            <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f1: <span style="color: #b22222;"># </span><span style="color: #b22222;">For each line in the template file...</span>
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTSTARTTIME"</span>,<span style="color: #483d8b;">str</span>(SegmentStartTime)) <span style="color: #b22222;">#</span><span style="color: #b22222;">... any instance of the Caps words is replaced with the actual variable.</span>
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTENDTIME"</span>,<span style="color: #483d8b;">str</span>(SegmentEndTime))
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"OBSERVATIONID"</span>,StringObservationID)
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"ROOTPATH"</span>,<span style="color: #483d8b;">str</span>(os.getcwd()))
                f2.write(line)
            f1.close()
            f2.close()

            os.chdir(<span style="color: #8b2252;">"0%d/seg%d/"</span> % (ObservationID,SegmentNumber)) <span style="color: #b22222;"># </span><span style="color: #b22222;">The script moves into the folder with the .tsh script in, and runs it, then moves out again.</span>
            os.system(<span style="color: #8b2252;">"tcsh "</span>+<span style="color: #483d8b;">str</span>(os.getcwd())+<span style="color: #8b2252;">"/0%d/seg%d/SegmentAnalysis.tsh"</span> % (ObservationID,SegmentNumber))
            os.chdir(<span style="color: #8b2252;">"../../"</span>)

        <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"The light curves have been produced for each segment.\n"</span>

        <span style="color: #a0522d;">f1</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"/data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/lagfreq_cohfreq_script_template.sl"</span>,<span style="color: #8b2252;">"r"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Open the Epitropakis lag-frequency method template file.</span>
        <span style="color: #a0522d;">f2</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"0"</span>+<span style="color: #483d8b;">str</span>(ObservationID)+<span style="color: #8b2252;">"/lagfreq_cohfreq_script.sl"</span>,<span style="color: #8b2252;">"w"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Create a local copy</span>
        <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f1:
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"OBSERVATIONID"</span>,StringObservationID)
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTNUMBER"</span>,StringNumberOfSegments)
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"ROOTPATH"</span>,<span style="color: #483d8b;">str</span>(os.getcwd()))
             f2.write(line)
        f1.close()
        f2.close()


        <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"The file to calculate coherence (nntest_lagfreq.sl) for observation "</span>+StringObservationID+<span style="color: #8b2252;">" and "</span>+StringNumberOfSegments+<span style="color: #8b2252;">" segments has been generated in the observation ID root folder.\n\nThis should be called manually once the segment folders have been checked using: isis nntest_lagfreq.sl\n"</span>


<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">"__main__"</span>:
        main(sys.argv[4:])
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-3-9" class="outline-4">
<h4 id="sec-2-3-9"><span class="section-number-4">2.3.9</span> Coherence Analysis Script</h4>
<div class="outline-text-4" id="text-2-3-9">
<pre class="example">
%declare observation ID's
variable obs_id = ["0204730201"];

variable obs_segs = [100];

variable i;
variable j;
variable k;
variable n;

% declare frequency bins
variable re_bin_f = 35; % with binninng
variable df_f = 0.2;
variable lo_bin_f = 2e-2;

%declare the number of frequency bins
variable n_bins = 15000; % without binning

%declare arrays
variable lag = Double_Type[n_bins];
variable rb_n = Integer_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_real_2 = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_a_2 = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable coh = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];
variable delta_coh = Double_Type[n_bins];

variable seg_length = 200000;
variable seg_min = 200000;

for(k=0; k&lt;length(obs_id); k++){
        for (n=0; n&lt;obs_segs[k]; n++)
        {
                () = chdir("/data/cluster/XRayReverb2016/HarryData/GX339-4/"+obs_id[k] + sprintf("/seg%i", n));
                variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
                variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");
                variable ix_soft = where(not isnan(lc_soft.rate));
                variable ix_hard = where(not isnan(lc_hard.rate));

                if(length(ix_soft) &lt; seg_min)
                {
                        seg_length = length(ix_soft);
                }
                seg_min = seg_length;
                vmessage("check data: " + obs_id[k] + sprintf("/seg%i", n) + sprintf("  length= %i",  length(ix_soft)));
        }
}
vmessage("****set seg_length =%i", seg_length);

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){
for (n=0; n&lt;obs_segs[k]; n++){

() = chdir( "/data/cluster/XRayReverb2016/HarryData/GX339-4/" +obs_id[k] + sprintf("/seg%i", n));
%vmessage( obs_id[k] + sprintf("/seg%i", n));

%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));
variable rate_soft = Double_Type[seg_length];
variable rate_hard = Double_Type[seg_length];
variable time_soft = Double_Type[seg_length];
variable time_hard = Double_Type[seg_length];
variable error_soft = Double_Type[seg_length];
variable error_hard = Double_Type[seg_length];

%Pass to new variables:
variable o_time_soft = lc_soft.time[ix_soft];
variable o_time_hard = lc_hard.time[ix_hard];
variable o_rate_soft = lc_soft.rate[ix_soft];
variable o_rate_hard = lc_hard.rate[ix_hard];
variable o_error_soft = lc_soft.error[ix_soft];
variable o_error_hard = lc_hard.error[ix_hard];

for(j=0; j&lt;seg_length; j++)
{
        rate_soft[j] = o_rate_soft[j];
        rate_hard[j] = o_rate_hard[j];
        time_soft[j] = o_time_soft[j];
        time_hard[j] = o_time_hard[j];
        error_soft[j] = o_error_soft[j];
        error_hard[j] = o_error_hard[j];


}

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[1:length(dft_soft)]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);

variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

% Adjust frequency bins
variable x = Double_Type[n_bins];
variable dxp = Double_Type[n_bins];
variable dxm = Double_Type[n_bins];
for(i=1;i&lt;n_bins;i++)
{
        x[i] = freq[i];
        dxp[i] = (freq[i+1] - x[i])/2;
        dxm[i] = (x[i] - freq[i-1])/2;
}

variable lo = Double_Type[re_bin_f];
variable hi = Double_Type[re_bin_f];
lo[0]=lo_bin_f;
hi[0]=(lo[0] + lo[0]*df_f);
for(i=1;i&lt;re_bin_f;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
}
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));
variable x_bin = (hi+lo)/2;
variable dxp_bin = hi-x_bin;
variable dxm_bin = x_bin-lo;

%Calculate and sum CPS for each frequency bin in each observation.
for(j=0; j&lt; n_bins; j++)
{
                        %() = printf("j= %i freq= %e\n", j, freq[j]);
                        g_a_real[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_real_2[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[j] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[j] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];	% Periodrogram s
                        g_c[j] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];	% Periodrogram h
                        rb_n[j] ++;
                
}
}
}

%Plot variables including frequency error bars
for(j=0; j&lt; n_bins; j++)
{
        g_a_real[j] = g_a_real[j]/rb_n[j];
        g_a_real_2[j] = g_a_real_2[j] /rb_n[j];
        g_a_imag[j] = g_a_imag[j]/rb_n[j];
        g_a[j] = (g_a_real[j]*g_a_real[j] + g_a_imag[j]*g_a_imag[j]);
        g_a_2[j] = (g_a_real_2[j]*g_a_real_2[j] + g_a_imag[j]*g_a_imag[j]);
        g_b[j] = g_b[j]/rb_n[j];
        g_c[j] = g_c[j]/rb_n[j];
        g[j] = g_a[j]/(g_b[j]*g_c[j]);
        coh[j] = g_a_2[j]/(g_b[j]*g_c[j]);
        delta_phi[j] = sqrt((1.0-g[j])/(2.0*g[j]))/sqrt(double(rb_n[j]));	
        delta_lag[j] = delta_phi[j]/(2.0*PI*freq[j]);
        delta_coh[j] = 0.0; 

        lag[j] = atan2(g_a_imag[j] , g_a_real[j])/(2.0*PI*freq[j]);
}


variable fb_n = Integer_Type[re_bin_f];
variable n_est = Integer_Type[re_bin_f];

variable lag_bin = Double_Type[re_bin_f];
variable g_a_real_bin = Double_Type[re_bin_f];
variable g_a_real_2_bin = Double_Type[re_bin_f];
variable g_a_imag_bin = Double_Type[re_bin_f];
variable g_a_bin = Double_Type[re_bin_f];
variable g_a_2_bin = Double_Type[re_bin_f];
variable g_b_bin = Double_Type[re_bin_f];
variable g_c_bin = Double_Type[re_bin_f];
variable g_bin = Double_Type[re_bin_f];
variable delta_phi_bin = Double_Type[re_bin_f];
variable delta_lag_bin = Double_Type[re_bin_f];
variable delta_coh_bin = Double_Type[re_bin_f];

for(i=0; i&lt; re_bin_f; i++)
{
        for (j=0; j&lt;n_bins; j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {
                        g_a_real_bin[i] += g_a_real[j];
                        g_a_real_2_bin[i] += g_a_real_2[j];
                        g_a_imag_bin[i] += g_a_imag[j];
                        g_b_bin[i] += g_b[j];
                        g_c_bin[i] += g_c[j];
                        fb_n[i]++;
                        n_est[i] += rb_n[j];
                }
        }
}

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0; i&lt;re_bin_f; i++)
{
        %Lag error
        g_a_real_bin[i] /= fb_n[i];
        g_a_imag_bin[i] /= fb_n[i];
        g_a_bin[i] = (g_a_real_bin[i]*g_a_real_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_a_2_bin[i] = (g_a_real_2_bin[i]*g_a_real_2_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_b_bin[i] /= double(fb_n[i]);
        g_c_bin[i] /= double(fb_n[i]);
        g_bin[i] = g_a_bin[i]/(g_b_bin[i]*g_c_bin[i]);
        delta_phi_bin[i] = sqrt((1.0-g_bin[i])/(2.0*g_bin[i]))/sqrt(double(n_est[i]));	
        delta_lag_bin[i] = delta_phi_bin[i]/(2.0*PI*rb_freq[i]);
        lag_bin[i] = atan2(g_a_imag_bin[i] , g_a_real_bin[i])/(2.0*PI*rb_freq[i]);
}


() = chdir( "/data/cluster/XRayReverb2016/HarryData/GX339-4/"+obs_id[0] );


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Plot coherence results:

open_plot("CoherenceFrequency.gif/gif");

%window(1);
xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Coherence");
title("GX339-4 0204730201 Coherence");
connect_points(0);
_pgsfs(3);

plotxy(x,dxm,dxp,coh,delta_coh,delta_coh; dcol=1, decol=4, dsym=6, xrange=[3e-1,20],yrange=[0.01,2]);	% coherence

_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(log10(50),0);

%Coherence value (horzontal) line (don't change)
_pgmove(-1, log10(1.2/(1+(0.2*obs_segs[0]))));
_pgsls(3); % line style?
_pgsci(3); % colour 1- black, 2-red, 3 - green
_pgslw(4); % line width?
_pgdraw(log10(50), log10(1.2/(1+(0.2*obs_segs[0]))));

% Vertical max freq line (x coord found by looking at the graph, change this and the one below in lag freq)
_pgmove(log10(9), log10(1e-4) );
_pgsls(2);
_pgsci(2);
_pgslw(4);
_pgdraw(log10(9), log10(1e2));

close_plot;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Display the lag-freq values
for (i=0; i&lt;re_bin_f; i++) {
  () = printf("%e,  %e,  %e\n", x_bin[i], lag_bin[i], delta_lag[i]);
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Plot binned Lag-freq results:
%window(1);

open_plot("EpitropakisLagFrequency.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0204730201 Lag-Frequency");
connect_points(0);
_pgsfs(3);

plotxy(x_bin,dxm_bin,dxp_bin,lag_bin,delta_lag_bin,delta_lag_bin; dcol=1, decol=4, dsym=6,  xrange=[3e-3,10],yrange=[1e-4,1]);	% binned f lags
_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

% Vertical max freq line
_pgmove(log10(9), log10(1e-5) );
_pgsls(2);
_pgsci(2);
_pgslw(4);
_pgdraw(log10(9), log10(1e2));

close_plot;

% Plot unbinned Lag-freq results:
%window(1);






open_plot("EpitropakisUnbinnedLagFrequency.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0204730201 Unbinned Lag-Frequency");
connect_points(0);
_pgsfs(3);

%plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4, dsym=6, xrange=[3e-3,10],yrange=[1e-4,1]);	% unbinned f lags
_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

% Vertical max freq line
%_pgmove(-2.721,-1400); % 0.3-4k
%_pgmove(-3.284,-600); % 2-7k
%_pgsls(2);
%_pgsci(2);
%_pgslw(4);
%_pgdraw(-2.721,1400); % 0.3-4k
%_pgdraw(-3.284,600); % 2-7k

close_plot;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> 0204730301 (U002)</h3>
<div class="outline-text-3" id="text-2-4">
<p>
The 0204730301 observation was split into 2 parts. This is the longer
U002 analysis.
</p>
</div>
<div id="outline-container-sec-2-4-1" class="outline-4">
<h4 id="sec-2-4-1"><span class="section-number-4">2.4.1</span> Initial Processing</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
Before running this, create a folder with the ODF name, and inside
have a ODF and PROC folder. Run the following in the ODF folder. May
take 15 mins.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n Initial SAS setup, general for all files. Run in a suitable folder after replacing the OBSID'</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nDOWNLOAD TAR FILE...'</span>
curl -o 0204730301.tar <span style="color: #8b2252;">"http://nxsa.esac.esa.int/nxsa-sl/servlet/data-action-aio?obsno=0204730301&amp;level=ODF"</span>
tar -zxvf *.tar
tar -xvf *.TAR

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n file unpacked. Setup SAS'</span>

heainit
setsas
<span style="color: #483d8b;">setenv</span> SAS_CCFPATH /usr/local/XMM/ccf/
<span style="color: #483d8b;">setenv</span> SAS_ODF $<span style="color: #a0522d;">PWD</span>
cifbuild
<span style="color: #483d8b;">setenv</span> SAS_CCF ccf.cif
odfingest
<span style="color: #483d8b;">setenv</span> SAS_ODF $<span style="color: #a0522d;">PWD</span>/*SUM.SAS
cp ccf.cif ../PROC
cp *SUM.SAS ../PROC
<span style="color: #483d8b;">cd</span> ../PROC

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n MOVED TO PROC FOLDER. INITIALISING WORK'</span>

epproc <span style="color: #a0522d;">randomizetime</span>=no <span style="color: #a0522d;">randomizeposition</span>=no <span style="color: #a0522d;">randomizeenergy</span>=no

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nScript to process ODF data\n\n\n'</span>
cp *2_TimingEvts.ds PN.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Create a light curve.'</span>
evselect <span style="color: #a0522d;">table</span>=PN.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_flares_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timebinsize</span>=10 <span style="color: #a0522d;">makeratecolumn</span>=yes <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'#XMMEA_EP &amp;&amp; (PI&gt;10000&amp;&amp;PI&lt;12000) &amp;&amp; (PATTERN==0)'</span>
dsplot <span style="color: #a0522d;">table</span>=PN_flares_lc.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;
</pre>
</div>

<p>
Note: 2 TimingEvts.ds files were generated. In this case I used the
0783<sub>0204730301</sub><sub>EPN</sub><sub>U002</sub><sub>TimingEvts</sub>.ds. This should be checked in future
</p>

<p>
At this point flares must be removed if they exist.
In this instance there were no flares so they were not removed.
</p>
</div>
</div>
<div id="outline-container-sec-2-4-2" class="outline-4">
<h4 id="sec-2-4-2"><span class="section-number-4">2.4.2</span> Flare removal</h4>
<div class="outline-text-4" id="text-2-4-2">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n no flares removed'</span>
cp PN.fits EPICclean.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n MAKE IMAGE...'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withimageset</span>=yes <span style="color: #a0522d;">imageset</span>=EPICclean_image.fits <span style="color: #a0522d;">xcolumn</span>=RAWX <span style="color: #a0522d;">ycolumn</span>=RAWY <span style="color: #a0522d;">imagebinning</span>=binSize <span style="color: #a0522d;">ximagebinsize</span>=1 <span style="color: #a0522d;">yimagebinsize</span>=1
ds9 EPICclean_image.fits &amp;
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\nImage created. Please note down a source and background range of pixels.'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-4-3" class="outline-4">
<h4 id="sec-2-4-3"><span class="section-number-4">2.4.3</span> Extract Source and Background Region</h4>
<div class="outline-text-4" id="text-2-4-3">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nSoft Filter\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in [500:1500])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nHard Filter\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in [2000:9000])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n Extract src and bg\n\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Source from Soft Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft_src.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [31:45]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Source from Hard Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard_src.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [31:45]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Background from Soft Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft_bkg.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [3:5]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Background from Hard Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard_bkg.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [3:5]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes
</pre>
</div>



<p>
Delete below eventually
</p>
</div>
</div>
<div id="outline-container-sec-2-4-4" class="outline-4">
<h4 id="sec-2-4-4"><span class="section-number-4">2.4.4</span> Make Light Curves</h4>
<div class="outline-text-4" id="text-2-4-4">
<p>
Note the time bin size here.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate Lightcurve from source\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from soft photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft_src.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_soft_src_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from hard photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard_src.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_hard_src_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from Background\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from soft photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft_bkg.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_soft_bkg_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from hard photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard_bkg.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_hard_bkg_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate Background Subtracted Light Curve\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nFrom soft photons (10 mins)\n'</span>
epiclccorr <span style="color: #a0522d;">srctslist</span>=PN_time_soft_src_lc.fits <span style="color: #a0522d;">eventlist</span>=EPICclean.fits <span style="color: #a0522d;">outset</span>=PN_time_soft_lccorr.fits <span style="color: #a0522d;">bkgtslist</span>=PN_time_soft_bkg_lc.fits <span style="color: #a0522d;">withbkgset</span>=yes <span style="color: #a0522d;">applyabsolutecorrections</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nFrom hard photons (10 mins)\n'</span>
epiclccorr <span style="color: #a0522d;">srctslist</span>=PN_time_hard_src_lc.fits <span style="color: #a0522d;">eventlist</span>=EPICclean.fits <span style="color: #a0522d;">outset</span>=PN_time_hard_lccorr.fits <span style="color: #a0522d;">bkgtslist</span>=PN_time_hard_bkg_lc.fits <span style="color: #a0522d;">withbkgset</span>=yes <span style="color: #a0522d;">applyabsolutecorrections</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Display the lightcurve'</span>

dsplot <span style="color: #a0522d;">table</span>=PN_time_soft_lccorr.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;
dsplot <span style="color: #a0522d;">table</span>=PN_time_hard_lccorr.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Note that the above lightcurves can be chopped with the evselect timemin and timemax command'</span>
</pre>
</div>

<p>
This observation is combined with another 2004 observation
(0204730301) so the plots are not shown here.
</p>
</div>
</div>
<div id="outline-container-sec-2-4-5" class="outline-4">
<h4 id="sec-2-4-5"><span class="section-number-4">2.4.5</span> Produce Lag-Frequency Plots</h4>
<div class="outline-text-4" id="text-2-4-5">
<p>
Begin by downloading a template
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"\n\n\nProduce lagfreq script\n\n\n"</span>
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/isis_lagfreq_script.sl .
emacs isis_lagfreq_script.sl &amp;
</pre>
</div>

<p>
Edit this file accordingly (update OBSID and frequency ranges if
necessary). Then run the file analysis in isis. The one used in this
case is shown in the following in a separate section <a href="#sec-2-4-7">here</a>.
</p>

<div class="org-src-container">

<pre class="src src-sh">isis isis_lagfreq_script.sl
<span style="color: #a020f0;">exit</span>;
</pre>
</div>

<p>
The output from this is shown in Figure <a href="#LagFreq">18</a>.
</p>


<div id="LagFreq" class="figure">
<p><img src="./02047303012/PROC/lagfreq.gif" alt="lagfreq.gif" />
</p>
<p><span class="figure-number">Figure 32:</span> The lag-frequency graph for 0204730301(U002) GX339-4 observation</p>
</div>
</div>
</div>
<div id="outline-container-sec-2-4-6" class="outline-4">
<h4 id="sec-2-4-6"><span class="section-number-4">2.4.6</span> Epitropakis Methods</h4>
<div class="outline-text-4" id="text-2-4-6">
<p>
Following the analysis outlined by Epitropakis in Epitropakis 2016
(Theoretical modelling of the AGN iron-line/continuum time-lags in the
lamp-post geometry), we have calculated the lag frequencies in a new
way and also calculated the coherence. This is outlined below.
</p>

<p>
Coherence/ lagfreq analysis was first tested on this observation. Initially it required splitting up the original observation into segments.
This would be time consuming to do manually so a python script which should do
this was developed in the section <a href="#sec-2-4-8">2.4.8</a>.
</p>

<p>
The python file should be run in the folder which contains the
observation ID folder. The scipt should be run with the observationID,
start time, end time and number of segments as arguments i.e.
</p>

<div class="org-src-container">

<pre class="src src-python">python run_segment_analysis.py 02047303012 196015000 196135000 20
</pre>
</div>

<p>
This generates segment directories (i.e. seg0,seg1) in the same folder
as the ODF and PROC folders are. In the segment directories a bash
script is created. The bash script performs all the filtering and
generates the light curves so will take a long time to run so should
be 'screened'.
</p>

<p>
The python script also outputs a modified lagfreq and coherence script shown here:
<a href="#sec-2-4-9">2.4.9</a>. This is placed with the PROC, segX and ODF
folders. This should be run to produce the lag frequency and coherence
files (as seen below) using the command:
</p>

<div class="org-src-container">

<pre class="src src-example">isis lagfreq_cohfreq_script.sl
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-2-4-6-1" name="sec-2-4-6-1"></a>Epitropakis Results<br  /><div class="outline-text-5" id="text-2-4-6-1">

<div class="figure">
<p><img src="./02047303012/EpitropakisLagFrequency.gif" alt="EpitropakisLagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 33:</span> 0204730301 (U002) binned lag-frequency plot.</p>
</div>


<div class="figure">
<p><img src="./02047303012/CoherenceFrequency.gif" alt="CoherenceFrequency.gif" />
</p>
<p><span class="figure-number">Figure 34:</span> 0204730301 (U002) coherence against frequency plot.</p>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-2-4-7" class="outline-4">
<h4 id="sec-2-4-7"><span class="section-number-4">2.4.7</span> Lag-Frequency Script</h4>
<div class="outline-text-4" id="text-2-4-7">
<pre class="example">
%declare observation ID's
variable obs_id = ["02047303012"];


variable i;
variable j;
variable k;

%declare frequency bins
variable n_bins =21;
variable df_f = 0.5/1.1; %Possibly change bin size to be bigger to exactly emulate DeMarco2015 results.
variable lo = Double_Type[n_bins];
variable hi = Double_Type[n_bins];
lo[0]=0.005;
hi[0]=(lo[0] + lo[0]*df_f);

for(i=1;i&lt;n_bins;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
 }

%logarithmic frequency bin centre
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));

%declare arrays
variable rb_n = Integer_Type[n_bins];
variable lag = Double_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){


%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));

%Pass to new variables:
variable time_soft = lc_soft.time[ix_soft];
variable time_hard = lc_hard.time[ix_hard];
variable rate_soft = lc_soft.rate[ix_soft];
variable rate_hard = lc_hard.rate[ix_hard];
variable error_soft = lc_soft.error[ix_soft];
variable error_hard = lc_hard.error[ix_hard];

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[0:length(dft_soft)-1]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);
variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

%Calculate and sum CPS for each frequency bin in each observation.
for(i=0; i&lt; n_bins; i++)
{
        for (j=0; j&lt;length(freq); j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {
                        g_a_real[i] += abs(dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[i] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[i] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];
                        g_c[i] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];
                        rb_n[i] ++;
                }
        }
}
}

%Plot variables including frequency error bars
variable x = (hi+lo)/2;
variable dxp = hi-x;
variable dxm = x-lo;

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0;i&lt;n_bins;i++)
{
        %Lag error
        g_a[i] = (g_a_real[i]*g_a_real[i] + g_a_imag[i]*g_a_imag[i])/(double(rb_n[i])*double(rb_n[i]));
        g_b[i] /= double(rb_n[i]);
        g_c[i] /= double(rb_n[i]);
        g[i] = g_a[i]/(g_b[i]*g_c[i]);
        delta_phi[i] = sqrt((1.0-g[i])/(2.0*g[i]))/sqrt(double(rb_n[i]));
        delta_lag[i] = delta_phi[i]/(2.0*PI*rb_freq[i]);

        %Lag
        g_a_real[i] /= rb_n[i];
        g_a_imag[i] /= rb_n[i];
        lag[i] = atan2(g_a_imag[i] , g_a_real[i])/(2.0*PI*rb_freq[i]);
}

% Plot results:

open_plot("lagfreq.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 02047303012 (U002) lag-frequency &gt;5e-3 Hz");
connect_points(0);

plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4,dsym=6, xrange=[3e-3,10], yrange=[0.0001,1]);
_pgmove(-10000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

for (i=0; i&lt;length(x); i++) {
  () = printf("%e,%e,%e\n", x[i], lag[i], delta_lag[i]);
}

close_plot;
</pre>
</div>
</div>
<div id="outline-container-sec-2-4-8" class="outline-4">
<h4 id="sec-2-4-8"><span class="section-number-4">2.4.8</span> Segment Analysis Script</h4>
<div class="outline-text-4" id="text-2-4-8">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">This python program runs the Epitropakis method for analysis of scripts. After this the time lag</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">To run, arguments should be supplied in the order, OBSID, Obs start time, Obs end time and Number of Segments Required. e.g. python segment_analysis.py 0605610201 000000000 999999999 10.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">This MUST be located in the same folder as the other observation IDs are when executed.</span>

<span style="color: #a020f0;">import</span> os,sys

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">main</span>(argv):
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(sys.argv)&lt;4:
               <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">'Add more arguments. Should be in the form:  ObservationID, Observation Start Time, Observation End Time and Number of Segments'</span>
               sys.<span style="color: #008b8b;">exit</span>(2)

        <span style="color: #a0522d;">ObservationID</span> = <span style="color: #483d8b;">int</span>(sys.argv[1]) <span style="color: #b22222;"># </span><span style="color: #b22222;">Import the arguments</span>
        <span style="color: #a0522d;">StartTime</span> = <span style="color: #483d8b;">int</span>(sys.argv[2])
        <span style="color: #a0522d;">EndTime</span> = <span style="color: #483d8b;">int</span>(sys.argv[3])
        <span style="color: #a0522d;">NumberOfSegments</span> = <span style="color: #483d8b;">int</span>(sys.argv[4])

        <span style="color: #a0522d;">TotalTime</span> = EndTime-StartTime <span style="color: #b22222;"># </span><span style="color: #b22222;">Use the times to work out how long each segment will last for</span>
        <span style="color: #a0522d;">AverageSegmentTime</span> = <span style="color: #483d8b;">int</span>(TotalTime/NumberOfSegments)
        <span style="color: #a0522d;">ExtraTime</span> = TotalTime - AverageSegmentTime*NumberOfSegments <span style="color: #b22222;"># </span><span style="color: #b22222;">Calculates if rounding would cause some time to omitted in the analysis.</span>
        <span style="color: #a0522d;">StringNumberOfSegments</span> = <span style="color: #483d8b;">str</span>(NumberOfSegments) <span style="color: #b22222;"># </span><span style="color: #b22222;">Useful to have this as a string later on.</span>

        <span style="color: #a020f0;">for</span> SegmentNumber <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(0,NumberOfSegments): <span style="color: #b22222;"># </span><span style="color: #b22222;">This now begins the analysis for each segment.</span>

            <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Working on Segment"</span>,SegmentNumber

            <span style="color: #a020f0;">if</span> SegmentNumber != NumberOfSegments: <span style="color: #b22222;"># </span><span style="color: #b22222;">Calculate the segment start and end time.</span>
                <span style="color: #a0522d;">SegmentStartTime</span> = StartTime + (SegmentNumber*AverageSegmentTime)
                <span style="color: #a0522d;">SegmentEndTime</span> = SegmentStartTime + AverageSegmentTime
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a0522d;">SegmentStartTime</span> = StartTime + (SegmentNumber*AverageSegmentTime) + ExtraTime
                <span style="color: #a0522d;">SegmentEndTime</span> = SegmentStartTime + AverageSegmentTime
            <span style="color: #a0522d;">StringObservationID</span> = <span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">str</span>(0)+<span style="color: #483d8b;">str</span>(ObservationID)) <span style="color: #b22222;"># </span><span style="color: #b22222;">When stored as an int the Observation ID loses its initial 0 so this is added.</span>
            <span style="color: #a0522d;">StringSegmentNumber</span> = <span style="color: #483d8b;">str</span>(SegmentNumber)

            os.system(<span style="color: #8b2252;">"mkdir 0%d/seg%d"</span> % (ObservationID,SegmentNumber)) <span style="color: #b22222;"># </span><span style="color: #b22222;">Create the segment root folder</span>

            <span style="color: #a0522d;">f1</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"/data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/SegmentAnalysisTemplateGeneral.tsh"</span>,<span style="color: #8b2252;">"r"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Opens a segment analysis template file.</span>
            <span style="color: #a0522d;">f2</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"0"</span>+<span style="color: #483d8b;">str</span>(ObservationID)+<span style="color: #8b2252;">"/seg"</span>+<span style="color: #483d8b;">str</span>(SegmentNumber)+<span style="color: #8b2252;">"/SegmentAnalysis.tsh"</span>,<span style="color: #8b2252;">"w"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Opens a local version which will be run.</span>
            <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f1: <span style="color: #b22222;"># </span><span style="color: #b22222;">For each line in the template file...</span>
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTSTARTTIME"</span>,<span style="color: #483d8b;">str</span>(SegmentStartTime)) <span style="color: #b22222;">#</span><span style="color: #b22222;">... any instance of the Caps words is replaced with the actual variable.</span>
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTENDTIME"</span>,<span style="color: #483d8b;">str</span>(SegmentEndTime))
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"OBSERVATIONID"</span>,StringObservationID)
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"ROOTPATH"</span>,<span style="color: #483d8b;">str</span>(os.getcwd()))
                f2.write(line)
            f1.close()
            f2.close()

            os.chdir(<span style="color: #8b2252;">"0%d/seg%d/"</span> % (ObservationID,SegmentNumber)) <span style="color: #b22222;"># </span><span style="color: #b22222;">The script moves into the folder with the .tsh script in, and runs it, then moves out again.</span>
            os.system(<span style="color: #8b2252;">"tcsh "</span>+<span style="color: #483d8b;">str</span>(os.getcwd())+<span style="color: #8b2252;">"/0%d/seg%d/SegmentAnalysis.tsh"</span> % (ObservationID,SegmentNumber))
            os.chdir(<span style="color: #8b2252;">"../../"</span>)

        <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"The light curves have been produced for each segment.\n"</span>

        <span style="color: #a0522d;">f1</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"/data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/lagfreq_cohfreq_script_template.sl"</span>,<span style="color: #8b2252;">"r"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Open the Epitropakis lag-frequency method template file.</span>
        <span style="color: #a0522d;">f2</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"0"</span>+<span style="color: #483d8b;">str</span>(ObservationID)+<span style="color: #8b2252;">"/lagfreq_cohfreq_script.sl"</span>,<span style="color: #8b2252;">"w"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Create a local copy</span>
        <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f1:
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"OBSERVATIONID"</span>,StringObservationID)
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTNUMBER"</span>,StringNumberOfSegments)
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"ROOTPATH"</span>,<span style="color: #483d8b;">str</span>(os.getcwd()))
             f2.write(line)
        f1.close()
        f2.close()


        <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"The file to calculate coherence (nntest_lagfreq.sl) for observation "</span>+StringObservationID+<span style="color: #8b2252;">" and "</span>+StringNumberOfSegments+<span style="color: #8b2252;">" segments has been generated in the observation ID root folder.\n\nThis should be called manually once the segment folders have been checked using: isis nntest_lagfreq.sl\n"</span>


<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">"__main__"</span>:
        main(sys.argv[4:])
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-4-9" class="outline-4">
<h4 id="sec-2-4-9"><span class="section-number-4">2.4.9</span> Coherence Analysis Script</h4>
<div class="outline-text-4" id="text-2-4-9">
<pre class="example">
%declare observation ID's
variable obs_id = ["02047303012"];

variable obs_segs = [20];

variable i;
variable j;
variable k;
variable n;

% declare frequency bins
variable re_bin_f = 21; % with binninng
variable df_f = 0.3;
variable lo_bin_f = 5e-2;

%declare the number of frequency bins
variable n_bins = 15000; % without binning

%declare arrays
variable lag = Double_Type[n_bins];
variable rb_n = Integer_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_real_2 = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_a_2 = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable coh = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];
variable delta_coh = Double_Type[n_bins];

variable seg_length = 20000;
variable seg_min = 20000;

for(k=0; k&lt;length(obs_id); k++){
        for (n=0; n&lt;obs_segs[k]; n++)
        {
                () = chdir("/data/cluster/XRayReverb2016/HarryData/GX339-4/"+obs_id[k] + sprintf("/seg%i", n));
                variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
                variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");
                variable ix_soft = where(not isnan(lc_soft.rate));
                variable ix_hard = where(not isnan(lc_hard.rate));

                if(length(ix_soft) &lt; seg_min)
                {
                        seg_length = length(ix_soft);
                }
                seg_min = seg_length;
                vmessage("check data: " + obs_id[k] + sprintf("/seg%i", n) + sprintf("  length= %i",  length(ix_soft)));
        }
}
vmessage("****set seg_length =%i", seg_length);

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){
for (n=0; n&lt;obs_segs[k]; n++){

() = chdir( "/data/cluster/XRayReverb2016/HarryData/GX339-4/" +obs_id[k] + sprintf("/seg%i", n));
%vmessage( obs_id[k] + sprintf("/seg%i", n));

%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));
variable rate_soft = Double_Type[seg_length];
variable rate_hard = Double_Type[seg_length];
variable time_soft = Double_Type[seg_length];
variable time_hard = Double_Type[seg_length];
variable error_soft = Double_Type[seg_length];
variable error_hard = Double_Type[seg_length];

%Pass to new variables:
variable o_time_soft = lc_soft.time[ix_soft];
variable o_time_hard = lc_hard.time[ix_hard];
variable o_rate_soft = lc_soft.rate[ix_soft];
variable o_rate_hard = lc_hard.rate[ix_hard];
variable o_error_soft = lc_soft.error[ix_soft];
variable o_error_hard = lc_hard.error[ix_hard];

for(j=0; j&lt;seg_length; j++)
{
        rate_soft[j] = o_rate_soft[j];
        rate_hard[j] = o_rate_hard[j];
        time_soft[j] = o_time_soft[j];
        time_hard[j] = o_time_hard[j];
        error_soft[j] = o_error_soft[j];
        error_hard[j] = o_error_hard[j];


}

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[1:length(dft_soft)]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);

variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

% Adjust frequency bins
variable x = Double_Type[n_bins];
variable dxp = Double_Type[n_bins];
variable dxm = Double_Type[n_bins];
for(i=1;i&lt;n_bins;i++)
{
        x[i] = freq[i];
        dxp[i] = (freq[i+1] - x[i])/2;
        dxm[i] = (x[i] - freq[i-1])/2;
}

variable lo = Double_Type[re_bin_f];
variable hi = Double_Type[re_bin_f];
lo[0]=lo_bin_f;
hi[0]=(lo[0] + lo[0]*df_f);
for(i=1;i&lt;re_bin_f;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
}
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));
variable x_bin = (hi+lo)/2;
variable dxp_bin = hi-x_bin;
variable dxm_bin = x_bin-lo;

%Calculate and sum CPS for each frequency bin in each observation.
for(j=0; j&lt; n_bins; j++)
{
                        %() = printf("j= %i freq= %e\n", j, freq[j]);
                        g_a_real[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_real_2[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[j] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[j] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];	% Periodrogram s
                        g_c[j] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];	% Periodrogram h
                        rb_n[j] ++;
                
}
}
}

%Plot variables including frequency error bars
for(j=0; j&lt; n_bins; j++)
{
        g_a_real[j] = g_a_real[j]/rb_n[j];
        g_a_real_2[j] = g_a_real_2[j] /rb_n[j];
        g_a_imag[j] = g_a_imag[j]/rb_n[j];
        g_a[j] = (g_a_real[j]*g_a_real[j] + g_a_imag[j]*g_a_imag[j]);
        g_a_2[j] = (g_a_real_2[j]*g_a_real_2[j] + g_a_imag[j]*g_a_imag[j]);
        g_b[j] = g_b[j]/rb_n[j];
        g_c[j] = g_c[j]/rb_n[j];
        g[j] = g_a[j]/(g_b[j]*g_c[j]);
        coh[j] = g_a_2[j]/(g_b[j]*g_c[j]);
        delta_phi[j] = sqrt((1.0-g[j])/(2.0*g[j]))/sqrt(double(rb_n[j]));	
        delta_lag[j] = delta_phi[j]/(2.0*PI*freq[j]);
        delta_coh[j] = 0.0; 

        lag[j] = atan2(g_a_imag[j] , g_a_real[j])/(2.0*PI*freq[j]);
}


variable fb_n = Integer_Type[re_bin_f];
variable n_est = Integer_Type[re_bin_f];

variable lag_bin = Double_Type[re_bin_f];
variable g_a_real_bin = Double_Type[re_bin_f];
variable g_a_real_2_bin = Double_Type[re_bin_f];
variable g_a_imag_bin = Double_Type[re_bin_f];
variable g_a_bin = Double_Type[re_bin_f];
variable g_a_2_bin = Double_Type[re_bin_f];
variable g_b_bin = Double_Type[re_bin_f];
variable g_c_bin = Double_Type[re_bin_f];
variable g_bin = Double_Type[re_bin_f];
variable delta_phi_bin = Double_Type[re_bin_f];
variable delta_lag_bin = Double_Type[re_bin_f];
variable delta_coh_bin = Double_Type[re_bin_f];

for(i=0; i&lt; re_bin_f; i++)
{
        for (j=0; j&lt;n_bins; j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {
                        g_a_real_bin[i] += g_a_real[j];
                        g_a_real_2_bin[i] += g_a_real_2[j];
                        g_a_imag_bin[i] += g_a_imag[j];
                        g_b_bin[i] += g_b[j];
                        g_c_bin[i] += g_c[j];
                        fb_n[i]++;
                        n_est[i] += rb_n[j];
                }
        }
}

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0; i&lt;re_bin_f; i++)
{
        %Lag error
        g_a_real_bin[i] /= fb_n[i];
        g_a_imag_bin[i] /= fb_n[i];
        g_a_bin[i] = (g_a_real_bin[i]*g_a_real_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_a_2_bin[i] = (g_a_real_2_bin[i]*g_a_real_2_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_b_bin[i] /= double(fb_n[i]);
        g_c_bin[i] /= double(fb_n[i]);
        g_bin[i] = g_a_bin[i]/(g_b_bin[i]*g_c_bin[i]);
        delta_phi_bin[i] = sqrt((1.0-g_bin[i])/(2.0*g_bin[i]))/sqrt(double(n_est[i]));	
        delta_lag_bin[i] = delta_phi_bin[i]/(2.0*PI*rb_freq[i]);
        lag_bin[i] = atan2(g_a_imag_bin[i] , g_a_real_bin[i])/(2.0*PI*rb_freq[i]);
}


() = chdir( "/data/cluster/XRayReverb2016/HarryData/GX339-4/"+obs_id[0] );

% Plot coherence results:

open_plot("CoherenceFrequency.gif/gif");

%window(1);
xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Coherence");
title("GX339-4 0204730301 (U002) Coherence");
connect_points(0);
_pgsfs(3);

plotxy(x,dxm,dxp,coh,delta_coh,delta_coh; dcol=1, decol=4, dsym=6, xrange=[3e-1,10],yrange=[0.1,2]);	% coherence

_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

%Coherence value (horzontal) line (this should be fixed)
_pgmove(log10(0.00001), log10(1.2/(1+(0.2*obs_segs[0]))));
_pgsls(3); % line style?
_pgsci(3); % colour 1- black, 2-red, 3 - green
_pgslw(4); % line width?
_pgdraw(log10(100), log10(1.2/(1+(0.2*obs_segs[0]))));

% Vertical max freq line (this should be changed once run both here and below )
_pgmove(log10(2), log10(1e-4) );
_pgsls(2);
_pgsci(2);
_pgslw(4);
_pgdraw(log10(2), log10(1e2));

close_plot;



%Display the lag-freq values
for (i=0; i&lt;re_bin_f; i++) {
  () = printf("%e,  %e,  %e\n", x_bin[i], lag_bin[i], delta_lag[i]);
}



% Plot binned Lag-freq results:
%window(1);

open_plot("EpitropakisLagFrequency.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0204730301 (U002) Lag-Frequency");
connect_points(0);
_pgsfs(3);

plotxy(x_bin,dxm_bin,dxp_bin,lag_bin,delta_lag_bin,delta_lag_bin; dcol=1, decol=4, dsym=6,  xrange=[3e-3,10],yrange=[1e-4,1]);	% binned f lags
_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

% Vertical max freq line
_pgmove(log10(2), log10(1e-4) );
_pgsls(2);
_pgsci(2);
_pgslw(4);
_pgdraw(log10(2), log10(1e2));


close_plot;









% Plot unbinned Lag-freq results:
%window(1);

open_plot("EpitropakisUnbinnedLagFrequency.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 02047303012 Unbinned Lag-Frequency");
connect_points(0);
_pgsfs(3);

%plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4, dsym=6, xrange=[3e-3,10],yrange=[1e-4,1]);	% unbinned f lags
_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

% Vertical max freq line
%_pgmove(-2.721,-1400); % 0.3-4k
%_pgmove(-3.284,-600); % 2-7k
%_pgsls(2);
%_pgsci(2);
%_pgslw(4);
%_pgdraw(-2.721,1400); % 0.3-4k
%_pgdraw(-3.284,600); % 2-7k

close_plot;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> 0204730301 (U003)</h3>
<div class="outline-text-3" id="text-2-5">
<p>
The 0204730301 observation was split into 2 parts. This is the shorter
U003 analysis.
</p>
</div>
<div id="outline-container-sec-2-5-1" class="outline-4">
<h4 id="sec-2-5-1"><span class="section-number-4">2.5.1</span> Initial Processing</h4>
<div class="outline-text-4" id="text-2-5-1">
<p>
Before running this, create a folder with the ODF name, and inside
have a ODF and PROC folder. Run the following in the ODF folder. May
take 15 mins.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n Initial SAS setup, general for all files. Run in a suitable folder after replacing the OBSID'</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nDOWNLOAD TAR FILE...'</span>
curl -o 0204730301.tar <span style="color: #8b2252;">"http://nxsa.esac.esa.int/nxsa-sl/servlet/data-action-aio?obsno=0204730301&amp;level=ODF"</span>
tar -zxvf *.tar
tar -xvf *.TAR

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n file unpacked. Setup SAS'</span>

heainit
setsas
<span style="color: #483d8b;">setenv</span> SAS_CCFPATH /usr/local/XMM/ccf/
<span style="color: #483d8b;">setenv</span> SAS_ODF $<span style="color: #a0522d;">PWD</span>
cifbuild
<span style="color: #483d8b;">setenv</span> SAS_CCF ccf.cif
odfingest
<span style="color: #483d8b;">setenv</span> SAS_ODF $<span style="color: #a0522d;">PWD</span>/*SUM.SAS
cp ccf.cif ../PROC
cp *SUM.SAS ../PROC
<span style="color: #483d8b;">cd</span> ../PROC

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n MOVED TO PROC FOLDER. INITIALISING WORK'</span>

epproc <span style="color: #a0522d;">randomizetime</span>=no <span style="color: #a0522d;">randomizeposition</span>=no <span style="color: #a0522d;">randomizeenergy</span>=no

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\nScript to process ODF data\n\n\n'</span>
cp *3_TimingEvts.ds PN.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Create a light curve.'</span>
evselect <span style="color: #a0522d;">table</span>=PN.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_flares_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timebinsize</span>=10 <span style="color: #a0522d;">makeratecolumn</span>=yes <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'#XMMEA_EP &amp;&amp; (PI&gt;10000&amp;&amp;PI&lt;12000) &amp;&amp; (PATTERN==0)'</span>
dsplot <span style="color: #a0522d;">table</span>=PN_flares_lc.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;
</pre>
</div>

<p>
Note: 2 TimingEvts.ds files were generated. In this case I used the
0783<sub>0204730301</sub><sub>EPN</sub><sub>U003</sub><sub>TimingEvts</sub>.ds.
</p>

<p>
At this point flares must be removed if they exist.
In this instance there were no flares so they were not removed.
</p>
</div>
</div>
<div id="outline-container-sec-2-5-2" class="outline-4">
<h4 id="sec-2-5-2"><span class="section-number-4">2.5.2</span> Flare removal</h4>
<div class="outline-text-4" id="text-2-5-2">
<p>
&#x2013;&#x2014;NOTE this has not yet been run and should be done soon (21.2.17)
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n no flares removed'</span>
cp PN.fits EPICclean.fits

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n\n MAKE IMAGE...'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withimageset</span>=yes <span style="color: #a0522d;">imageset</span>=EPICclean_image.fits <span style="color: #a0522d;">xcolumn</span>=RAWX <span style="color: #a0522d;">ycolumn</span>=RAWY <span style="color: #a0522d;">imagebinning</span>=binSize <span style="color: #a0522d;">ximagebinsize</span>=1 <span style="color: #a0522d;">yimagebinsize</span>=1
ds9 EPICclean_image.fits &amp;
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\nImage created. Please note down a source and background range of pixels.'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-5-3" class="outline-4">
<h4 id="sec-2-5-3"><span class="section-number-4">2.5.3</span> Extract Source and Background Region</h4>
<div class="outline-text-4" id="text-2-5-3">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nSoft Filter\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in [500:1500])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nHard Filter\n'</span>
evselect <span style="color: #a0522d;">table</span>=EPICclean.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'(FLAG==0)&amp;&amp;(PATTERN&lt;=4)&amp;&amp;(PI in [2000:9000])&amp;&amp;#XMMEA_EP'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\n Extract src and bg\n\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Source from Soft Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft_src.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [31:45]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Source from Hard Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard_src.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [31:45]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Background from Soft Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_soft_bkg.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [3:5]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Extract Background from Hard Photons'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard.fits <span style="color: #a0522d;">withfilteredset</span>=yes <span style="color: #a0522d;">filteredset</span>=PN_time_hard_bkg.fits <span style="color: #a0522d;">filtertype</span>=expression <span style="color: #a0522d;">expression</span>=<span style="color: #8b2252;">'RAWX in [3:5]'</span> <span style="color: #a0522d;">keepfilteroutput</span>=yes <span style="color: #a0522d;">updateexposure</span>=yes <span style="color: #a0522d;">filterexposure</span>=yes
</pre>
</div>



<p>
Delete below eventually
</p>
</div>
</div>
<div id="outline-container-sec-2-5-4" class="outline-4">
<h4 id="sec-2-5-4"><span class="section-number-4">2.5.4</span> Make Light Curves</h4>
<div class="outline-text-4" id="text-2-5-4">
<p>
Note the time bin size here.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate Lightcurve from source\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from soft photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft_src.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_soft_src_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from hard photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard_src.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_hard_src_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from Background\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from soft photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_soft_bkg.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_soft_bkg_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate lc from hard photons\n'</span>
evselect <span style="color: #a0522d;">table</span>=PN_time_hard_bkg.fits <span style="color: #a0522d;">withrateset</span>=yes <span style="color: #a0522d;">rateset</span>=PN_time_hard_bkg_lc.fits <span style="color: #a0522d;">maketimecolumn</span>=yes <span style="color: #a0522d;">timecolumn</span>=TIME <span style="color: #a0522d;">timebinsize</span>=0.01 <span style="color: #a0522d;">makeratecolumn</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nCreate Background Subtracted Light Curve\n'</span>

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nFrom soft photons (10 mins)\n'</span>
epiclccorr <span style="color: #a0522d;">srctslist</span>=PN_time_soft_src_lc.fits <span style="color: #a0522d;">eventlist</span>=EPICclean.fits <span style="color: #a0522d;">outset</span>=PN_time_soft_lccorr.fits <span style="color: #a0522d;">bkgtslist</span>=PN_time_soft_bkg_lc.fits <span style="color: #a0522d;">withbkgset</span>=yes <span style="color: #a0522d;">applyabsolutecorrections</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'\n\nFrom hard photons (10 mins)\n'</span>
epiclccorr <span style="color: #a0522d;">srctslist</span>=PN_time_hard_src_lc.fits <span style="color: #a0522d;">eventlist</span>=EPICclean.fits <span style="color: #a0522d;">outset</span>=PN_time_hard_lccorr.fits <span style="color: #a0522d;">bkgtslist</span>=PN_time_hard_bkg_lc.fits <span style="color: #a0522d;">withbkgset</span>=yes <span style="color: #a0522d;">applyabsolutecorrections</span>=yes

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Display the lightcurve'</span>

dsplot <span style="color: #a0522d;">table</span>=PN_time_soft_lccorr.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;
dsplot <span style="color: #a0522d;">table</span>=PN_time_hard_lccorr.fits <span style="color: #a0522d;">x</span>=TIME <span style="color: #a0522d;">y</span>=RATE &amp;

<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Note that the above lightcurves can be chopped with the evselect timemin and timemax command'</span>
</pre>
</div>

<p>
This observation is combined with another 2004 observation
(0204730301) so the plots are not shown here.
</p>
</div>
</div>
<div id="outline-container-sec-2-5-5" class="outline-4">
<h4 id="sec-2-5-5"><span class="section-number-4">2.5.5</span> Produce Lag-Frequency Plots</h4>
<div class="outline-text-4" id="text-2-5-5">
<p>
Begin by downloading a template
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"\n\n\nProduce lagfreq script\n\n\n"</span>
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/isis_lagfreq_script.sl .
emacs isis_lagfreq_script.sl &amp;
</pre>
</div>

<p>
Edit this file accordingly (update OBSID and frequency ranges if
necessary). Then run the file analysis in isis. The one used in this
case is shown in the following in a separate section <a href="#sec-2-5-7">here</a>.
</p>

<div class="org-src-container">

<pre class="src src-sh">isis isis_lagfreq_script.sl
<span style="color: #a020f0;">exit</span>;
</pre>
</div>

<p>
The output from this is shown in Figure <a href="#LagFreq">18</a>.
</p>


<div id="LagFreq" class="figure">
<p><img src="./02047303013/PROC/lagfreq.gif" alt="lagfreq.gif" />
</p>
<p><span class="figure-number">Figure 35:</span> The lag-frequency graph for 0204730301 (U003) GX339-4 observation</p>
</div>
</div>
</div>

<div id="outline-container-sec-2-5-6" class="outline-4">
<h4 id="sec-2-5-6"><span class="section-number-4">2.5.6</span> Epitropakis Methods*</h4>
<div class="outline-text-4" id="text-2-5-6">
<p>
Following the analysis outlined by Epitropakis in Epitropakis 2016
(Theoretical modelling of the AGN iron-line/continuum time-lags in the
lamp-post geometry), we have calculated the lag frequencies in a new
way and also calculated the coherence. This is outlined below.
</p>

<p>
Coherence/ lagfreq analysis was first tested on this observation. Initially it required splitting up the original observation into segments.
This would be time consuming to do manually so a python script which should do
this was developed in the section <a href="#sec-2-1-11">2.1.11</a>.
</p>

<p>
The python file should be run in the folder which contains the
observation ID folder. The scipt should be run with the observationID,
start time, end time and number of segments as arguments i.e.
</p>

<div class="org-src-container">

<pre class="src src-python">python run_segment_analysis.py 02047303013 196137000 196146000 9
</pre>
</div>

<p>
This generates segment directories (i.e. seg0,seg1) in the same folder
as the ODF and PROC folders are. In the segment directories a bash
script is created. The bash script performs all the filtering and
generates the light curves so will take a long time to run so should
be 'screened'.
</p>

<p>
The python script also outputs a modified lagfreq and coherence script shown here:
<a href="#sec-2-1-12">2.1.12</a>. This is placed with the PROC, segX and ODF
folders. This should be run to produce the lag frequency and coherence
files (as seen below) using the command:
</p>

<div class="org-src-container">

<pre class="src src-example">isis lagfreq_cohfreq_script.sl
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-2-5-6-1" name="sec-2-5-6-1"></a>Epitropakis Results<br  /><div class="outline-text-5" id="text-2-5-6-1">

<div class="figure">
<p><img src="./02047303013/EpitropakisLagFrequency.gif" alt="EpitropakisLagFrequency.gif" />
</p>
<p><span class="figure-number">Figure 36:</span> 0204730301 (U003) binned lag-frequency plot.</p>
</div>


<div class="figure">
<p><img src="./02047303013/CoherenceFrequency.gif" alt="CoherenceFrequency.gif" />
</p>
<p><span class="figure-number">Figure 37:</span> 0204730301 (U003) coherence against frequency plot.</p>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-2-5-7" class="outline-4">
<h4 id="sec-2-5-7"><span class="section-number-4">2.5.7</span> Lag-Frequency Script</h4>
<div class="outline-text-4" id="text-2-5-7">
<pre class="example">
%declare observation ID's
variable obs_id = ["02047303013"];


variable i;
variable j;
variable k;

%declare frequency bins
variable n_bins =21;
variable df_f = 0.5/1.1; %Possibly change bin size to be bigger to exactly emulate DeMarco2015 results.
variable lo = Double_Type[n_bins];
variable hi = Double_Type[n_bins];
lo[0]=0.005;
hi[0]=(lo[0] + lo[0]*df_f);

for(i=1;i&lt;n_bins;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
 }

%logarithmic frequency bin centre
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));

%declare arrays
variable rb_n = Integer_Type[n_bins];
variable lag = Double_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){


%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));

%Pass to new variables:
variable time_soft = lc_soft.time[ix_soft];
variable time_hard = lc_hard.time[ix_hard];
variable rate_soft = lc_soft.rate[ix_soft];
variable rate_hard = lc_hard.rate[ix_hard];
variable error_soft = lc_soft.error[ix_soft];
variable error_hard = lc_hard.error[ix_hard];

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[0:length(dft_soft)-1]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);
variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

%Calculate and sum CPS for each frequency bin in each observation.
for(i=0; i&lt; n_bins; i++)
{
        for (j=0; j&lt;length(freq); j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {
                        g_a_real[i] += abs(dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[i] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[i] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];
                        g_c[i] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];
                        rb_n[i] ++;
                }
        }
}
}

%Plot variables including frequency error bars
variable x = (hi+lo)/2;
variable dxp = hi-x;
variable dxm = x-lo;

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0;i&lt;n_bins;i++)
{
        %Lag error
        g_a[i] = (g_a_real[i]*g_a_real[i] + g_a_imag[i]*g_a_imag[i])/(double(rb_n[i])*double(rb_n[i]));
        g_b[i] /= double(rb_n[i]);
        g_c[i] /= double(rb_n[i]);
        g[i] = g_a[i]/(g_b[i]*g_c[i]);
        delta_phi[i] = sqrt((1.0-g[i])/(2.0*g[i]))/sqrt(double(rb_n[i]));
        delta_lag[i] = delta_phi[i]/(2.0*PI*rb_freq[i]);

        %Lag
        g_a_real[i] /= rb_n[i];
        g_a_imag[i] /= rb_n[i];
        lag[i] = atan2(g_a_imag[i] , g_a_real[i])/(2.0*PI*rb_freq[i]);
}

% Plot results:

open_plot("lagfreq.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0204730301 (U003) lag-frequency ");
connect_points(0);

plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4,dsym=6, xrange=[3e-3,10], yrange=[0.0001,1]);
_pgmove(-10000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

for (i=0; i&lt;length(x); i++) {
  () = printf("%e,%e,%e\n", x[i], lag[i], delta_lag[i]);
}

close_plot;
</pre>
</div>
</div>
<div id="outline-container-sec-2-5-8" class="outline-4">
<h4 id="sec-2-5-8"><span class="section-number-4">2.5.8</span> Segment Analysis Script*</h4>
<div class="outline-text-4" id="text-2-5-8">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">This python program runs the Epitropakis method for analysis of scripts. After this the time lag</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">To run, arguments should be supplied in the order, OBSID, Obs start time, Obs end time and Number of Segments Required. e.g. python segment_analysis.py 0605610201 000000000 999999999 10.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">This MUST be located in the same folder as the other observation IDs are when executed.</span>

<span style="color: #a020f0;">import</span> os,sys

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">main</span>(argv):
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(sys.argv)&lt;4:
               <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">'Add more arguments. Should be in the form:  ObservationID, Observation Start Time, Observation End Time and Number of Segments'</span>
               sys.<span style="color: #008b8b;">exit</span>(2)

        <span style="color: #a0522d;">ObservationID</span> = <span style="color: #483d8b;">int</span>(sys.argv[1]) <span style="color: #b22222;"># </span><span style="color: #b22222;">Import the arguments</span>
        <span style="color: #a0522d;">StartTime</span> = <span style="color: #483d8b;">int</span>(sys.argv[2])
        <span style="color: #a0522d;">EndTime</span> = <span style="color: #483d8b;">int</span>(sys.argv[3])
        <span style="color: #a0522d;">NumberOfSegments</span> = <span style="color: #483d8b;">int</span>(sys.argv[4])

        <span style="color: #a0522d;">TotalTime</span> = EndTime-StartTime <span style="color: #b22222;"># </span><span style="color: #b22222;">Use the times to work out how long each segment will last for</span>
        <span style="color: #a0522d;">AverageSegmentTime</span> = <span style="color: #483d8b;">int</span>(TotalTime/NumberOfSegments)
        <span style="color: #a0522d;">ExtraTime</span> = TotalTime - AverageSegmentTime*NumberOfSegments <span style="color: #b22222;"># </span><span style="color: #b22222;">Calculates if rounding would cause some time to omitted in the analysis.</span>
        <span style="color: #a0522d;">StringNumberOfSegments</span> = <span style="color: #483d8b;">str</span>(NumberOfSegments) <span style="color: #b22222;"># </span><span style="color: #b22222;">Useful to have this as a string later on.</span>

        <span style="color: #a020f0;">for</span> SegmentNumber <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(0,NumberOfSegments): <span style="color: #b22222;"># </span><span style="color: #b22222;">This now begins the analysis for each segment.</span>

            <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"Working on Segment"</span>,SegmentNumber

            <span style="color: #a020f0;">if</span> SegmentNumber != NumberOfSegments: <span style="color: #b22222;"># </span><span style="color: #b22222;">Calculate the segment start and end time.</span>
                <span style="color: #a0522d;">SegmentStartTime</span> = StartTime + (SegmentNumber*AverageSegmentTime)
                <span style="color: #a0522d;">SegmentEndTime</span> = SegmentStartTime + AverageSegmentTime
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a0522d;">SegmentStartTime</span> = StartTime + (SegmentNumber*AverageSegmentTime) + ExtraTime
                <span style="color: #a0522d;">SegmentEndTime</span> = SegmentStartTime + AverageSegmentTime
            <span style="color: #a0522d;">StringObservationID</span> = <span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">str</span>(0)+<span style="color: #483d8b;">str</span>(ObservationID)) <span style="color: #b22222;"># </span><span style="color: #b22222;">When stored as an int the Observation ID loses its initial 0 so this is added.</span>
            <span style="color: #a0522d;">StringSegmentNumber</span> = <span style="color: #483d8b;">str</span>(SegmentNumber)

            os.system(<span style="color: #8b2252;">"mkdir 0%d/seg%d"</span> % (ObservationID,SegmentNumber)) <span style="color: #b22222;"># </span><span style="color: #b22222;">Create the segment root folder</span>

            <span style="color: #a0522d;">f1</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"/data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/SegmentAnalysisTemplateGeneral.tsh"</span>,<span style="color: #8b2252;">"r"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Opens a segment analysis template file.</span>
            <span style="color: #a0522d;">f2</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"0"</span>+<span style="color: #483d8b;">str</span>(ObservationID)+<span style="color: #8b2252;">"/seg"</span>+<span style="color: #483d8b;">str</span>(SegmentNumber)+<span style="color: #8b2252;">"/SegmentAnalysis.tsh"</span>,<span style="color: #8b2252;">"w"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Opens a local version which will be run.</span>
            <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f1: <span style="color: #b22222;"># </span><span style="color: #b22222;">For each line in the template file...</span>
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTSTARTTIME"</span>,<span style="color: #483d8b;">str</span>(SegmentStartTime)) <span style="color: #b22222;">#</span><span style="color: #b22222;">... any instance of the Caps words is replaced with the actual variable.</span>
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTENDTIME"</span>,<span style="color: #483d8b;">str</span>(SegmentEndTime))
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"OBSERVATIONID"</span>,StringObservationID)
                <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"ROOTPATH"</span>,<span style="color: #483d8b;">str</span>(os.getcwd()))
                f2.write(line)
            f1.close()
            f2.close()

            os.chdir(<span style="color: #8b2252;">"0%d/seg%d/"</span> % (ObservationID,SegmentNumber)) <span style="color: #b22222;"># </span><span style="color: #b22222;">The script moves into the folder with the .tsh script in, and runs it, then moves out again.</span>
            os.system(<span style="color: #8b2252;">"tcsh "</span>+<span style="color: #483d8b;">str</span>(os.getcwd())+<span style="color: #8b2252;">"/0%d/seg%d/SegmentAnalysis.tsh"</span> % (ObservationID,SegmentNumber))
            os.chdir(<span style="color: #8b2252;">"../../"</span>)

        <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"The light curves have been produced for each segment.\n"</span>

        <span style="color: #a0522d;">f1</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"/data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/lagfreq_cohfreq_script_template.sl"</span>,<span style="color: #8b2252;">"r"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Open the Epitropakis lag-frequency method template file.</span>
        <span style="color: #a0522d;">f2</span>=<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"0"</span>+<span style="color: #483d8b;">str</span>(ObservationID)+<span style="color: #8b2252;">"/lagfreq_cohfreq_script.sl"</span>,<span style="color: #8b2252;">"w"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">Create a local copy</span>
        <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f1:
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"OBSERVATIONID"</span>,StringObservationID)
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"SEGMENTNUMBER"</span>,StringNumberOfSegments)
             <span style="color: #a0522d;">line</span>=line.replace(<span style="color: #8b2252;">"ROOTPATH"</span>,<span style="color: #483d8b;">str</span>(os.getcwd()))
             f2.write(line)
        f1.close()
        f2.close()


        <span style="color: #a020f0;">print</span> <span style="color: #8b2252;">"The file to calculate coherence (nntest_lagfreq.sl) for observation "</span>+StringObservationID+<span style="color: #8b2252;">" and "</span>+StringNumberOfSegments+<span style="color: #8b2252;">" segments has been generated in the observation ID root folder.\n\nThis should be called manually once the segment folders have been checked using: isis nntest_lagfreq.sl\n"</span>


<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">"__main__"</span>:
        main(sys.argv[4:])
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-5-9" class="outline-4">
<h4 id="sec-2-5-9"><span class="section-number-4">2.5.9</span> Coherence Analysis Script*</h4>
<div class="outline-text-4" id="text-2-5-9">
<pre class="example">
%declare observation ID's
variable obs_id = ["02047303013"];

variable obs_segs = [9];

variable i;
variable j;
variable k;
variable n;

% declare frequency bins
variable re_bin_f = 21; % with binninng
variable df_f = 0.5/1.1;
variable lo_bin_f = 5e-3;

%declare the number of frequency bins
variable n_bins = 15000; % without binning

%declare arrays
variable lag = Double_Type[n_bins];
variable rb_n = Integer_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_real_2 = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_a_2 = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable coh = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];
variable delta_coh = Double_Type[n_bins];

variable seg_length = 20000;
variable seg_min = 20000;

for(k=0; k&lt;length(obs_id); k++){
        for (n=0; n&lt;obs_segs[k]; n++)
        {
                () = chdir("/data/cluster/XRayReverb2016/HarryData/GX339-4/"+obs_id[k] + sprintf("/seg%i", n));
                variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
                variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");
                variable ix_soft = where(not isnan(lc_soft.rate));
                variable ix_hard = where(not isnan(lc_hard.rate));

                if(length(ix_soft) &lt; seg_min)
                {
                        seg_length = length(ix_soft);
                }
                seg_min = seg_length;
                vmessage("check data: " + obs_id[k] + sprintf("/seg%i", n) + sprintf("  length= %i",  length(ix_soft)));
        }
}
vmessage("****set seg_length =%i", seg_length);

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){
for (n=0; n&lt;obs_segs[k]; n++){

() = chdir( "/data/cluster/XRayReverb2016/HarryData/GX339-4/" +obs_id[k] + sprintf("/seg%i", n));
%vmessage( obs_id[k] + sprintf("/seg%i", n));

%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));
variable rate_soft = Double_Type[seg_length];
variable rate_hard = Double_Type[seg_length];
variable time_soft = Double_Type[seg_length];
variable time_hard = Double_Type[seg_length];
variable error_soft = Double_Type[seg_length];
variable error_hard = Double_Type[seg_length];

%Pass to new variables:
variable o_time_soft = lc_soft.time[ix_soft];
variable o_time_hard = lc_hard.time[ix_hard];
variable o_rate_soft = lc_soft.rate[ix_soft];
variable o_rate_hard = lc_hard.rate[ix_hard];
variable o_error_soft = lc_soft.error[ix_soft];
variable o_error_hard = lc_hard.error[ix_hard];

for(j=0; j&lt;seg_length; j++)
{
        rate_soft[j] = o_rate_soft[j];
        rate_hard[j] = o_rate_hard[j];
        time_soft[j] = o_time_soft[j];
        time_hard[j] = o_time_hard[j];
        error_soft[j] = o_error_soft[j];
        error_hard[j] = o_error_hard[j];


}

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[1:length(dft_soft)]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);

variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

% Adjust frequency bins
variable x = Double_Type[n_bins];
variable dxp = Double_Type[n_bins];
variable dxm = Double_Type[n_bins];
for(i=1;i&lt;n_bins;i++)
{
        x[i] = freq[i];
        dxp[i] = (freq[i+1] - x[i])/2;
        dxm[i] = (x[i] - freq[i-1])/2;
}

variable lo = Double_Type[re_bin_f];
variable hi = Double_Type[re_bin_f];
lo[0]=lo_bin_f;
hi[0]=(lo[0] + lo[0]*df_f);
for(i=1;i&lt;re_bin_f;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
}
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));
variable x_bin = (hi+lo)/2;
variable dxp_bin = hi-x_bin;
variable dxm_bin = x_bin-lo;

%Calculate and sum CPS for each frequency bin in each observation.
for(j=0; j&lt; n_bins; j++)
{
                        %() = printf("j= %i freq= %e\n", j, freq[j]);
                        g_a_real[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_real_2[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[j] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[j] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];	% Periodrogram s
                        g_c[j] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];	% Periodrogram h
                        rb_n[j] ++;
                
}
}
}

%Plot variables including frequency error bars
for(j=0; j&lt; n_bins; j++)
{
        g_a_real[j] = g_a_real[j]/rb_n[j];
        g_a_real_2[j] = g_a_real_2[j] /rb_n[j];
        g_a_imag[j] = g_a_imag[j]/rb_n[j];
        g_a[j] = (g_a_real[j]*g_a_real[j] + g_a_imag[j]*g_a_imag[j]);
        g_a_2[j] = (g_a_real_2[j]*g_a_real_2[j] + g_a_imag[j]*g_a_imag[j]);
        g_b[j] = g_b[j]/rb_n[j];
        g_c[j] = g_c[j]/rb_n[j];
        g[j] = g_a[j]/(g_b[j]*g_c[j]);
        coh[j] = g_a_2[j]/(g_b[j]*g_c[j]);
        delta_phi[j] = sqrt((1.0-g[j])/(2.0*g[j]))/sqrt(double(rb_n[j]));	
        delta_lag[j] = delta_phi[j]/(2.0*PI*freq[j]);
        delta_coh[j] = 0.0; 

        lag[j] = atan2(g_a_imag[j] , g_a_real[j])/(2.0*PI*freq[j]);
}


variable fb_n = Integer_Type[re_bin_f];
variable n_est = Integer_Type[re_bin_f];

variable lag_bin = Double_Type[re_bin_f];
variable g_a_real_bin = Double_Type[re_bin_f];
variable g_a_real_2_bin = Double_Type[re_bin_f];
variable g_a_imag_bin = Double_Type[re_bin_f];
variable g_a_bin = Double_Type[re_bin_f];
variable g_a_2_bin = Double_Type[re_bin_f];
variable g_b_bin = Double_Type[re_bin_f];
variable g_c_bin = Double_Type[re_bin_f];
variable g_bin = Double_Type[re_bin_f];
variable delta_phi_bin = Double_Type[re_bin_f];
variable delta_lag_bin = Double_Type[re_bin_f];
variable delta_coh_bin = Double_Type[re_bin_f];

for(i=0; i&lt; re_bin_f; i++)
{
        for (j=0; j&lt;n_bins; j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {
                        g_a_real_bin[i] += g_a_real[j];
                        g_a_real_2_bin[i] += g_a_real_2[j];
                        g_a_imag_bin[i] += g_a_imag[j];
                        g_b_bin[i] += g_b[j];
                        g_c_bin[i] += g_c[j];
                        fb_n[i]++;
                        n_est[i] += rb_n[j];
                }
        }
}

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0; i&lt;re_bin_f; i++)
{
        %Lag error
        g_a_real_bin[i] /= fb_n[i];
        g_a_imag_bin[i] /= fb_n[i];
        g_a_bin[i] = (g_a_real_bin[i]*g_a_real_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_a_2_bin[i] = (g_a_real_2_bin[i]*g_a_real_2_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_b_bin[i] /= double(fb_n[i]);
        g_c_bin[i] /= double(fb_n[i]);
        g_bin[i] = g_a_bin[i]/(g_b_bin[i]*g_c_bin[i]);
        delta_phi_bin[i] = sqrt((1.0-g_bin[i])/(2.0*g_bin[i]))/sqrt(double(n_est[i]));	
        delta_lag_bin[i] = delta_phi_bin[i]/(2.0*PI*rb_freq[i]);
        lag_bin[i] = atan2(g_a_imag_bin[i] , g_a_real_bin[i])/(2.0*PI*rb_freq[i]);
}


() = chdir( "/data/cluster/XRayReverb2016/HarryData/GX339-4/"+obs_id[0] );

% Plot coherence results:

open_plot("CoherenceFrequency.gif/gif");

%window(1);
xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Coherence");
title("GX339-4 0204730301 (U003) Coherence");
connect_points(0);
_pgsfs(3);

plotxy(x,dxm,dxp,coh,delta_coh,delta_coh; dcol=1, decol=4, dsym=6, xrange=[3e-1,10],yrange=[0.1,2]);	% coherence

_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

%Coherence value (horzontal) line (this should be fixed)
_pgmove(log10(0.00001), log10(1.2/(1+(0.2*obs_segs[0]))));
_pgsls(3); % line style?
_pgsci(3); % colour 1- black, 2-red, 3 - green
_pgslw(4); % line width?
_pgdraw(log10(100), log10(1.2/(1+(0.2*obs_segs[0]))));

% Vertical max freq line (this should be changed once run both here and below )
_pgmove(log10(1), log10(1e-4) );
_pgsls(2);
_pgsci(2);
_pgslw(4);
_pgdraw(log10(1), log10(1e2));

close_plot;



%Display the lag-freq values
for (i=0; i&lt;re_bin_f; i++) {
  () = printf("%e,  %e,  %e\n", x_bin[i], lag_bin[i], delta_lag[i]);
}



% Plot binned Lag-freq results:
%window(1);

open_plot("EpitropakisLagFrequency.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0204730301 (U003) Lag-Frequency");
connect_points(0);
_pgsfs(3);

plotxy(x_bin,dxm_bin,dxp_bin,lag_bin,delta_lag_bin,delta_lag_bin; dcol=1, decol=4, dsym=6,  xrange=[3e-3,10],yrange=[1e-4,1]);	% binned f lags
_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

% Vertical max freq line
_pgmove(log10(1), log10(1e-4) );
_pgsls(2);
_pgsci(2);
_pgslw(4);
_pgdraw(log10(1), log10(1e2));


close_plot;









% Plot unbinned Lag-freq results:
%window(1);

open_plot("EpitropakisUnbinnedLagFrequency.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 02047303013 Unbinned Lag-Frequency");
connect_points(0);
_pgsfs(3);

%plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4, dsym=6, xrange=[3e-3,10],yrange=[1e-4,1]);	% unbinned f lags
_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

% Vertical max freq line
%_pgmove(-2.721,-1400); % 0.3-4k
%_pgmove(-3.284,-600); % 2-7k
%_pgsls(2);
%_pgsci(2);
%_pgslw(4);
%_pgdraw(-2.721,1400); % 0.3-4k
%_pgdraw(-3.284,600); % 2-7k

close_plot;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6"><span class="section-number-3">2.6</span> 0204730201-024730301 Merger Analysis</h3>
<div class="outline-text-3" id="text-2-6">
</div>

<div id="outline-container-sec-2-6-1" class="outline-4">
<h4 id="sec-2-6-1"><span class="section-number-4">2.6.1</span> Produce Lag-Frequency Plots</h4>
<div class="outline-text-4" id="text-2-6-1">
<p>
The 2004 observations were split into 3 individual observations,
0204730201, 0204730301(U002) and 0204730301(U003). We have analysed
this in 2 different ways
</p>
</div>

<ol class="org-ol"><li><a id="sec-2-6-1-1" name="sec-2-6-1-1"></a>Combining 0204730201 and 0204730301 (U002)<br  /><div class="outline-text-5" id="text-2-6-1-1">
<p>
Begin by downloading a template
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"\n\n\nProduce lagfreq script\n\n\n"</span>
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/lagfreq_comb_script.sl .
emacs lagfreq_comb_script.sl &amp;
</pre>
</div>

<p>
Edit this file accordingly (update obs<sub>id</sub> at the top, frequency
range and plotting range if necessary).
</p>

<p>
Then run the file analysis in isis. This can take some time so in this
case was run on 'screen'.
</p>

<div class="org-src-container">

<pre class="src src-sh">isis lagfreq_comb_script.sl
</pre>
</div>

<p>
The exact script used in this case is shown <a href="#sec-2-6-3">here</a>.
</p>

<p>
The output from this is shown in Figure <a href="#LagFreq0201">38</a>.
</p>


<div id="LagFreq0201" class="figure">
<p><img src="./0204730201-0204730301-Merger/PROC/lagfreq_comb.gif" alt="lagfreq_comb.gif" />
</p>
<p><span class="figure-number">Figure 38:</span> The lag-frequency graph for intermediate luminosity GX339-4 observation (2004)</p>
</div>

<p>
The isis output is shown below:
</p>

<pre class="example">
1.084091e-02,8.458086e-01,9.057099e-02
1.527583e-02,7.578205e-01,5.604016e-02
2.152503e-02,6.363542e-01,3.626097e-02
3.033072e-02,4.419411e-01,2.166326e-02
4.273874e-02,3.098747e-01,1.304779e-02
6.022278e-02,2.113156e-01,9.757407e-03
8.485937e-02,1.898071e-01,7.305753e-03
1.195746e-01,1.430079e-01,5.517594e-03
1.684914e-01,1.177160e-01,4.054351e-03
2.374197e-01,8.389536e-02,2.898480e-03
3.345460e-01,5.779193e-02,1.982350e-03
4.714057e-01,3.798893e-02,1.295411e-03
6.642535e-01,2.285164e-02,8.376256e-04
9.359936e-01,1.235038e-02,5.539524e-04
1.318900e+00,6.468557e-03,3.615792e-04
1.858450e+00,2.657771e-03,2.314529e-04
2.618725e+00,1.315540e-03,1.474928e-04
3.690022e+00,5.405266e-04,9.260190e-05
5.199576e+00,1.419408e-04,5.721277e-05
7.326675e+00,1.034165e-04,3.479239e-05
1.032395e+01,-3.358470e-05,2.099691e-05

1.454739e+01,-1.224354e-05,1.259253e-05
2.049859e+01,-1.692924e-06,7.540973e-06
2.888438e+01,-1.369443e-06,4.510296e-06
4.070071e+01,-9.086677e-07,2.694211e-06
5.735100e+01,-2.386007e-07,1.611676e-06
8.081278e+01,6.175347e-07,9.607333e-07
1.138726e+02,-8.470029e-05,9.826510e-07
1.604568e+02,-nan,-nan
2.260982e+02,-nan,-nan
3.185929e+02,-nan,-nan
4.489264e+02,-nan,-nan
6.325781e+02,-nan,-nan
8.913600e+02,-nan,-nan
1.256007e+03,-nan,-nan
1.769828e+03,-nan,-nan
2.493849e+03,-nan,-nan
3.514060e+03,-nan,-nan
4.951630e+03,-nan,-nan
</pre>
</div>
</li>

<li><a id="sec-2-6-1-2" name="sec-2-6-1-2"></a>Combining 0204730201 and 0204730301 (U002) and 0204730301 (U003)<br  /><div class="outline-text-5" id="text-2-6-1-2">
<p>
Begin by downloading a template
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"\n\n\nProduce lagfreq script\n\n\n"</span>
cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/lagfreq_comb_script.sl lagfreq_comb_script2.sl
emacs lagfreq_comb_script2.sl &amp;
</pre>
</div>

<p>
Edit this file accordingly (update <code>obs_id</code> at the top, frequency
range and plotting range if necessary).
</p>

<p>
Then run the file analysis in isis. This can take some time so in this
case was run on 'screen'.
</p>

<div class="org-src-container">

<pre class="src src-sh">isis lagfreq_comb_script2.sl
</pre>
</div>

<p>
The exact script used in this case is shown <a href="#sec-2-6-3">here</a>.
</p>

<p>
The output from this is shown in Figure <a href="#LagFreq0202">39</a>.
</p>


<div id="LagFreq0202" class="figure">
<p><img src="./0204730201-0204730301-Merger/PROC/lagfreq_comb2.gif" alt="lagfreq_comb2.gif" />
</p>
<p><span class="figure-number">Figure 39:</span> The lag-frequency graph for intermediate luminosity GX339-4 observation (2004)</p>
</div>

<p>
The isis output is shown below:
</p>

<pre class="example">
1.084091e-02,8.487772e-01,8.875940e-02
1.527583e-02,7.594899e-01,5.512426e-02
2.152503e-02,6.358385e-01,3.553854e-02
3.033072e-02,4.457613e-01,2.124952e-02
4.273874e-02,3.091423e-01,1.287038e-02
6.022278e-02,2.098004e-01,9.571196e-03
8.485937e-02,1.892808e-01,7.157661e-03
1.195746e-01,1.450090e-01,5.420775e-03
1.684914e-01,1.171961e-01,3.982510e-03
2.374197e-01,8.420025e-02,2.852981e-03
3.345460e-01,5.803622e-02,1.951757e-03
4.714057e-01,3.803806e-02,1.277528e-03
6.642535e-01,2.303184e-02,8.261314e-04
9.359936e-01,1.232497e-02,5.466518e-04
1.318900e+00,6.515452e-03,3.572081e-04
1.858450e+00,2.687983e-03,2.287742e-04
2.618725e+00,1.293267e-03,1.457677e-04
3.690022e+00,5.487086e-04,9.156112e-05
5.199576e+00,1.462313e-04,5.658787e-05
7.326675e+00,1.090404e-04,3.440924e-05
1.032395e+01,-3.371989e-05,2.075898e-05
1.454739e+01,-1.324453e-05,1.244883e-05
2.049859e+01,-1.969547e-06,7.453835e-06
2.888438e+01,-1.681641e-06,4.458877e-06
4.070071e+01,-1.102665e-06,2.663367e-06
5.735100e+01,-7.069939e-08,1.593174e-06
8.081278e+01,6.217176e-07,9.497996e-07
1.138726e+02,-8.514731e-05,9.680862e-07
1.604568e+02,-nan,-nan
2.260982e+02,-nan,-nan
3.185929e+02,-nan,-nan
4.489264e+02,-nan,-nan
6.325781e+02,-nan,-nan
8.913600e+02,-nan,-nan
1.256007e+03,-nan,-nan
1.769828e+03,-nan,-nan
2.493849e+03,-nan,-nan
3.514060e+03,-nan,-nan
4.951630e+03,-nan,-nan
</pre>
</div>
</li></ol>
</div>


<div id="outline-container-sec-2-6-2" class="outline-4">
<h4 id="sec-2-6-2"><span class="section-number-4">2.6.2</span> 2-Blobs Model Fitting</h4>
<div class="outline-text-4" id="text-2-6-2">
<p>
As a trial, we attempted to run a 2-Blobs model fit to the data. This
will test the mechanics, and allow us to eventually implement the
spherical corona model more easily.
</p>

<p>
First, copy the <code>create_spectra.py</code> script from the Shared data area,
and open it.
</p>

<div class="org-src-container">

<pre class="src src-sh">cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/create_spectra.py .
emacs create_spectra.py &amp;
</pre>
</div>

<p>
There is code which looks like this:
</p>

<pre class="example">
# Time lag values
time_lag = np.array([60.0, 50.0, -80.0, -70.0, -40.0, -20.0, 10.0, 0.0, 2.0, -1.0])
time_lag_err = np.array([110.0, 50.0, 50.0, 40.0, 30.0, 20.0, 10.0, 5.0, 5.0, 5.0])

# Frequency bins should be contiguous with no gaps between them
freq_low = np.array([7e-5, 2e-4, 3e-4, 5e-4, 8e-4, 1e-3, 2e-3, 3e-3, 4e-3, 8e-3])
freq_high = np.array([2e-4, 3e-4, 5e-4, 8e-4, 1e-3, 2e-3, 3e-3, 4e-3, 8e-3, 1e-2])
</pre>

<p>
This needs to edited to reflect what the output from isis was, when
the lag-freq plots were made. This can be tedious so we have developed
an Excel file which takes the isis values and turns them into the
style as shown above, which has dramatically improved this.
</p>

<p>
<code>create_spectra</code> can now be run. Note: it may be necessary to install packages. To
do so on the Starlink computers do: <code>pip install astropy --user</code>
</p>

<p>
You may also need to run a earlier version of python. I did this by
adding an alias to <code>python2.7</code> in my <code>.cshrc</code> but should look for a more
permanent fix in the future.
</p>

<p>
Once working run&#x2026;
</p>

<div class="org-src-container">

<pre class="src src-python">python create_spectra.py
</pre>
</div>

<p>
isis can be used to plot the points to check the output.
</p>

<div class="org-src-container">

<pre class="src src-sh">isis
<span style="color: #a0522d;">Ignore_PHA_Response_Keywords</span> = 1;
<span style="color: #a0522d;">d</span>=load_data(<span style="color: #8b2252;">"time_lags.fits"</span>);
<span style="color: #a0522d;">r</span>=load_rmf(<span style="color: #8b2252;">"time_lags.rsp"</span>);
assign_rmf(1,1);
xlog;
ylog;
plot_data(d; <span style="color: #a0522d;">xlabel</span>=<span style="color: #8b2252;">"Frequency (Hz)"</span>, <span style="color: #a0522d;">ylabel</span>=<span style="color: #8b2252;">"Time lag (s)"</span>);
_pgmove(-10000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);
</pre>
</div>

<p>
Now copy the .par file and edit it accordingly (i.e. the log mass value)
</p>
<div class="org-src-container">

<pre class="src src-sh"> cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/scale_tlag.par .
emacs scale_tlag.sl &amp;
</pre>
</div>

<p>
Now copy and edit the table setup file, and edit it accordingly. (i.e.
.fits, .rsp and table model path which may be /data/cluster/steff)
</p>
<div class="org-src-container">

<pre class="src src-sh">cp /data/cluster/XRayReverb2016/SharedData/UpdatedAnalysisScripts/setup_table.sl .
emacs setup_table.sl &amp;
</pre>
</div>

<p>
Now run this.
</p>

<pre class="example">
isis setup_table.sl
</pre>

<p>
&#x2014; waiting on better fit model as current one is in wrong energy
range (probably)
</p>
</div>
</div>

<div id="outline-container-sec-2-6-3" class="outline-4">
<h4 id="sec-2-6-3"><span class="section-number-4">2.6.3</span> Lag-Comb Scripts</h4>
<div class="outline-text-4" id="text-2-6-3">
<p>
This is the script used to combine  0204730201 and 0204730301 (U002).
</p>
<pre class="example">
%declare observation ID's
variable obs_id = ["0204730201","02047303012"];

variable i;
variable j;
variable k;

%declare frequency bins
variable n_bins = 39;
variable df_f = 0.45/1.1;
variable lo = Double_Type[n_bins];
variable hi = Double_Type[n_bins];
lo[0]=0.009;
hi[0]=(lo[0] + lo[0]*df_f);

for(i=1;i&lt;n_bins;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
 }

%logarithmic frequency bin centre
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));

%declare arrays
variable rb_n = Integer_Type[n_bins];
variable lag = Double_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){

() = chdir("/data/cluster/XRayReverb2016/HarryData/GX339-4/" + obs_id[k] + "/PROC");
 
%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));

%Pass to new variables:
variable time_soft = lc_soft.time[ix_soft];
variable time_hard = lc_hard.time[ix_hard];
variable rate_soft = lc_soft.rate[ix_soft];
variable rate_hard = lc_hard.rate[ix_hard];
variable error_soft = lc_soft.error[ix_soft];
variable error_hard = lc_hard.error[ix_hard];

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[0:length(dft_soft)-1]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);
variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

%Calculate and sum CPS for each frequency bin in each observation.
for(i=0; i&lt; n_bins; i++)
{
        for (j=0; j&lt;length(freq); j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {		
                        g_a_real[i] += abs(dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[i] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[i] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];
                        g_c[i] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];
                        rb_n[i] ++;
                }
        }
}
}

%Plot variables including frequency error bars
variable x = (hi+lo)/2;
variable dxp = hi-x;
variable dxm = x-lo;

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0;i&lt;n_bins;i++)
{
        %Lag error
        g_a[i] = (g_a_real[i]*g_a_real[i] + g_a_imag[i]*g_a_imag[i])/(double(rb_n[i])*double(rb_n[i]));
        g_b[i] /= double(rb_n[i]);
        g_c[i] /= double(rb_n[i]);
        g[i] = g_a[i]/(g_b[i]*g_c[i]);
        delta_phi[i] = sqrt((1.0-g[i])/(2.0*g[i]))/sqrt(double(rb_n[i]));
        delta_lag[i] = delta_phi[i]/(2.0*PI*rb_freq[i]);

        %Lag
        g_a_real[i] /= rb_n[i];
        g_a_imag[i] /= rb_n[i];
        lag[i] = atan2(g_a_imag[i] , g_a_real[i])/(2.0*PI*rb_freq[i]);
}

% Plot results:
%change to combined directory
() = chdir("/data/cluster/XRayReverb2016/HarryData/GX339-4/0204730201-0204730301-Merger/PROC");
open_plot("lagfreq_comb.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0204730201-024730301 Combined lag-frequency &gt;0.09 Hz"); 
connect_points(0);
_pgsfs(3);
plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4, dsym=6, xrange=[0.009,10],yrange=[0.00001,1]);
_pgmove(-10000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

for (i=0; i&lt;length(x); i++) {
  () = printf("%e,%e,%e\n", x[i], lag[i], delta_lag[i]);
}
close_plot;
</pre>
<p>
This is the script used to combine 0204730201 and 0204730301 (U002)
and 0204730301 (U003).
</p>
<pre class="example">
%This script is '2' because it combines both 0204730301 observations
%declare observation ID's
variable obs_id = ["0204730201","02047303012","02047303013"];

variable i;
variable j;
variable k;

%declare frequency bins
variable n_bins = 39;
variable df_f = 0.45/1.1;
variable lo = Double_Type[n_bins];
variable hi = Double_Type[n_bins];
lo[0]=0.009;
hi[0]=(lo[0] + lo[0]*df_f);

for(i=1;i&lt;n_bins;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
 }

%logarithmic frequency bin centre
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));

%declare arrays
variable rb_n = Integer_Type[n_bins];
variable lag = Double_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){

() = chdir("/data/cluster/XRayReverb2016/HarryData/GX339-4/" + obs_id[k] + "/PROC");
 
%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));

%Pass to new variables:
variable time_soft = lc_soft.time[ix_soft];
variable time_hard = lc_hard.time[ix_hard];
variable rate_soft = lc_soft.rate[ix_soft];
variable rate_hard = lc_hard.rate[ix_hard];
variable error_soft = lc_soft.error[ix_soft];
variable error_hard = lc_hard.error[ix_hard];

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[0:length(dft_soft)-1]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);
variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

%Calculate and sum CPS for each frequency bin in each observation.
for(i=0; i&lt; n_bins; i++)
{
        for (j=0; j&lt;length(freq); j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {		
                        g_a_real[i] += abs(dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[i] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[i] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];
                        g_c[i] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];
                        rb_n[i] ++;
                }
        }
}
}

%Plot variables including frequency error bars
variable x = (hi+lo)/2;
variable dxp = hi-x;
variable dxm = x-lo;

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0;i&lt;n_bins;i++)
{
        %Lag error
        g_a[i] = (g_a_real[i]*g_a_real[i] + g_a_imag[i]*g_a_imag[i])/(double(rb_n[i])*double(rb_n[i]));
        g_b[i] /= double(rb_n[i]);
        g_c[i] /= double(rb_n[i]);
        g[i] = g_a[i]/(g_b[i]*g_c[i]);
        delta_phi[i] = sqrt((1.0-g[i])/(2.0*g[i]))/sqrt(double(rb_n[i]));
        delta_lag[i] = delta_phi[i]/(2.0*PI*rb_freq[i]);

        %Lag
        g_a_real[i] /= rb_n[i];
        g_a_imag[i] /= rb_n[i];
        lag[i] = atan2(g_a_imag[i] , g_a_real[i])/(2.0*PI*rb_freq[i]);
}

% Plot results:
%change to combined directory
() = chdir("/data/cluster/XRayReverb2016/HarryData/GX339-4/0204730201-0204730301-Merger/PROC");
open_plot("lagfreq_comb2.gif/gif");

xlog;
ylog;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
title("GX339-4 0204730201-024730301 (U002 and U003)Combined lag-frequency &gt;0.09 Hz"); 
connect_points(0);
_pgsfs(3);
plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4, dsym=6, xrange=[0.009,10],yrange=[0.00001,1]);
_pgmove(-10000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

for (i=0; i&lt;length(x); i++) {
  () = printf("%e,%e,%e\n", x[i], lag[i], delta_lag[i]);
}
close_plot;
</pre>
</div>
</div>
<div id="outline-container-sec-2-6-4" class="outline-4">
<h4 id="sec-2-6-4"><span class="section-number-4">2.6.4</span> Script to make spectra</h4>
<div class="outline-text-4" id="text-2-6-4">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!  /opt/data.cluster/astrosoft/lib/python2.7/</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">! alternative /usr/bin/python</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Script to create a "spectrum" corresponding to lag-frequency plots</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">and a response matrix containing the frequency binning</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Spectra are usually plotted as energy on x-axis and counts / s / keV on y-axis</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Our x-axis will correspond to Frequency (Hz)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Our y-axis will correspond to Time lag (sec)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">This means our y values need to be multiplied by the bin width</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">The "exposure time" is set to one second</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Note steff's method: ##! /opt/local/bin/python3.5</span>

<span style="color: #a020f0;">from</span> astropy.io <span style="color: #a020f0;">import</span> fits
<span style="color: #a020f0;">import</span> numpy <span style="color: #a020f0;">as</span> np

<span style="color: #b22222;"># </span><span style="color: #b22222;">Time lag values</span>
<span style="color: #a0522d;">time_lag</span> = np.array([0.85, 0.76, 0.64, 0.44, 0.31, 0.21, 0.19, 0.14, 0.12, 0.084, 0.058, 0.038, 0.023, 0.012, 0.0065, 0.0027, 0.0013, 0.00054, 0.00014, 0.00010, -0.000033])
<span style="color: #a0522d;">time_lag_err</span> = np.array([0.091,0.056,0.036,0.021,0.013,0.0098,0.0073,0.0055,0.0041,0.0029,0.002,0.0013,0.00084,0.00055,0.00036,0.00023,0.00015,0.000093,0.000057,0.000034,0.000021])

<span style="color: #b22222;"># </span><span style="color: #b22222;">Frequency bins should be contiguous with no gaps between them</span>
<span style="color: #a0522d;">freq_low</span> = np.array([1.05e-2, 1.25e-2,1.75e-2,2.5e-2,3.5e-2,5.0e-2,7.0e-2,1e-1,1.4e-1,1.9e-1,2.6e-1,3.8e-1,5.5e-1,7.2e-1,1.1,1.5,3.0,4.3,6.0,8.0,11.0])
<span style="color: #a0522d;">freq_high</span> = np.array([ 1.25e-2,1.75e-2,2.5e-2,3.5e-2,5.0e-2,7.0e-2,1e-1,1.4e-1,1.9e-1,2.6e-1,3.8e-1,5.5e-1,7.2e-1,1.1,1.5,3.0,4.3,6.0,8.0,11.0,12.0])

<span style="color: #b22222;"># </span><span style="color: #b22222;">freq high missing a point? freq_high = np.array([1.25e-2,1.75e-2,2.5e-2,3.5e-2,5.0e-2,7.0e-2,1e-1,1.4e-1,1.9e-1,2.6e-1,3.8e-1,5.5e-1,7.2e-1,1.1,1.5,3.0,4.3,6.0,8.0,11.0])</span>


<span style="color: #b22222;"># </span><span style="color: #b22222;">Name of output file stem (.fits and .rsp get added to this stem)</span>
<span style="color: #a0522d;">output_file</span> = <span style="color: #8b2252;">'time_lags'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Multiply lags and associated errors by bin widths</span>
<span style="color: #a0522d;">time_lag</span> = time_lag * (freq_high - freq_low)
<span style="color: #a0522d;">time_lag_err</span> = time_lag_err  * (freq_high - freq_low)

<span style="color: #b22222;"># </span><span style="color: #b22222;">Create the "spectrum"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">See http://heasarc.gsfc.nasa.gov/docs/heasarc/ofwg/docs/spectra/ogip_92_007/ogip_92_007.html</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">And the example on that site too</span>

<span style="color: #a0522d;">channels</span> = np.arange(1, <span style="color: #483d8b;">len</span>(time_lag)+1)
<span style="color: #a0522d;">zeros</span> = np.zeros(<span style="color: #483d8b;">len</span>(time_lag))
<span style="color: #a0522d;">ones</span> = np.ones(<span style="color: #483d8b;">len</span>(time_lag))

<span style="color: #a0522d;">col1</span> = fits.Column(name=<span style="color: #8b2252;">'CHANNEL'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'I'</span>, array=channels)
<span style="color: #a0522d;">col2</span> = fits.Column(name=<span style="color: #8b2252;">'COUNTS'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'E'</span>, array=time_lag)
<span style="color: #a0522d;">col3</span> = fits.Column(name=<span style="color: #8b2252;">'STAT_ERR'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'E'</span>, array=time_lag_err)
<span style="color: #a0522d;">col4</span> = fits.Column(name=<span style="color: #8b2252;">'GROUPING'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'I'</span>, array=zeros)

<span style="color: #a0522d;">spechdr</span> = fits.Header()
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'SYS_ERR'</span>] = 0
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'QUALITY'</span>] = 0
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'POISSERR'</span>] = <span style="color: #008b8b;">False</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'EXPOSURE'</span>] = 1.0
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'AREASCAL'</span>] = 1.0
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'BACKSCAL'</span>] = 1.0
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'EXTNAME'</span>] = <span style="color: #8b2252;">'SPECTRUM'</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'DETCHANS'</span>] = <span style="color: #483d8b;">len</span>(time_lag)
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'HDUCLASS'</span>] = <span style="color: #8b2252;">'OGIP'</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'HDUCLAS1'</span>] = <span style="color: #8b2252;">'SPECTRUM'</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'HDUVERS'</span>] = <span style="color: #8b2252;">'1.2.1'</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'BACKFILE'</span>] = <span style="color: #8b2252;">'none'</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'CORRFILE'</span>] = <span style="color: #8b2252;">'none'</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'RESPFILE'</span>] = output_file + <span style="color: #8b2252;">'.rsp'</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'ANCRFILE'</span>] = <span style="color: #8b2252;">'none'</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'CHANTYPE'</span>] = <span style="color: #8b2252;">'PI'</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'TELESCOP'</span>] = <span style="color: #8b2252;">'XMM-NEWTON'</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'INSTRUME'</span>] = <span style="color: #8b2252;">'EPIC-PN'</span>
<span style="color: #a0522d;">spechdr</span>[<span style="color: #8b2252;">'FILTER'</span>] = <span style="color: #8b2252;">'none'</span>

<span style="color: #a0522d;">cols</span> = fits.ColDefs([col1, col2, col3, col4])

<span style="color: #a0522d;">tbhdu</span> = fits.BinTableHDU.from_columns(cols, name=<span style="color: #8b2252;">'SPECTRUM'</span>, header=spechdr)

<span style="color: #a0522d;">prihdr</span> = fits.Header()
<span style="color: #a0522d;">prihdr</span>[<span style="color: #8b2252;">'HDUCLASS'</span>] = <span style="color: #8b2252;">'OGIP'</span>
<span style="color: #a0522d;">prihdr</span>[<span style="color: #8b2252;">'HDUCLAS1'</span>] = <span style="color: #8b2252;">'SPECTRUM'</span>
<span style="color: #a0522d;">prihdr</span>[<span style="color: #8b2252;">'HDUVERS'</span>] = <span style="color: #8b2252;">'1.2.1'</span>
<span style="color: #a0522d;">prihdu</span> = fits.PrimaryHDU(header=prihdr)

<span style="color: #a0522d;">thdulist</span> = fits.HDUList([prihdu, tbhdu])
thdulist.writeto(output_file + <span style="color: #8b2252;">'.fits'</span>)

<span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">"Created spectrum"</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">Create the "response"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">See http://heasarc.gsfc.nasa.gov/docs/heasarc/caldb/docs/memos/cal_gen_92_002/cal_gen_92_002.html</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Our response matrix will be diagonal</span>

<span style="color: #a0522d;">rsp_col1</span> = fits.Column(name=<span style="color: #8b2252;">'ENERG_LO'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'E'</span>, array=freq_low)
<span style="color: #a0522d;">rsp_col2</span> = fits.Column(name=<span style="color: #8b2252;">'ENERG_HI'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'E'</span>, array=freq_high)
<span style="color: #a0522d;">rsp_col3</span> = fits.Column(name=<span style="color: #8b2252;">'N_GRP'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'I'</span>, array=ones)
<span style="color: #a0522d;">rsp_col4</span> = fits.Column(name=<span style="color: #8b2252;">'F_CHAN'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'I'</span>, array=channels)
<span style="color: #a0522d;">rsp_col5</span> = fits.Column(name=<span style="color: #8b2252;">'N_CHAN'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'I'</span>, array=ones)
<span style="color: #a0522d;">rsp_col6</span> = fits.Column(name=<span style="color: #8b2252;">'MATRIX'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'E'</span>, array=ones)

<span style="color: #a0522d;">rspcols</span> = fits.ColDefs([rsp_col1, rsp_col2, rsp_col3, rsp_col4, rsp_col5, rsp_col6])

<span style="color: #a0522d;">rsphdr</span> = fits.Header()
<span style="color: #a0522d;">rsphdr</span>[<span style="color: #8b2252;">'EXTNAME'</span>] = <span style="color: #8b2252;">'MATRIX'</span>
<span style="color: #a0522d;">rsphdr</span>[<span style="color: #8b2252;">'TELESCOP'</span>] = <span style="color: #8b2252;">'XMM-NEWTON'</span>
<span style="color: #a0522d;">rsphdr</span>[<span style="color: #8b2252;">'INSTRUME'</span>] = <span style="color: #8b2252;">'EPIC-PN'</span>
<span style="color: #a0522d;">rsphdr</span>[<span style="color: #8b2252;">'FILTER'</span>] = <span style="color: #8b2252;">'none'</span>
<span style="color: #a0522d;">rsphdr</span>[<span style="color: #8b2252;">'CHANTYPE'</span>] = <span style="color: #8b2252;">'PI'</span>
<span style="color: #a0522d;">rsphdr</span>[<span style="color: #8b2252;">'DETCHANS'</span>] = <span style="color: #483d8b;">len</span>(time_lag)
<span style="color: #a0522d;">rsphdr</span>[<span style="color: #8b2252;">'HDUCLASS'</span>] = <span style="color: #8b2252;">'OGIP'</span>
<span style="color: #a0522d;">rsphdr</span>[<span style="color: #8b2252;">'HDUCLAS1'</span>] = <span style="color: #8b2252;">'RESPONSE'</span>
<span style="color: #a0522d;">rsphdr</span>[<span style="color: #8b2252;">'HDUCLAS2'</span>] = <span style="color: #8b2252;">'RSP_MATRIX'</span>
<span style="color: #a0522d;">rsphdr</span>[<span style="color: #8b2252;">'HDUCLAS3'</span>] = <span style="color: #8b2252;">'FULL'</span>
<span style="color: #a0522d;">rsphdr</span>[<span style="color: #8b2252;">'HDUVERS'</span>] = <span style="color: #8b2252;">'1.3.0'</span>

<span style="color: #a0522d;">rsphdu</span> = fits.BinTableHDU.from_columns(rspcols, name=<span style="color: #8b2252;">'MATRIX'</span>, header=rsphdr)

<span style="color: #a0522d;">ebin_col1</span> = fits.Column(name=<span style="color: #8b2252;">'CHANNEL'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'I'</span>, array=channels)
<span style="color: #a0522d;">ebin_col2</span> = fits.Column(name=<span style="color: #8b2252;">'E_MIN'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'E'</span>, array=freq_low)
<span style="color: #a0522d;">ebin_col3</span> = fits.Column(name=<span style="color: #8b2252;">'E_MAX'</span>, <span style="color: #483d8b;">format</span>=<span style="color: #8b2252;">'E'</span>, array=freq_high)

<span style="color: #a0522d;">ebin_cols</span> = fits.ColDefs([ebin_col1, ebin_col2, ebin_col3])

<span style="color: #a0522d;">ebin_hdr</span> = fits.Header()
<span style="color: #a0522d;">ebin_hdr</span>[<span style="color: #8b2252;">'EXTNAME'</span>] = <span style="color: #8b2252;">'EBOUNDS'</span>
<span style="color: #a0522d;">ebin_hdr</span>[<span style="color: #8b2252;">'TELESCOP'</span>] = <span style="color: #8b2252;">'XMM-NEWTON'</span>
<span style="color: #a0522d;">ebin_hdr</span>[<span style="color: #8b2252;">'INSTRUME'</span>] = <span style="color: #8b2252;">'EPIC-PN'</span>
<span style="color: #a0522d;">ebin_hdr</span>[<span style="color: #8b2252;">'FILTER'</span>] = <span style="color: #8b2252;">'none'</span>
<span style="color: #a0522d;">ebin_hdr</span>[<span style="color: #8b2252;">'CHANTYPE'</span>] = <span style="color: #8b2252;">'PI'</span>
<span style="color: #a0522d;">ebin_hdr</span>[<span style="color: #8b2252;">'DETCHANS'</span>] = <span style="color: #483d8b;">len</span>(time_lag)
<span style="color: #a0522d;">ebin_hdr</span>[<span style="color: #8b2252;">'HDUCLASS'</span>] = <span style="color: #8b2252;">'OGIP'</span>
<span style="color: #a0522d;">ebin_hdr</span>[<span style="color: #8b2252;">'HDUCLAS1'</span>] = <span style="color: #8b2252;">'RESPONSE'</span>
<span style="color: #a0522d;">ebin_hdr</span>[<span style="color: #8b2252;">'HDUCLAS2'</span>] = <span style="color: #8b2252;">'EBOUNDS'</span>
<span style="color: #a0522d;">ebin_hdr</span>[<span style="color: #8b2252;">'HDUVERS'</span>] = <span style="color: #8b2252;">'1.2.0'</span>

<span style="color: #a0522d;">ebin_hdu</span> = fits.BinTableHDU.from_columns(ebin_cols, name=<span style="color: #8b2252;">'EBOUNDS'</span>, header=ebin_hdr)

<span style="color: #a0522d;">rsp_prihdr</span> = fits.Header()
<span style="color: #a0522d;">rsp_prihdr</span>[<span style="color: #8b2252;">'HDUCLASS'</span>] = <span style="color: #8b2252;">'OGIP'</span>
<span style="color: #a0522d;">rsp_prihdr</span>[<span style="color: #8b2252;">'HDUCLAS1'</span>] = <span style="color: #8b2252;">'SPECTRUM'</span>
<span style="color: #a0522d;">rsp_prihdr</span>[<span style="color: #8b2252;">'HDUVERS'</span>] = <span style="color: #8b2252;">'1.2.1'</span>
<span style="color: #a0522d;">rsp_prihdu</span> = fits.PrimaryHDU(header=rsp_prihdr)

<span style="color: #a0522d;">rsp_thdulist</span> = fits.HDUList([rsp_prihdu, rsphdu, ebin_hdu])
rsp_thdulist.writeto(output_file + <span style="color: #8b2252;">'.rsp'</span>)

<span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">"Created response"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-6-5" class="outline-4">
<h4 id="sec-2-6-5"><span class="section-number-4">2.6.5</span> Script to setup the table</h4>
<div class="outline-text-4" id="text-2-6-5">
<pre class="example">
% Various bits of code to handle Poemwai's table model
% The model, internally, is in units of t_g.
% To fit the data, this needs to be scaled in frequency and normalisation.
% Updated 2017-02-16 to scale to higher frequencies appropriate for binaries (lower mass).

% Load the table model

add_atable_model("tlag2b-2016-11-16.fits", "tlag");

% Convolution model that scales the frequency bins and normalisation by mass
% The model is called "scale_lf" for mass scaling the lag-frequency model
% Parameter "norm" -- normalisation (/should/ always be 1 but can change if required)
% Parameter "log_mass" -- log_10 mass in units of Solar masses

define scale_lf_fit(lo, hi, par, fun_value)
{
        variable norm = par[0];
        variable mass = 10.0^par[1];
        variable shift_lo = @lo;
        variable shift_hi = @hi;
        
        variable t_g = 492.703806 * (mass / 1.0E8);
        
        shift_lo = shift_lo * t_g;
        shift_hi = shift_hi * t_g;
        
        variable spec = rebin(lo, hi, shift_lo, shift_hi, fun_value);
        spec = norm * spec;
        return(spec);
}

add_slang_function("scale_lf", ["norm", "mass"]);
set_function_category("scale_lf", ISIS_FUN_OPERATOR);



% Set up a user-defined grid
% This is important because when the convolution model shifts the spectrum up or down
% the model will need to be evaluated outside of the noticed range

define extender (id, s) {
        % The table model covers an "energy" range from 1E-5 --&gt; 7.76E-1
        % Binning is logarithmic
        % We want to evaluate the model over energy ranges from about 1E-6 --&gt; 1E-1
        % Updating for binaries we want to go up to a frequency ("energy") of 10 Hz.
        % 5,000 bins should be more than we'll ever need
        variable lam_lo = log10(_A(100.0));
        variable lam_hi = log10(_A(1.0E-6));
        (s.bin_lo, s.bin_hi) = linear_grid(lam_lo, lam_hi, 5000);
        s.bin_lo = 10.0^s.bin_lo;
        s.bin_hi = 10.0^s.bin_hi;
        return s;
}

define use_extended_grid() {
        set_eval_grid_method (USER_GRID, all_data(), &amp;extender);
}

% Load the data
%Ignore_PHA_Response_Keywords = 1; 
variable d = load_data("time_lags.fits");
variable r = load_rmf("time_lags.rsp");
assign_rmf(r, d);
use_extended_grid;

Label_By_Default = 0;

open_plot("020Combined2BlobsModelFit.gif/gif");
popt.xlabel="Frequency (Hz)";
popt.ylabel="Time lag (s)";
xlog;
ylog;
title("GX339-4 Combined 0204730201-0204730301 Two Blobs Model");
popt.yrange=[0.0000001, 1];
 %lag times
popt.xrange=[0.0009, 13]; %frequency

load_par("scale_tlag.par");
list_par;
() = eval_counts;
plot_data(1, popt);
_pgsci(1);
_pgsls(2);
_pgmove(-4, 0);
_pgdraw(-1, 0);

vmessage("Fitting is now running...");

set_fit_method("subplex");
fit;
() = eval_counts;
plot_data(1, popt);
_pgsci(1);
_pgsls(2);
_pgmove(-4, 0);
_pgdraw(-1, 0);
list_par;

close_plot;
</pre>
</div>
</div>

<div id="outline-container-sec-2-6-6" class="outline-4">
<h4 id="sec-2-6-6"><span class="section-number-4">2.6.6</span> Script with initial model parameters in (<code>scale_tlag.par</code>)</h4>
<div class="outline-text-4" id="text-2-6-6">
<pre class="example">
scale_lf(1,tlag)
 idx  param         tie-to  freeze         value         min         max
  1  tlag(1).norm       0     1                1           0       1e+10
  2  tlag(1).o          0     0         2.361868           2          10
  3  tlag(1).d          0     0         3.053948           3          20
  4  tlag(1).g          0     0         1.400001         1.4         3.2
  5  tlag(1).e          0     0        0.7675185         0.2           2
  6  tlag(1).w          0     0        0.9068604         0.5         1.5
  7  tlag(1).v          0     0         799.9999         200        2000
  8  tlag(1).s          0     0         88.86738           0         100
  9  tlag(1).redshift   0     1                0         -10          10
 10  scale_lf(1).norm   0     1                1           0           0
 11  scale_lf(1).mass   0     0            0.903       0.773           1
</pre>
</div>
</div>

<div id="outline-container-sec-2-6-7" class="outline-4">
<h4 id="sec-2-6-7"><span class="section-number-4">2.6.7</span> Scale values explained (<code>scale_tlag.par</code>)</h4>
<div class="outline-text-4" id="text-2-6-7">
<pre class="example">
 idx  param         tie-to  freeze         value         min         max
  1  tlag(1).norm       0     1                1           0       1e+10
  2  tlag(1).o          0     0         8.511871           2          10
  3  tlag(1).d          0     0         10.00001           3          20
  4  tlag(1).g          0     0              1.4         1.4         3.2
  5  tlag(1).e          0     0         1.690756         0.2           2
  6  tlag(1).w          0     0        0.6999998         0.5         1.5
  7  tlag(1).v          0     0             2000         200        2000
  8  tlag(1).s          0     0      3.47139e-06           0         100
  9  tlag(1).redshift   0     1                0         -10          10
 10  scale_lf(1).norm   0     1                1           0           0
 11  scale_lf(1).mass   0     0                1       0.773           1

Variable
1 - normalisation, should always be set to 1.
2 - height1 --&gt; 2, 3, 4, ..., 10 (n=9)
3 - height2 --&gt; 3, 4, 5, ..., 20  (n=18) height2 &gt; height1
4 - photon index2 --&gt; 1.4, 1.6, 1.8, ..., 3.2  (n=10)
5 - RRF1 --&gt; 0.2, 0.4, 0.6, ..., 2.0 (n=10)
6 - Q2 --&gt; 0.5, 0.7, ..., 1.5  (n=6) q2 &gt; q1 if g2 &gt; g1 and q2 &lt; q1 if g2 &lt;= g1
7 - t_max --&gt; 200, 800, 1400, 2000  (n=4)
8 - t_shift --&gt; 0, 5, 10, 30, 50, 100  (n=6)
9 - Redshift (fixed)
10 - another fixed normalisation?
11 - log10 of the mass

Poemwai has listed the variables and fixed values below:

model.h1: height1 --&gt; 2, 3, 4, ..., 10 (n=9)
h2: height2 --&gt; 3, 4, 5, ..., 20  (n=18) height2 &gt; height1
i: inclination --&gt; 30
g1: photon index1 --&gt; 2.0
g2: photon index2 --&gt; 1.4, 1.6, 1.8, ..., 3.2  (n=10)
x: ionization --&gt; 10
p: disc density index --&gt; 0
A: Fe abundance --&gt; 1
rs1: RRF1 --&gt; 0.2, 0.4, 0.6, ..., 2.0 (n=10)
rs2: RRF2 --&gt; RRF1/2.0
b: B2/B1 --&gt; 1.0
q1 --&gt; 1.0
q2 --&gt; 0.5, 0.7, ..., 1.5  (n=6) q2 &gt; q1 if g2 &gt; g1 and q2 &lt; q1 if g2 &lt;= g1
t_max --&gt; 200, 800, 1400, 2000  (n=4)
t_shift --&gt; 0, 5, 10, 30, 50, 100  (n=6)
</pre>
</div>
</div>
<div id="outline-container-sec-2-6-8" class="outline-4">
<h4 id="sec-2-6-8"><span class="section-number-4">2.6.8</span> Script to analyse coherence</h4>
<div class="outline-text-4" id="text-2-6-8">
<pre class="example">
%declare observation ID's
variable obs_id = ["0204730201,0204730301"];

%variable obs_id = ["0110890201_2-7k","0148010301_2-7k","0506200201_2-7k","0506200301_2-7k","0506200401_2-7k","0506200501_2-7k","0511580101_2-7k",
%	"0511580201_2-7k","0511580301_2-7k","0511580401_2-7k","0554710801_2-7k","0653510301_2-7k","0653510401_2-7k","0653510501_2-7k","0653510601_2-7k"];

variable obs_segs = [2,2];

variable i;
variable j;
variable k;
variable n;

% declare frequency bins
variable re_bin_f = 14; % with binninng
variable df_f = 1.0/1.5;
variable lo_bin_f = 1e-4;

%declare the number of frequency bins
variable n_bins = 100; % without binning

%declare arrays
variable lag = Double_Type[n_bins];
variable rb_n = Integer_Type[n_bins];
variable g_a_real = Double_Type[n_bins];
variable g_a_real_2 = Double_Type[n_bins];
variable g_a_imag = Double_Type[n_bins];
variable g_b = Double_Type[n_bins];
variable g_a = Double_Type[n_bins];
variable g_a_2 = Double_Type[n_bins];
variable g_c = Double_Type[n_bins];
variable g = Double_Type[n_bins];
variable coh = Double_Type[n_bins];
variable delta_phi = Double_Type[n_bins];
variable delta_lag = Double_Type[n_bins];
variable delta_coh = Double_Type[n_bins];

variable seg_length = 200000;
variable seg_min = 200000;

for(k=0; k&lt;length(obs_id); k++){
        for (n=1; n&lt;=obs_segs[k]; n++)
        {
                () = chdir("/data/cluster/XRayReverb2016/HarryData/GX339-4/" + obs_id[k] + sprintf("/seg%i", n));
                variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
                variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");
                variable ix_soft = where(not isnan(lc_soft.rate));
                variable ix_hard = where(not isnan(lc_hard.rate));

                if(length(ix_soft) &lt; seg_min)
                {
                        seg_length = length(ix_soft);
                }
                seg_min = seg_length;
                vmessage("check data: /data/scratch3/steff/1H0707-495/" + obs_id[k] + sprintf("/seg%i", n) + sprintf("  length= %i",  length(ix_soft)));
        }
}
vmessage("****set seg_length =%i", seg_length);

%loop through observarions
for(k=0; k&lt;length(obs_id); k++){
for (n=1; n&lt;=obs_segs[k]; n++){

() = chdir("/data/scratch3/steff/1H0707-495/" + obs_id[k] + sprintf("/seg%i", n));
%vmessage("Changed directory to /data/scratch3/steff/MCG-6-30-15/" + obs_id[k] + sprintf("/seg%i", n));

%Read data:
variable lc_soft = fits_read_table("PN_time_soft_lccorr.fits");
variable lc_hard = fits_read_table("PN_time_hard_lccorr.fits");

%exclude non-numbers:
variable ix_soft = where(not isnan(lc_soft.rate));
variable ix_hard = where(not isnan(lc_hard.rate));
variable rate_soft = Double_Type[seg_length];
variable rate_hard = Double_Type[seg_length];
variable time_soft = Double_Type[seg_length];
variable time_hard = Double_Type[seg_length];
variable error_soft = Double_Type[seg_length];
variable error_hard = Double_Type[seg_length];

%Pass to new variables:
variable o_time_soft = lc_soft.time[ix_soft];
variable o_time_hard = lc_hard.time[ix_hard];
variable o_rate_soft = lc_soft.rate[ix_soft];
variable o_rate_hard = lc_hard.rate[ix_hard];
variable o_error_soft = lc_soft.error[ix_soft];
variable o_error_hard = lc_hard.error[ix_hard];

for(j=0; j&lt;seg_length; j++)
{
        rate_soft[j] = o_rate_soft[j];
        rate_hard[j] = o_rate_hard[j];
        time_soft[j] = o_time_soft[j];
        time_hard[j] = o_time_hard[j];
        error_soft[j] = o_error_soft[j];
        error_hard[j] = o_error_hard[j];


}

% Compute soft dft:
variable dft_soft = fft(rate_soft,-1);
variable freq = [[1:length(dft_soft)]]/(double(length(dft_soft))*(time_soft[1]-time_soft[0]));
variable dft_real_soft = Real(dft_soft[[0:length(freq)-1]]);
variable dft_imag_soft = Imag(dft_soft[[0:length(freq)-1]]);

% Compute hard dft:
variable dft_hard = fft(rate_hard,-1);

variable dft_real_hard = Real(dft_hard[[0:length(freq)-1]]);
variable dft_imag_hard = Imag(dft_hard[[0:length(freq)-1]]);

% Adjust frequency bins
variable x = Double_Type[n_bins];
variable dxp = Double_Type[n_bins];
variable dxm = Double_Type[n_bins];
for(i=1;i&lt;n_bins;i++)
{
        x[i] = freq[i];
        dxp[i] = (freq[i+1] - x[i])/2;
        dxm[i] = (x[i] - freq[i-1])/2;
}

variable lo = Double_Type[re_bin_f];
variable hi = Double_Type[re_bin_f];
lo[0]=lo_bin_f;
hi[0]=(lo[0] + lo[0]*df_f);
for(i=1;i&lt;re_bin_f;i++){
    lo[i]=hi[i-1];
    hi[i]=lo[i]+lo[i]*df_f;
}
variable rb_freq = 10^(0.5*(log10(lo)+log10(hi)));
variable x_bin = (hi+lo)/2;
variable dxp_bin = hi-x_bin;
variable dxm_bin = x_bin-lo;

%Calculate and sum CPS for each frequency bin in each observation.
for(j=0; j&lt; n_bins; j++)
{
                        %() = printf("j= %i freq= %e\n", j, freq[j]);
                        g_a_real[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_real_2[j] += (dft_real_soft[j]*dft_real_hard[j] + dft_imag_soft[j]*dft_imag_hard[j]);
                        g_a_imag[j] += dft_imag_soft[j]*dft_real_hard[j] - dft_real_soft[j]*dft_imag_hard[j];
                        g_b[j] += dft_real_soft[j]*dft_real_soft[j] + dft_imag_soft[j]*dft_imag_soft[j];	% Periodrogram s
                        g_c[j] += dft_real_hard[j]*dft_real_hard[j] + dft_imag_hard[j]*dft_imag_hard[j];	% Periodrogram h
                        rb_n[j] ++;
                
}
}
}

%Plot variables including frequency error bars
for(j=0; j&lt; n_bins; j++)
{
        g_a_real[j] = g_a_real[j]/rb_n[j];
        g_a_real_2[j] = g_a_real_2[j] /rb_n[j];
        g_a_imag[j] = g_a_imag[j]/rb_n[j];
        g_a[j] = (g_a_real[j]*g_a_real[j] + g_a_imag[j]*g_a_imag[j]);
        g_a_2[j] = (g_a_real_2[j]*g_a_real_2[j] + g_a_imag[j]*g_a_imag[j]);
        g_b[j] = g_b[j]/rb_n[j];
        g_c[j] = g_c[j]/rb_n[j];
        g[j] = g_a[j]/(g_b[j]*g_c[j]);
        coh[j] = g_a_2[j]/(g_b[j]*g_c[j]);
        delta_phi[j] = sqrt((1.0-g[j])/(2.0*g[j]))/sqrt(double(rb_n[j]));	
        delta_lag[j] = delta_phi[j]/(2.0*PI*freq[j]);
        delta_coh[j] = 0.0; 

        lag[j] = atan2(g_a_imag[j] , g_a_real[j])/(2.0*PI*freq[j]);
}


variable fb_n = Integer_Type[re_bin_f];
variable n_est = Integer_Type[re_bin_f];

variable lag_bin = Double_Type[re_bin_f];
variable g_a_real_bin = Double_Type[re_bin_f];
variable g_a_real_2_bin = Double_Type[re_bin_f];
variable g_a_imag_bin = Double_Type[re_bin_f];
variable g_a_bin = Double_Type[re_bin_f];
variable g_a_2_bin = Double_Type[re_bin_f];
variable g_b_bin = Double_Type[re_bin_f];
variable g_c_bin = Double_Type[re_bin_f];
variable g_bin = Double_Type[re_bin_f];
variable delta_phi_bin = Double_Type[re_bin_f];
variable delta_lag_bin = Double_Type[re_bin_f];
variable delta_coh_bin = Double_Type[re_bin_f];

for(i=0; i&lt; re_bin_f; i++)
{

        for (j=0; j&lt;n_bins; j++)
        {
                if(freq[j] &gt; lo[i] &amp;&amp; freq[j] &lt;= hi[i])
                {


                        g_a_real_bin[i] += g_a_real[j];
                        g_a_real_2_bin[i] += g_a_real_2[j];
                        g_a_imag_bin[i] += g_a_imag[j];
                        g_b_bin[i] += g_b[j];
                        g_c_bin[i] += g_c[j];
                        fb_n[i]++;
                        n_est[i] += rb_n[j];

                }
        }
}

%Average CPS in each frequency bin for all observations. Calculate coherence, g[i], for each frequency bin.
for(i=0; i&lt;re_bin_f; i++)
{
        %Lag error
        g_a_real_bin[i] /= fb_n[i];
        g_a_imag_bin[i] /= fb_n[i];
        g_a_bin[i] = (g_a_real_bin[i]*g_a_real_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_a_2_bin[i] = (g_a_real_2_bin[i]*g_a_real_2_bin[i] + g_a_imag_bin[i]*g_a_imag_bin[i]);
        g_b_bin[i] /= double(fb_n[i]);
        g_c_bin[i] /= double(fb_n[i]);
        g_bin[i] = g_a_bin[i]/(g_b_bin[i]*g_c_bin[i]);
        delta_phi_bin[i] = sqrt((1.0-g_bin[i])/(2.0*g_bin[i]))/sqrt(double(n_est[i]));	
        delta_lag_bin[i] = delta_phi_bin[i]/(2.0*PI*rb_freq[i]);
        lag_bin[i] = atan2(g_a_imag_bin[i] , g_a_real_bin[i])/(2.0*PI*rb_freq[i]);
}

% Plot results:
window(1);
xlog;
ylin;
xlabel("Frequency (Hz)");
ylabel("Time Lag (s)");
%ylabel("Coherence");
title("1H0707-495 Lag Frequency 0.3-0.8 and 1-4 keV (without binning)");
%title("1H0707-495 Lag Frequency 2-4 and 5-7keV (without binning)");
%title("1H0707-495 0.3-0.8keV and 1-4keV Coherence");
%title("1H0707-495 Combined 2-4 and 5-7keV Coherence");
connect_points(0);
_pgsfs(3);21743

%plotxy(x,dxm,dxp,coh,delta_coh,delta_coh; dcol=1, decol=4, dsym=6, xrange=[2.5e-5,1e-2],yrange=[0.001,2]);	% coherence
plotxy(x,dxm,dxp,lag,delta_lag,delta_lag; dcol=1, decol=4, dsym=6, xrange=[5e-5,1e-2],yrange=[-300,300]);	% lags without binning
%plotxy(x_bin,dxm_bin,dxp_bin,lag_bin,delta_lag_bin,delta_lag_bin; dcol=1, decol=4, dsym=6,  xrange=[5e-5,1e-2], yrange=[-100,200]);	% binned f lags
_pgmove(-1000,0);
_pgsls(2);
_pgslw(1);
_pgdraw(1,0);

% Vertical max freq line
_pgmove(-2.721,-1400); % 0.3-4k
%_pgmove(-3.284,-600); % 2-7k
_pgsls(2);
_pgsci(2);
_pgslw(4);
_pgdraw(-2.721,1400); % 0.3-4k
%_pgdraw(-3.284,600); % 2-7k

%Coherence value (horzontal) line
%_pgmove(-10000,-0.1);
%_pgsls(4);
%_pgslw(3);
%_pgdraw(1, -0.998);

%close_plot;
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Harry Birch (MSci proj 2016)</p>
<p class="date">Created: 2017-02-23 Thu 10:15</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.1.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
